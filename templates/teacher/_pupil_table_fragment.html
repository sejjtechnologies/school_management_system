{% if pupils %}
  <div class="table-responsive" style="overflow-x:auto; white-space:nowrap;">
    <table class="table table-striped table-bordered align-middle" id="pupilTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Pupil Name</th>
          <th>Class</th>
          <th>Stream</th>
          <th class="text-center">Combined Avg</th>
          <th class="text-center">Grade</th>
          <th class="text-center">Remark</th>
          <th class="text-center">Stream Pos</th>
          <th class="text-center">Class Pos</th>
        </tr>
      </thead>
      <tbody>
        {% for pupil in pupils %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>
              <a href="{{ url_for('teacher_manage_reports.view_pupil_report', pupil_id=pupil.id) }}">
                {{ pupil.first_name }} {{ pupil.last_name }}
              </a>
            </td>
            <td>
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('teacher_manage_reports.prepare_print', pupil_id=pupil.id) }}?year={{ selected_year }}&term={{ selected_term or 'all' }}&types={{ selected_types }}" target="_blank">Print</a>
            </td>
            <td>{{ pupil.class_name }}</td>
            <td>{{ pupil.stream_name }}</td>
            {% set cs = None %}
            {% if combined_stats is defined %}
              {% set cs_raw = combined_stats.get(pupil.id) %}
              {% if cs_raw %}
                {% if 'combined_average' in cs_raw %}
                  {% set cs = cs_raw %}
                {% else %}
                  {% set _vals = cs_raw.values()|list %}
                  {% if _vals %}
                    {% set cs = _vals[0] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endif %}
            {% set rep = report_map.get(pupil.id) if report_map is defined else None %}

            <td class="text-center">
              {% if cs and ('combined_average' in cs) %}
                {{ cs['combined_average'] }}
              {% elif rep and (rep.combined_average is not none) %}
                {{ rep.combined_average }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              {% if cs and ('combined_grade' in cs) %}
                {{ cs['combined_grade'] }}
              {% elif rep and (rep.combined_grade is not none) %}
                {{ rep.combined_grade }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              {% if cs and ('general_remark' in cs) %}
                {{ cs['general_remark'] }}
              {% elif rep and (rep.general_remark is not none) %}
                {{ rep.general_remark }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              {% if cs and ('stream_combined_position' in cs) %}
                {{ cs['stream_combined_position'] }} of {{ students_per_stream.get(pupil.stream_id, '-') if students_per_stream is defined else '-' }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              {% if cs and ('class_combined_position' in cs) %}
                {{ cs['class_combined_position'] }} of {{ students_per_class.get(pupil.class_id, '-') if students_per_class is defined else '-' }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Pagination -->
  <nav aria-label="Pupil list pagination" class="mt-3">
    <ul class="pagination" id="pupilPagination" data-per-page="{{ per_page|default(50) }}" data-year="{{ selected_year }}" data-term="{{ selected_term or 'all' }}" data-types="{{ selected_types }}">
      {% set _p = page if page is defined else 1 %}
      {% set _tp = total_pages if total_pages is defined else 1 %}
      <li class="page-item {% if _p == 1 %}disabled{% endif %}">
        <a class="page-link" href="?page={{ _p-1 }}&per_page={{ per_page }}&year={{ selected_year }}&term={{ selected_term or 'all' }}&types={{ selected_types }}" data-page="{{ _p-1 }}">Previous</a>
      </li>
      {% for i in range(1, _tp+1) %}
      <li class="page-item {% if i == _p %}active{% endif %}"><a class="page-link" href="?page={{ i }}&per_page={{ per_page }}&year={{ selected_year }}&term={{ selected_term or 'all' }}&types={{ selected_types }}" data-page="{{ i }}">{{ i }}</a></li>
      {% endfor %}
      <li class="page-item {% if _p == _tp %}disabled{% endif %}">
        <a class="page-link" href="?page={{ _p+1 }}&per_page={{ per_page }}&year={{ selected_year }}&term={{ selected_term or 'all' }}&types={{ selected_types }}" data-page="{{ _p+1 }}">Next</a>
      </li>
    </ul>
  </nav>
{% else %}
  <p class="text-muted">No pupils assigned to you yet.</p>
{% endif %}
