<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Timetable - {{ class_name }} {{ stream_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding-top: 64px; font-family: 'Segoe UI', sans-serif; background: #f7f7f7; }
    .navbar { background: #283593; height: 56px; }
    .navbar .navbar-brand, .navbar .nav-link { color: #fff; }
    /* Reduce brand size and ensure it truncates on small screens so controls stay visible */
    .navbar .container-fluid { position: relative; }
    .navbar .navbar-brand { font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 140px); display: inline-block; vertical-align: middle; }
    .navbar .navbar-brand .bi { font-size: 1rem; margin-right: 6px; }
    /* Make the action buttons compact and lock them to the right on small screens */
    .ms-auto { display: flex; gap: 0.35rem; align-items: center; flex-shrink: 0; }
    .ms-auto .btn { padding: 0.25rem 0.5rem; font-size: 0.85rem; height: 34px; line-height: 1; }
    .page-title { padding: 18px 16px; color: #283593; font-weight: 700; }
    .timetable-container { background: #fff; border-radius: 8px; padding: 12px; margin: 12px; overflow: hidden; }
    /* Desktop-friendly grid: time column + 6 day columns */
    .timetable-grid { display: grid; grid-template-columns: 90px repeat(6, 1fr); gap: 2px; background: #ddd; padding: 2px; min-width: 100%; }
    .grid-header { background-color: #4a148c; color: #fff; font-weight: bold; padding: 8px; text-align: center; font-size: 0.9rem; }
    .grid-time { background-color: #7b1fa2; color: #b71c1c; font-weight: bold; padding: 8px; text-align: center; font-size: 0.9rem; }
    /* Special styling for break and lunch rows */
    .grid-time.break-time { background-color: #fff9c4 !important; color: #f57f17 !important; font-weight: 800; }
    .grid-time.lunch-time { background-color: #ffecb3 !important; color: #e65100 !important; font-weight: 800; }
    .grid-cell.break-cell { background-color: #fffde7 !important; color: #6d4c41; text-align: center; font-weight: 700; }
    .grid-cell.lunch-cell { background-color: #fff3e0 !important; color: #bf360c; text-align: center; font-weight: 700; }
    .grid-cell { background: #f5f5f5; padding: 6px; min-height: 70px; display: flex; flex-direction: column; justify-content: center; font-size: 0.85rem; }
    .grid-cell.occupied { background-color: #c8e6c9; border: 2px solid #388e3c; }
    .slot-subject { font-weight: bold; color: #1b5e20; }
    .slot-teacher { font-size: 0.85rem; color: #424242; margin-top: 6px; }
    /* Highlight the logged-in teacher's name in the timetable */
    .slot-teacher.current-teacher { color: #d32f2f; font-weight: 700; }
    /* Mobile adjustments: tighter cells, allow horizontal scrolling if needed */
    @media (max-width: 768px) {
      .timetable-container { padding: 8px; margin: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      /* Keep columns readable but allow the grid to be wider than the viewport */
      .timetable-grid { grid-template-columns: 60px repeat(6, minmax(90px, 1fr)); min-width: 520px; }
      .grid-header { padding: 6px; font-size: 0.8rem; }
      .grid-time { padding: 6px; font-size: 0.8rem; }
      .grid-cell { min-height: 60px; padding: 6px; font-size: 0.8rem; }
      /* Reduce gap and borders to save space */
      .timetable-grid { gap: 1px; }
      /* On small screens pin the action buttons to the right side of the navbar */
      .ms-auto { position: absolute; right: 8px; top: 8px; }
      .navbar .navbar-brand { max-width: calc(100% - 110px); font-size: 0.95rem; }
      .ms-auto .btn { padding: 0.2rem 0.45rem; font-size: 0.78rem; height: 30px; }
    }

    /* Print styles: show only the timetable grid and make it fit nicely on paper */
    @media print {
      @page { size: A4 landscape; margin: 4mm; }
      html, body { background: #fff; color: #000; }
      /* show print-header, hide non-essential UI */
      .print-header { display: block !important; position: fixed; top: 0; left: 0; right: 0; background: #fff; z-index: 9999; }
      nav.navbar, .ms-auto, .page-title, footer, .no-selection { display: none !important; }
      main.main-scroll { margin: 0; padding: 0; }

      /* print header styling */
      .print-header { position: static !important; display: block !important; }
      .print-school { font-weight: 900; font-size: 22pt; color: #2b3e94; }
      .print-motto { font-style: italic; font-size: 12pt; color: #6a1b9a; margin-top: 2px; }
      .print-teacher { font-size: 11pt; color: #1b5e20; margin-top: 4px; }

      /* Force timetable to fit the printable width, avoid horizontal overflow */
      html, body { margin: 0; padding: 0; }
      .timetable-container { box-shadow: none; border-radius: 0; padding: 1mm; margin: 0; width: 100% !important; overflow: visible !important; }
      .timetable-grid { gap: 1px; background: #bbb; width: 100% !important; min-width: 0 !important; grid-template-columns: 70px repeat(6, 1fr) !important; }
      .grid-header, .grid-time, .grid-cell { page-break-inside: avoid; break-inside: avoid; }
      /* slightly smaller font for print to help fit on a single page */
      .grid-header, .grid-time { font-size: 7.5pt !important; padding: 4px !important; }
      /* Ensure time column prints in strong red */
      .grid-time { color: #b71c1c !important; }
      .grid-cell { font-size: 6.5pt !important; padding: 1px !important; min-height: 20px !important; }
      /* ensure header area doesn't overlap content and keep header on same page */
      .print-header { page-break-after: avoid; }
      .timetable-container { margin-top: 6mm !important; }
      .timetable-grid { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-lg">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="{{ url_for('teacher_routes.dashboard') }}">
        <i class="bi bi-table me-2"></i>Timetable ‚Äî {{ class_name }} {{ stream_name }}
      </a>
      <div class="ms-auto">
        <button type="button" class="btn btn-outline-light btn-sm me-2" id="printBtn" title="Print timetable">
          <i class="bi bi-printer-fill"></i> Print
        </button>
        <a href="{{ url_for('teacher_routes.dashboard') }}" class="btn btn-light btn-sm" style="margin-right:8px;">
          <i class="bi bi-box-arrow-right me-1" style="color: #d32f2f; font-size:0.95rem;"></i> Back
        </a>
      </div>
    </div>
  </nav>

    <!-- Tip removed at user's request: no on-screen print-tip notification -->

  <!-- Print header (hidden on screen, shown on print). Will repeat on each printed page in most browsers. -->
  <div class="print-header" aria-hidden="true" style="display:none;">
    <div class="container text-center">
      <div class="print-school">Hope Full Future P/s</div>
      <div class="print-motto">Naturing Minds, Shaping Future</div>
      <div class="print-teacher" style="margin-top:6px;">
        {% if teacher is defined and teacher %}
          <span style="font-weight:700; color:#2e7d32;">{{ teacher.first_name }} {{ teacher.last_name }}</span>
          &nbsp;‚Äî&nbsp;
        {% endif %}
        <span id="printClassStream">{{ class_name }} ‚Äî {{ stream_name }}</span>
        &nbsp;|&nbsp; Date: <span id="printDate"></span>
      </div>
      <hr style="border:none; border-top:1px solid #444; margin:8px 0 6px 0;" />
    </div>
  </div>

  <main class="main-scroll">
    <h4 class="page-title">{{ class_name }} ‚Äî {{ stream_name }}</h4>
    <div class="timetable-container" id="timetableContainer" data-class-id="{{ class_id }}" data-stream-id="{{ stream_id }}" data-current-teacher-id="{{ teacher.id if (teacher is defined and teacher) else '' }}">
      <div class="no-selection"><i class="bi bi-info-circle"></i> Loading timetable‚Ä¶</div>
    </div>
  </main>

  {% include 'footer.html' %}

  <script>
    // Minimal JS copied/adapted from admin manage page but with read-only behavior
    function convertTo12Hour(time24h) {
      const [hours, minutes] = time24h.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
    }

    function generateTimeSlots() {
      const slots = [];
      let current = new Date();
      current.setHours(8, 0, 0, 0);
      const endTime = new Date();
      endTime.setHours(17, 0, 0, 0);
      while (current < endTime) {
        const hours = String(current.getHours()).padStart(2, '0');
        const minutes = String(current.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        if (timeStr === '10:00') {
          slots.push({ time: timeStr, type: 'break', label: '‚òï 20 MIN BREAK' });
          current.setMinutes(current.getMinutes() + 20);
        } else if (timeStr === '13:00') {
          slots.push({ time: timeStr, type: 'lunch', label: 'üçΩÔ∏è 40 MIN LUNCH' });
          current.setMinutes(current.getMinutes() + 40);
        } else {
          const remainingMinutes = (endTime - current) / (1000 * 60);
          const lessonDuration = remainingMinutes <= 40 ? Math.ceil(remainingMinutes) : 40;
          slots.push({ time: timeStr, type: 'lesson', duration: lessonDuration });
          current.setMinutes(current.getMinutes() + lessonDuration);
        }
      }
      return slots;
    }

    async function loadAndRender() {
      try {
        const containerEl = document.getElementById('timetableContainer');
        const classId = parseInt(containerEl && containerEl.dataset && containerEl.dataset.classId, 10);
        const streamId = parseInt(containerEl && containerEl.dataset && containerEl.dataset.streamId, 10);
        const currentTeacherId = parseInt(containerEl && containerEl.dataset && containerEl.dataset.currentTeacherId, 10) || null;
        const resp = await fetch(`/admin/timetable/get/${classId}/${streamId}`);
        const data = await resp.json();
        const currentSlots = data.slots || [];
        renderTimetable(currentSlots, currentTeacherId);
      } catch (e) {
        document.getElementById('timetableContainer').innerHTML = '<div class="no-selection">Error loading timetable</div>';
        console.error(e);
      }
    }

    function renderTimetable(currentSlots, currentTeacherId) {
      const container = document.getElementById('timetableContainer');
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const times = generateTimeSlots();
      let html = '<div class="timetable-grid">';
      html += '<div class="grid-header"></div>';
      days.forEach(day => html += `<div class="grid-header">${day}</div>`);
      times.forEach(timeObj => {
        const time = timeObj.time;
        const timeType = timeObj.type;
        if (timeType === 'break') {
          html += `<div class="grid-time break-time">‚òï BREAK</div>`;
        } else if (timeType === 'lunch') {
          html += `<div class="grid-time lunch-time">üçΩÔ∏è LUNCH</div>`;
        } else {
          html += `<div class="grid-time">${convertTo12Hour(time)}</div>`;
        }

        days.forEach(day => {
          if (timeType === 'break' || timeType === 'lunch') {
            const cellClass = timeType === 'break' ? 'grid-cell break-cell' : 'grid-cell lunch-cell';
            html += `<div class="${cellClass}">${timeObj.label}</div>`;
          } else {
            const slots = currentSlots.filter(s => s.day_of_week === day && s.start_time === time);
            if (slots.length > 0) {
              html += '<div class="grid-cell occupied">';
              slots.forEach((slot, idx) => {
                // determine if this slot's teacher matches the logged-in teacher
                const tId = slot.teacher_id ? parseInt(slot.teacher_id, 10) : null;
                const isCurrent = currentTeacherId && tId && currentTeacherId === tId;
                const teacherClass = isCurrent ? 'slot-teacher current-teacher' : 'slot-teacher';
                html += `\n  <div style="margin-bottom: ${idx < slots.length - 1 ? '8px' : '0'}; padding-bottom: ${idx < slots.length - 1 ? '8px' : '0'}; border-bottom: ${idx < slots.length - 1 ? '1px solid #b0bec5' : 'none'};">\n    <div class="slot-subject">${slot.subject_name}</div>\n    <div class="${teacherClass}">${slot.teacher_name}</div>\n  </div>`;
              });
              html += '</div>';
            } else {
              html += '<div class="grid-cell"><small style="color: #999">‚Äî</small></div>';
            }
          }
        });
      });
      html += '</div>';
      container.innerHTML = html;
      computeTimetableHeight();
    }

    function computeTimetableHeight() {
      try {
        const container = document.getElementById('timetableContainer');
        const navbar = document.querySelector('.navbar');
        const control = null; // no control panel here
        const footer = document.querySelector('footer');
        const navH = navbar ? navbar.getBoundingClientRect().height : 0;
        const controlH = 0;
        const footerH = footer ? footer.getBoundingClientRect().height : 0;
        const extraGap = 20;
        const viewportH = window.innerHeight;
        let available = viewportH - navH - controlH - footerH - extraGap;
        if (available < 200) available = 200;
        container.style.maxHeight = available + 'px';
        container.style.overflowY = 'auto';
        container.style.webkitOverflowScrolling = 'touch';
      } catch (e) { console.error(e); }
    }

    window.addEventListener('load', function(){ loadAndRender(); computeTimetableHeight(); });
    window.addEventListener('resize', function(){ setTimeout(computeTimetableHeight, 120); });

    // Try to scale the timetable grid to fit on a single printed page when printing
    function adjustTimetableForPrint() {
      try {
        const container = document.getElementById('timetableContainer');
        if (!container) return;
        const grid = container.querySelector('.timetable-grid');
        if (!grid) return;
        const headerEl = document.querySelector('.print-header');
        const headerH = headerEl ? headerEl.getBoundingClientRect().height : 60;
        // measure grid dimensions
        const gridW = grid.scrollWidth || grid.offsetWidth;
        const gridH = grid.scrollHeight || grid.offsetHeight;
        // approximate printable area in px (A4 landscape at typical screen dpi)
        const printableW = Math.min(window.innerWidth, 1120) - 20; // small safety margin
        const printableH = Math.min(window.innerHeight, 768) - headerH - 20;
        let scaleW = printableW / gridW;
        let scaleH = printableH / gridH;
        let scale = Math.min(scaleW, scaleH, 1);
        if (scale < 0.45) scale = 0.45; // clamp to avoid unreadable text

        // compute vertical centering translation so grid sits nicely below header
        const scaledGridH = gridH * scale;
        let topOffset = headerH + Math.max(4, (printableH - scaledGridH) / 2);

        // apply transform: translateY then scale
        grid.style.transformOrigin = 'top left';
        grid.style.transform = `translate(0px, ${topOffset}px) scale(${scale})`;
        grid.dataset._printScale = scale;
        grid.dataset._printTranslate = topOffset;
      } catch (e) { console.error('adjustTimetableForPrint', e); }
    }

    function restoreTimetableAfterPrint() {
      try {
        const grid = document.querySelector('.timetable-grid');
        if (!grid) return;
        grid.style.transform = '';
        delete grid.dataset._printScale;
        delete grid.dataset._printTranslate;
      } catch (e) { /* ignore */ }
    }

    if (window.matchMedia) {
      try {
        window.addEventListener('beforeprint', function(){ adjustTimetableForPrint(); const pd = document.getElementById('printDate'); if (pd) pd.textContent = new Date().toLocaleDateString(); });
        window.addEventListener('afterprint', function(){ restoreTimetableAfterPrint(); });
      } catch (e) { /* ignore for older browsers */ }
    }

    // Wire print button: call window.print() after a short delay
    document.addEventListener('DOMContentLoaded', function(){
      const pb = document.getElementById('printBtn');
      const pd = document.getElementById('printDate');
      if (pd) pd.textContent = new Date().toLocaleDateString();
      if (pb) pb.addEventListener('click', function(){
        // update date right before printing
        if (pd) pd.textContent = new Date().toLocaleDateString();
        setTimeout(() => window.print(), 80);
      });

      // Also respond to native beforeprint event
      if (window.matchMedia) {
        try {
          window.addEventListener('beforeprint', function(){ if (pd) pd.textContent = new Date().toLocaleDateString(); });
        } catch(e) { /* ignore */ }
      }

      // Observe footer size changes and recompute timetable height when footer resizes
      const footer = document.querySelector('footer');
      if (footer && window.ResizeObserver) {
        try {
          const ro = new ResizeObserver(function(){ computeTimetableHeight(); });
          ro.observe(footer);
        } catch(e) { /* ignore */ }
      }
    });
  </script>
</body>
</html>
