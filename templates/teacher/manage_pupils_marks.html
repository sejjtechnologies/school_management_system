<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Pupils Marks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root { --bs-body-font-size: 0.95rem; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      background-color: #f9f9f9;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
    }

    /* Fixed Navbar */
    .navbar {
      background-color: #dc3545;
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .navbar-brand {
      color: white !important;
      font-weight: bold;
      font-size: 0.95rem;
      margin: 0;
    }
    .nav-btn-top {
      background-color: white;
      color: #dc3545;
      font-size: 0.75rem;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }
    .nav-btn-top:hover {
      background-color: #f5f5f5;
      color: #dc3545;
    }
    .nav-btn-top i {
      font-size: 0.8rem;
      color: #dc3545;
    }

    /* Footer */
    footer {
      min-height: 60px;
      background: white;
      border-top: 1px solid #e9ecef;
      flex-shrink: 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    /* Main scrollable section */
    main {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 12px;
      padding-bottom: calc(80px + 20px);
      margin-top: 60px;
      margin-bottom: 60px;
      -webkit-overflow-scrolling: touch;
    }
    main::-webkit-scrollbar {
      width: 6px;
    }
    main::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    main::-webkit-scrollbar-thumb {
      background: #dc3545;
      border-radius: 3px;
    }

    .form-section {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .form-label {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .submit-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .submit-btn:hover:not(:disabled) {
      background-color: #218838;
    }
    .submit-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .submit-btn.saving {
      background-color: #ffc107;
      color: #000;
    }
    .submit-btn.success {
      background-color: #28a745;
    }
    .submit-btn.error {
      background-color: #dc3545;
    }

    @media (max-width: 576px) {
      .navbar { padding: 0 10px; }
      .navbar-brand { font-size: 0.85rem; }
      .nav-btn-top { padding: 3px 6px; font-size: 0.65rem; }
      .form-label { font-size: 0.85rem; }
      .form-section { padding: 12px; margin-bottom: 15px; }
      main { padding: 20px 12px; padding-bottom: calc(80px + 20px); margin-top: 60px; margin-bottom: 60px; }
    }
  </style>
</head>
<body>
  <!-- Fixed Navbar -->
  <nav class="navbar">
    <span class="navbar-brand" style="display:flex; align-items:center; gap:8px;">
      <img src="/static/logo.png" alt="Logo" style="height:32px; width:auto;"> Marks
    </span>
    <a href="{{ url_for('teacher_routes.dashboard') }}" class="nav-btn-top">
      <i class="bi bi-box-arrow-left"></i> Back
    </a>
  </nav>

  <!-- Main Content -->
  <main>
    <div class="form-section">
      <!-- Success Alert -->
      <div id="successAlert" class="alert alert-success d-none alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>Success!</strong> <span id="successMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <!-- Error Alert -->
      <div id="errorAlert" class="alert alert-danger d-none alert-dismissible fade show" role="alert">
        <i class="bi bi-x-circle-fill me-2"></i>
        <strong>Error!</strong> <span id="errorMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <!-- Server-side flashed messages (for non-AJAX flows) -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else ( 'success' if category == 'success' else category ) }} alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="marksForm" method="POST" action="{{ url_for('teacher_routes.manage_marks') }}">

        <!-- Select Pupil -->
        <div class="mb-3">
          <label for="pupil_id" class="form-label">Select Pupil</label>
          <select class="form-select" id="pupil_id" name="pupil_id" required onchange="updatePupilInfo(this)">
            <option value="">-- Select Pupil --</option>
            {% for pupil in pupils %}
              <option value="{{ pupil.id }}"
                      data-class="{{ pupil.class_.name }}"
                      data-stream="{{ pupil.stream.name if pupil.stream else 'N/A' }}">
                {{ pupil.first_name }} {{ pupil.last_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Auto-filled Class and Stream -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="class_name" class="form-label">Class</label>
            <input type="text" id="class_name" class="form-control" readonly placeholder="Class will be filled automatically">
          </div>
          <div class="col-md-6">
            <label for="stream_name" class="form-label">Stream</label>
            <input type="text" id="stream_name" class="form-control" readonly placeholder="Stream will be filled automatically">
          </div>
        </div>

        <!-- Select Term -->
        <div class="mb-3">
          <label for="term" class="form-label">Select Term</label>
          <select class="form-select" id="term" name="term" required>
            {% for t in terms %}
              <option value="{{ t }}">Term {{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Select Year -->
        <div class="mb-3">
          <label for="year" class="form-label">Select Year</label>
          <select class="form-select" id="year" name="year" required>
            {% for y in years %}
              <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Select Exam Type -->
        <div class="mb-3">
          <label for="exam_name" class="form-label">Select Exam</label>
          <select class="form-select" id="exam_name" name="exam_name" required>
            {% for et in exam_types %}
              <option value="{{ et }}">{{ et }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Enter Marks for Subjects -->
        <h5 class="mt-4 mb-3">Enter Marks (out of 100)</h5>
        {% for subject in subjects %}
          <div class="mb-3">
            <label for="score_{{ subject.id }}" class="form-label">{{ subject.name }}</label>
            <input type="number" class="form-control" id="score_{{ subject.id }}"
                   name="score_{{ subject.id }}" min="0" max="100" required placeholder="0 - 100">
          </div>
        {% endfor %}

        <!-- Submit Button -->
        <button type="submit" class="submit-btn">Save Marks</button>
      </form>
    </div>
  </main>

  {% include 'footer.html' %}

  <!-- Script to auto-fill class and stream -->
  <script>
    // savedExams will be fetched from server for the selected pupil/year/term
    let savedExams = [];

    function updatePupilInfo(select) {
      const selectedOption = select.options[select.selectedIndex];
      document.getElementById('class_name').value = selectedOption.getAttribute('data-class') || '';
      document.getElementById('stream_name').value = selectedOption.getAttribute('data-stream') || '';

      // Update disabled exams when pupil changes
      updateDisabledExams();
    }

    async function updateDisabledExams() {
      const pupilId = document.getElementById('pupil_id').value;
      const year = document.getElementById('year').value;
      const term = document.getElementById('term').value;
      const examSelect = document.getElementById('exam_name');

      // Clear any existing disabled state first
      for (let option of examSelect.options) {
        option.disabled = false;
        if (option.textContent.includes(' (Already Saved)')) {
          option.textContent = option.value;
        }
      }

      if (!pupilId || !year || !term) {
        return;
      }

      try {
        const q = new URLSearchParams({ pupil_id: pupilId, year: year, term: term });
        const resp = await fetch(`${location.origin}{{ url_for('teacher_routes.marks_status') }}?` + q.toString());
        if (!resp.ok) {
          // nothing to do, keep options enabled
          return;
        }
        const json = await resp.json();
        savedExams = json.saved_exams || [];

        // Update option disabled states based on savedExams
        for (let option of examSelect.options) {
          if (option.value && savedExams.includes(option.value)) {
            // Mark option as saved but keep it selectable so the teacher can view existing marks
            option.disabled = false;
            option.dataset.saved = 'true';
            option.textContent = option.value + ' (Already Saved)';
          } else {
            option.dataset.saved = 'false';
            // Ensure original label restored if previously modified
            if (option.textContent.endsWith(' (Already Saved)')) {
              option.textContent = option.value;
            }
          }
        }
        // If the currently selected exam is already saved, disable mark inputs and save button
        if (examSelect.value && savedExams.includes(examSelect.value)) {
          setFormDisabled(true);
        } else {
          setFormDisabled(false);
        }
      } catch (err) {
        console.error('Failed to fetch saved exams:', err);
      }
    }

    // Update disabled exams when year or term changes
    document.getElementById('year').addEventListener('change', updateDisabledExams);
    document.getElementById('term').addEventListener('change', updateDisabledExams);
    document.getElementById('pupil_id').addEventListener('change', updateDisabledExams);

    // Handle form submission via AJAX
    document.getElementById('marksForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.querySelector('.submit-btn');
      const pupilId = document.getElementById('pupil_id').value;
      const year = document.getElementById('year').value;
      const term = document.getElementById('term').value;
      const examName = document.getElementById('exam_name').value;

      const formData = new FormData(this);

      try {
        // Change button state to "Saving..."
        submitBtn.disabled = true;
        submitBtn.classList.add('saving');
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Saving...';

        const response = await fetch('{{ url_for("teacher_routes.manage_marks") }}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          },
          body: formData
        });

        if (!response.ok) {
          const errBody = await response.json().catch(() => ({}));
          throw new Error(errBody.message || 'Server rejected request');
        }

        const data = await response.json();

        if (data.success) {
          // Refresh disabled exams from server so the saved exam becomes disabled
          await updateDisabledExams();

          // Show success alert
          document.getElementById('successMessage').textContent = data.message;
          const successAlert = document.getElementById('successAlert');
          successAlert.classList.remove('d-none');

          // Change button to success state
          submitBtn.classList.remove('saving');
          submitBtn.classList.add('success');
          submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Saved!';

          // Hide error alert if visible
          document.getElementById('errorAlert').classList.add('d-none');

          // Reset form after 2 seconds
          setTimeout(() => {
            this.reset();
            document.getElementById('class_name').value = '';
            document.getElementById('stream_name').value = '';
            submitBtn.disabled = false;
            submitBtn.classList.remove('success');
            submitBtn.innerHTML = 'Save Marks';
            updateDisabledExams();
          }, 2000);

          // Hide success alert after 1 second (backend messages should disappear quickly)
          setTimeout(() => {
            successAlert.classList.add('d-none');
          }, 1000);
        } else {
          throw new Error(data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error:', error);

        // Show error alert
        document.getElementById('errorMessage').textContent = error.message || 'Failed to save marks. Please try again.';
        const errorAlert = document.getElementById('errorAlert');
        errorAlert.classList.remove('d-none');

        // Change button to error state
        submitBtn.classList.remove('saving');
        submitBtn.classList.add('error');
        submitBtn.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i> Error';

        // Restore button after 3 seconds
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.classList.remove('error');
          submitBtn.innerHTML = 'Save Marks';
        }, 3000);
      }
    });

    // Disable or enable form inputs when a saved exam is selected
    function setFormDisabled(disabled) {
      const submitBtn = document.querySelector('.submit-btn');
      // Disable score inputs
      const scoreInputs = document.querySelectorAll('input[id^="score_"]');
      scoreInputs.forEach(inp => {
        inp.disabled = disabled;
      });
      // Disable submit button but keep exam and pupil selectors enabled so teacher can switch
      submitBtn.disabled = disabled;
      if (disabled) {
        submitBtn.classList.add('error');
        submitBtn.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Already Saved';
      } else {
        submitBtn.classList.remove('error');
        submitBtn.innerHTML = 'Save Marks';
      }
    }

    // When teacher changes the selected exam, check if it's already saved
    document.getElementById('exam_name').addEventListener('change', function() {
      const examSelect = this;
      const selected = examSelect.options[examSelect.selectedIndex];
      const isSaved = selected && selected.dataset && selected.dataset.saved === 'true';
      setFormDisabled(!!isSaved);
    });

    // Initialize disabled exams on page load if needed
    updateDisabledExams();
  </script>
  <script>
    // Auto-dismiss any server-rendered flash alerts after 1 second
    document.addEventListener('DOMContentLoaded', function() {
      const autoDismiss = (el) => {
        if (!el) return;
        // don't schedule if already hidden
        if (el.classList.contains('d-none')) return;
        setTimeout(() => {
          try {
            el.classList.remove('show');
            el.classList.add('d-none');
          } catch (e) {
            if (el.parentNode) el.parentNode.removeChild(el);
          }
        }, 1000);
      };

      // Dismiss any alerts present on initial load (these are typically server-flashed)
      document.querySelectorAll('.alert').forEach(autoDismiss);

      // Observe additions to the DOM so dynamically shown alerts (if any) also get dismissed
      const observer = new MutationObserver(mutations => {
        for (const m of mutations) {
          for (const node of m.addedNodes) {
            if (!(node instanceof HTMLElement)) continue;
            if (node.classList.contains('alert')) {
              autoDismiss(node);
            } else {
              // if an element contains alerts deeper in the tree
              node.querySelectorAll && node.querySelectorAll('.alert').forEach(autoDismiss);
            }
          }
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    });
  </script>
</body>
</html>
