<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Attendance Roster</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{--muted:#6c757d}
    body { font-family: 'Poppins', Arial, sans-serif; font-size:0.95rem; -webkit-font-smoothing:antialiased }
    .compact { font-size:0.9rem }
    .present { background:#e8f5e9 }
    .absent { background:#ffebee }
    .late { background:#fff3e0 }
    .status-select { width:100%; min-width:120px }
    .top-controls { margin-bottom:12px }
    table.table-sm th, table.table-sm td { padding:8px 10px }
    .btn-wide { min-width:110px }

    /* Mobile-first responsive: stack table rows as cards on small screens */
    @media (max-width:576px) {
      .container { padding-left:10px; padding-right:10px }
      .top-controls .form-label { font-size:0.9rem }
      .table-responsive { padding:0 }
      table { border:0 }
      thead { display:none }
      tbody, tr, td { display:block; width:100% }
      tr { margin-bottom:10px; border:1px solid #e9ecef; border-radius:6px; padding:8px; background:#fff }
      td { padding:6px 0; border:0 }
      td[data-label] { display:flex; justify-content:space-between; align-items:center }
      td[data-label]::before { content: attr(data-label) ": "; font-weight:600; color:var(--muted); margin-right:8px }
      .status-select { font-size:1rem; padding:8px 10px }
      .btn { font-size:0.95rem }
      #saveBtn, #confirmBtn, #loadBtn { display:block; width:100%; margin-top:8px }
      .mt-3 { margin-top:14px }
      #markAllPresent, #markAllAbsent { width:48%; display:inline-block }
      #confirmedBadge { display:block; margin-top:8px }
    }
  </style>
</head>
<body>
  <!-- Navbar with back button -->
  <nav class="navbar fixed-top navbar-expand-lg" style="background:#283593; height:50px;">
    <div class="container-fluid px-3 d-flex align-items-center">
      <a class="navbar-brand text-white fw-bold" href="#">Attendance Roster</a>
      <div class="ms-auto">
        <a href="{{ url_for('teacher_routes.dashboard') }}" class="btn btn-sm btn-light" title="Back to dashboard" style="font-size:0.78rem; padding:4px 8px;"><i class="bi bi-box-arrow-left"></i> Back</a>
      </div>
    </div>
  </nav>

  <div style="height:60px;"></div>

  <!-- Fixed search under navbar -->
  <div class="search-fixed" style="position:sticky; top:60px; z-index:1100; background:#fff; padding:8px 0; box-shadow:0 2px 6px rgba(0,0,0,0.06);">
    <div class="container d-flex">
      <div class="input-group">
        <button id="searchBtn" class="btn input-group-text" type="button" title="Search"><i class="bi bi-search"></i></button>
        <input id="searchInput" type="text" class="form-control" placeholder="Search pupils by name..." />
        <button id="clearSearch" class="btn ms-2" type="button" title="Clear search"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
  </div>

  <main class="container py-3" style="margin-top:16px; overflow-y:auto; padding-bottom:68px;">
    <h4>Attendance — Select class and week</h4>

    <form id="attendanceMeta" class="row g-2 top-controls">
      <div class="col-auto">
        <label class="form-label">Class</label>
        {% if selected_class_id %}
          <div class="form-control-plaintext">Class {{ selected_class_id }} {% if selected_stream %}- Stream {{ selected_stream }}{% endif %}</div>
          <input type="hidden" id="classIdHidden" value="{{ selected_class_id }}" />
          <input type="hidden" id="streamIdHidden" value="{{ selected_stream if selected_stream else '' }}" />
        {% else %}
          <div class="form-text text-muted">You have no class assignments. Contact admin.</div>
        {% endif %}
      </div>
      <div class="col-auto">
        <label class="form-label">Week start (Mon)</label>
        <input type="date" id="weekStart" class="form-control" value="{{ week_dates[0].isoformat() if week_dates else '' }}" />
      </div>
      <div class="col-auto">
        <label class="form-label">Days</label>
        <select id="daysSelect" class="form-select">
          <option value="6">Mon–Sat (6)</option>
          <option value="5" {% if week_dates and week_dates|length==5 %}selected{% endif %}>Mon–Fri (5)</option>
        </select>
      </div>
      <div class="col-auto align-self-end">
        <button id="loadBtn" type="button" class="btn btn-secondary">Load Roster</button>
        <button id="saveBtn" type="button" class="btn btn-primary">Save Attendance</button>
        <button id="confirmBtn" type="button" class="btn btn-warning ms-2">{{ 'Unconfirm' if confirmed else 'Confirm Period' }}</button>
      </div>
    </form>

    <div id="rosterArea" class="table-responsive">
      {% if pupils %}
      <table class="table table-bordered table-sm compact">
        <thead>
          <tr>
            <th>#</th>
            <th>Pupil</th>
            {% for d in week_dates %}
              <th class="text-center">{{ d.strftime('%a') }}<br>{{ d.strftime('%d-%b') }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for p in pupils %}
            <tr data-pupil-id="{{ p.id }}" data-class-id="{{ p.class_id }}" data-stream-id="{{ p.stream_id }}">
              <td>{{ loop.index }}</td>
              <td data-label="Pupil">{{ p.first_name }} {{ p.last_name }}</td>
              {% for d in week_dates %}
                {% set a = att_map.get((p.id, d.isoformat())) %}
                <td data-label="{{ d.strftime('%a %d-%b') }}" class="text-center {% if a %}{{ a.status }}{% endif %}">
                  <select class="form-select status-select form-select-sm" data-date="{{ d.isoformat() }}">
                    <option value="present" {% if a and a.status=='present' %}selected{% endif %}>Present</option>
                    <option value="absent" {% if a and a.status=='absent' %}selected{% endif %}>Absent</option>
                    <option value="late" {% if a and a.status=='late' %}selected{% endif %}>Late</option>
                    <option value="leave" {% if a and a.status=='leave' %}selected{% endif %}>Authorized Leave</option>
                  </select>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="alert alert-info">No pupils available for this assignment. If you believe this is incorrect, contact the administrator.</div>
      {% endif %}
    </div>

    <div class="mt-3">
      <button id="markAllPresent" class="btn btn-outline-success btn-sm">Mark All Present</button>
      <button id="markAllAbsent" class="btn btn-outline-danger btn-sm">Mark All Absent</button>
      <span id="confirmedBadge" class="ms-3">
        {% if confirmed %}
          <span class="badge bg-success">Period Confirmed</span>
        {% else %}
          <span class="text-muted small">Not confirmed</span>
        {% endif %}
      </span>
    </div>
  </main>

  {% include 'footer.html' %}

  <script>
    // client-side search filter for attendance roster
    (function(){
      var input = document.getElementById('searchInput');
      var clearBtn = document.getElementById('clearSearch');
      function applyFilter(){
        var q = input ? input.value.trim().toLowerCase() : '';
        var rows = document.querySelectorAll('#rosterArea table tbody tr');
        rows.forEach(function(row){
          var nameCell = row.querySelector('td[data-label="Pupil"]');
          var name = nameCell ? nameCell.textContent.trim().toLowerCase() : '';
          row.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
        });
      }
      if (input) input.addEventListener('input', function(){ applyFilter(); });
      if (clearBtn) clearBtn.addEventListener('click', function(){ if (input) { input.value=''; applyFilter(); input.focus(); } });
    })();
  </script>
  </div>

  <script>
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const markAllPresent = document.getElementById('markAllPresent');
    const markAllAbsent = document.getElementById('markAllAbsent');

    markAllPresent && markAllPresent.addEventListener('click', ()=>{
      document.querySelectorAll('.status-select').forEach(s=> s.value='present');
    });
    markAllAbsent && markAllAbsent.addEventListener('click', ()=>{
      document.querySelectorAll('.status-select').forEach(s=> s.value='absent');
    });

    saveBtn && saveBtn.addEventListener('click', async ()=>{
      const classId = document.getElementById('classIdHidden') ? document.getElementById('classIdHidden').value : '';
      const days = parseInt(document.getElementById('daysSelect').value || '6', 10);
      const entries = [];
      document.querySelectorAll('tbody tr').forEach(tr=>{
        const pid = tr.getAttribute('data-pupil-id');
        const rowClass = tr.getAttribute('data-class-id');
        const rowStream = tr.getAttribute('data-stream-id');
        tr.querySelectorAll('.status-select').forEach(sel=>{
          entries.push({ pupil_id: parseInt(pid), class_id: rowClass ? parseInt(rowClass) : null, stream_id: rowStream ? parseInt(rowStream) : null, date: sel.dataset.date, status: sel.value, reason: '' });
        });
      });

      const payload = { class_id: classId, entries, days };
      const resp = await fetch("{{ url_for('teacher_routes.attendance_view') }}", {
        method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (resp.ok) { alert('Attendance saved'); location.reload(); }
      else { alert('Save failed'); }
    });

    loadBtn && loadBtn.addEventListener('click', ()=>{
      const start = document.getElementById('weekStart').value;
      const cls = document.getElementById('classIdHidden') ? document.getElementById('classIdHidden').value : '';
      const days = document.getElementById('daysSelect').value || '6';
      if (!cls) return alert('You have no class assignments');
      window.location.href = `{{ url_for('teacher_routes.attendance_view') }}?class_id=${cls}&start=${start}&days=${days}`;
    });

    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn && confirmBtn.addEventListener('click', async ()=>{
      const classId = document.getElementById('classIdHidden') ? document.getElementById('classIdHidden').value : '';
      const start = document.getElementById('weekStart').value;
      const days = parseInt(document.getElementById('daysSelect').value || '6', 10);
      if (!classId) return alert('You have no class assignments');
      const currentlyConfirmed = {{ confirmed|tojson }};
      const payload = { class_id: classId, start: start, period: 'week', days: days, confirm: !currentlyConfirmed };
      const resp = await fetch("{{ url_for('teacher_routes.attendance_confirm') }}", {
        method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (resp.ok) {
        const j = await resp.json();
        if (j.confirmed) { alert('Period confirmed'); } else { alert('Period unconfirmed'); }
        location.reload();
      } else { alert('Confirm action failed'); }
    });
  </script>
</body>
</html>
