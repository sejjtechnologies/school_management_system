<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Attendance Roster</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { --bs-body-font-size: 0.95rem; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      font-family: 'Poppins', Arial, sans-serif;
      font-size: 0.95rem;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
      background-color: #f9f9f9;
    }

    /* Fixed Navbar */
    .navbar {
      background-color: #dc3545;
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      flex-shrink: 0;
    }
    .navbar-brand {
      color: white !important;
      font-weight: bold;
      font-size: 0.95rem !important;
      margin: 0 !important;
      white-space: nowrap !important;
    }
    .back-btn-top {
      background-color: white;
      color: #dc3545;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
      text-decoration: none;
    }
    .back-btn-top:hover {
      background-color: #f5f5f5;
      color: #dc3545;
    }
    .back-btn-top i {
      font-size: 0.8rem;
      color: #dc3545;
    }

    /* Improved search bar right after navbar */
    .search-bar-fixed {
      position: fixed;
      top: 65px;
      left: 0;
      right: 0;
      background: #fff;
      padding: 5px 10px;
      z-index: 999;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .search-bar-fixed .search-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: 100%;
    }
    .search-bar-fixed .form-control {
      height: 32px;
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 4px;
      flex: 1;
    }
    .search-bar-fixed .btn-clear {
      height: 32px;
      width: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #666;
    }
    .search-bar-fixed .btn-clear:hover {
      background: #dee2e6;
      color: #333;
    }

    /* Fixed Footer */
    footer {
      min-height: 60px;
      background: white;
      border-top: 1px solid #e9ecef;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      flex-shrink: 0;
    }

    /* Main scrollable section - use CSS variable for footer height so mobile devices work reliably */
    main {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 12px;
      padding-top: 0px;
      /* reserve footer height + 20px gap (defaults to 68px if variable not set: 48px footer + 20px) */
      padding-bottom: calc(var(--footer-height, 68px) + 20px);
      margin-top: 105px;
      -webkit-overflow-scrolling: touch;
    }
    main::-webkit-scrollbar {
      width: 6px;
    }
    main::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    main::-webkit-scrollbar-thumb {
      background: #dc3545;
      border-radius: 3px;
    }

    .compact { font-size: 0.9rem }
    .present { background: #e8f5e9 }
    .absent { background: #ffebee }
    .late { background: #fff3e0 }
    .status-select { width: 100%; min-width: 120px }
    .top-controls { margin-bottom: 12px }
    .top-search { background: #fff; padding: 12px; border-bottom: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 12px; }
    .search-input-group { max-width: 400px; margin: 0 auto; }
    table.table-sm th, table.table-sm td { padding: 8px 10px }
    .btn-wide { min-width: 110px }

    @media (max-width: 576px) {
      .navbar { padding: 0 10px !important; }
      .navbar-brand { font-size: 0.85rem !important; }
      .back-btn-top { padding: 3px 6px !important; font-size: 0.65rem !important; }
      main { margin-top: 105px !important; padding: 20px 12px !important; padding-top: 0px !important; padding-bottom: calc(var(--footer-height, 68px) + 20px) !important; }
      .container { padding-left: 10px; padding-right: 10px }
      .top-controls .form-label { font-size: 0.9rem }
      .table-responsive { padding: 0 }
      table { border: 0 }
      thead { display: none }
      tbody, tr, td { display: block; width: 100% }
      tr { margin-bottom: 10px; border: 1px solid #e9ecef; border-radius: 6px; padding: 8px; background: #fff }
      td { padding: 6px 0; border: 0 }
      td[data-label] { display: flex; justify-content: space-between; align-items: center }
      td[data-label]::before { content: attr(data-label) ": "; font-weight: 600; color: var(--muted); margin-right: 8px }
      .status-select { font-size: 1rem; padding: 8px 10px }
      .btn { font-size: 0.95rem }
      #saveBtn, #confirmBtn, #loadBtn { display: block; width: 100%; margin-top: 8px }
      .mt-3 { margin-top: 14px }
      #markAllPresent, #markAllAbsent { width: 48%; display: inline-block }
      #confirmedBadge { display: block; margin-top: 8px }
    }
  </style>
</head>
<body>
  <!-- Fixed Red Navbar -->
  <nav class="navbar">
    <span class="navbar-brand" style="display:flex; align-items:center; gap:8px;">
      <img src="/static/logo.png" alt="Logo" style="height:32px; width:auto;"> Attendance Roster
      {% if selected_class_id %}
        <span style="font-weight: normal; margin-left: 8px; font-size: 0.9rem;">{{ selected_class_id }}{% if selected_stream %} {{ selected_stream | truncate(1, end='') }}{% endif %}</span>
      {% endif %}
    </span>
    <a href="{{ url_for('teacher_routes.dashboard') }}" class="back-btn-top">
      <i class="bi bi-box-arrow-right"></i> Back
    </a>
  </nav>

  <!-- Fixed Search Bar (right after navbar with 5px gap) -->
  <div class="search-bar-fixed">
    <div class="search-wrapper">
      <input id="pupilSearchBox" type="search" class="form-control" placeholder="ðŸ” Search by name..." />
      <button class="btn-clear" id="clearSearchBtn" title="Clear search" style="display: none;">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container">
    <h4>Attendance â€” Select class and week</h4>

    <form id="attendanceMeta" class="row g-2 top-controls" style="margin-top: 15px;">
      <div class="col-auto">
        <label class="form-label">Class</label>
        {% if selected_class_id %}
          <div class="form-control-plaintext">Class {{ selected_class_id }} {% if selected_stream %}- Stream {{ selected_stream }}{% endif %}</div>
          <input type="hidden" id="classIdHidden" value="{{ selected_class_id }}" />
          <input type="hidden" id="streamIdHidden" value="{{ selected_stream if selected_stream else '' }}" />
        {% else %}
          <div class="form-text text-muted">You have no class assignments. Contact admin.</div>
        {% endif %}
      </div>
      <div class="col-auto">
        <label class="form-label">Week start (Mon)</label>
        <input type="date" id="weekStart" class="form-control" value="{{ week_dates[0].isoformat() if week_dates else '' }}" />
      </div>
      <div class="col-auto">
        <label class="form-label">Days</label>
        <select id="daysSelect" class="form-select">
          <option value="6">Monâ€“Sat (6)</option>
          <option value="5" {% if week_dates and week_dates|length==5 %}selected{% endif %}>Monâ€“Fri (5)</option>
        </select>
      </div>
      <div class="col-auto align-self-end">
        <button id="loadBtn" type="button" class="btn btn-secondary">Load Roster</button>
        <button id="saveBtn" type="button" class="btn btn-primary">Save Attendance</button>
        <button id="confirmBtn" type="button" class="btn btn-warning ms-2" data-confirmed="{{ confirmed|tojson }}">{{ 'Unconfirm' if confirmed else 'Confirm Period' }}</button>
      </div>
    </form>

    <div id="rosterArea" class="table-responsive">
      {% if pupils %}
      <table class="table table-bordered table-sm compact">
        <thead>
          <tr>
            <th>#</th>
            <th>Pupil</th>
            {% for d in week_dates %}
              <th class="text-center">{{ d.strftime('%a') }}<br>{{ d.strftime('%d-%b') }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for p in pupils %}
            <tr data-pupil-id="{{ p.id }}" data-class-id="{{ p.class_id }}" data-stream-id="{{ p.stream_id }}">
              <td>{{ loop.index }}</td>
              <td data-label="Pupil">{{ p.first_name }} {{ p.last_name }}</td>
              {% for d in week_dates %}
                {% set a = att_map.get((p.id, d.isoformat())) %}
                <td data-label="{{ d.strftime('%a %d-%b') }}" class="text-center {% if a %}{{ a.status }}{% endif %}">
                  <select class="form-select status-select form-select-sm" data-date="{{ d.isoformat() }}">
                    <option value="present" {% if a and a.status=='present' %}selected{% endif %}>Present</option>
                    <option value="absent" {% if a and a.status=='absent' %}selected{% endif %}>Absent</option>
                    <option value="late" {% if a and a.status=='late' %}selected{% endif %}>Late</option>
                    <option value="leave" {% if a and a.status=='leave' %}selected{% endif %}>Authorized Leave</option>
                  </select>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="alert alert-info">No pupils available for this assignment. If you believe this is incorrect, contact the administrator.</div>
      {% endif %}
    </div>

    <div class="mt-3">
      <button id="markAllPresent" class="btn btn-outline-success btn-sm">Mark All Present</button>
      <button id="markAllAbsent" class="btn btn-outline-danger btn-sm">Mark All Absent</button>
      <span id="confirmedBadge" class="ms-3">
        {% if confirmed %}
          <span class="badge bg-success">Period Confirmed</span>
        {% else %}
          <span class="text-muted small">Not confirmed</span>
        {% endif %}
      </span>
    </div>
  </main>

  {% include 'footer.html' %}

  <script>
    // client-side search filter for attendance roster
    (function(){
      var input = document.getElementById('pupilSearchBox');
      var clearBtn = document.getElementById('clearSearchBtn');
      
      function applyFilter(){
        var q = input ? input.value.trim().toLowerCase() : '';
        // Show/hide clear button
        if (clearBtn) {
          clearBtn.style.display = q ? 'flex' : 'none';
        }
        var rows = document.querySelectorAll('#rosterArea table tbody tr');
        rows.forEach(function(row){
          var nameCell = row.querySelector('td[data-label="Pupil"]');
          var name = nameCell ? nameCell.textContent.trim().toLowerCase() : '';
          row.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
        });
      }
      
      if (input) input.addEventListener('input', function(){ applyFilter(); });
      if (clearBtn) clearBtn.addEventListener('click', function(e){
        e.preventDefault();
        if (input) { 
          input.value = ''; 
          applyFilter(); 
          input.focus(); 
        }
      });
    })();
  </script>
  <script>
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const markAllPresent = document.getElementById('markAllPresent');
    const markAllAbsent = document.getElementById('markAllAbsent');

    markAllPresent && markAllPresent.addEventListener('click', ()=>{
      document.querySelectorAll('.status-select').forEach(s=> s.value='present');
    });
    markAllAbsent && markAllAbsent.addEventListener('click', ()=>{
      document.querySelectorAll('.status-select').forEach(s=> s.value='absent');
    });

    saveBtn && saveBtn.addEventListener('click', async ()=>{
      const classId = document.getElementById('classIdHidden') ? document.getElementById('classIdHidden').value : '';
      const days = parseInt(document.getElementById('daysSelect').value || '6', 10);
      const entries = [];
      document.querySelectorAll('tbody tr').forEach(tr=>{
        const pid = tr.getAttribute('data-pupil-id');
        const rowClass = tr.getAttribute('data-class-id');
        const rowStream = tr.getAttribute('data-stream-id');
        tr.querySelectorAll('.status-select').forEach(sel=>{
          entries.push({ pupil_id: parseInt(pid), class_id: rowClass ? parseInt(rowClass) : null, stream_id: rowStream ? parseInt(rowStream) : null, date: sel.dataset.date, status: sel.value, reason: '' });
        });
      });

      const payload = { class_id: classId, entries, days };
      const resp = await fetch("{{ url_for('teacher_routes.attendance_view') }}", {
        method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (resp.ok) { alert('Attendance saved'); location.reload(); }
      else { alert('Save failed'); }
    });

    loadBtn && loadBtn.addEventListener('click', ()=>{
      const start = document.getElementById('weekStart').value;
      const cls = document.getElementById('classIdHidden') ? document.getElementById('classIdHidden').value : '';
      const days = document.getElementById('daysSelect').value || '6';
      if (!cls) return alert('You have no class assignments');
      window.location.href = `{{ url_for('teacher_routes.attendance_view') }}?class_id=${cls}&start=${start}&days=${days}`;
    });

    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn && confirmBtn.addEventListener('click', async ()=>{
      const classId = document.getElementById('classIdHidden') ? document.getElementById('classIdHidden').value : '';
      const start = document.getElementById('weekStart').value;
      const days = parseInt(document.getElementById('daysSelect').value || '6', 10);
      if (!classId) return alert('You have no class assignments');
      const currentlyConfirmed = JSON.parse(confirmBtn.getAttribute('data-confirmed') || 'false');
      const payload = { class_id: classId, start: start, period: 'week', days: days, confirm: !currentlyConfirmed };
      const resp = await fetch("{{ url_for('teacher_routes.attendance_confirm') }}", {
        method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (resp.ok) {
        const j = await resp.json();
        if (j.confirmed) { alert('Period confirmed'); } else { alert('Period unconfirmed'); }
        location.reload();
      } else { alert('Confirm action failed'); }
    });
  </script>
  <script>
    // Ensure the main area reserves footer height + 20px gap dynamically and respects navbar - FORCED on mobile
    (function(){
      function updateFooterHeight(){
        const footer = document.querySelector('footer');
        const main = document.querySelector('main');
        if (!footer || !main) return;
        const footerH = footer.offsetHeight || 48;
        document.documentElement.style.setProperty('--footer-height', footerH + 'px');
        // set padding-bottom to footer height + 20px gap - FORCE with !important
        main.style.setProperty('padding-bottom', (footerH + 20) + 'px', 'important');
        // ensure main has margin-top (navbar height: 60px) only
        main.style.setProperty('margin-top', '60px', 'important');
        // remove padding-top to avoid navbar conflict
        main.style.setProperty('padding-top', '0px', 'important');
      }
      document.addEventListener('DOMContentLoaded', function(){
        updateFooterHeight();
        window.addEventListener('resize', updateFooterHeight);
        window.addEventListener('orientationchange', updateFooterHeight);
        // slight delay to catch fonts/images that might change layout
        setTimeout(updateFooterHeight, 500);
      });
    })();
  </script>
</body>
</html>
