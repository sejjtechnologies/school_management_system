<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Print Report - {{ pupil.first_name }} {{ pupil.last_name }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      font-size: 0.68rem;
      background: #f5f5f5;
      margin: 0;
    }

    .page-bg {
      background: #ffffff;
      padding: 10px;
      max-width: 820px;
      margin: auto;
    }

    /* Print setup */
    @page {
      size: A4 portrait;
      margin: 6mm;
    }

    @media print {
      html, body {
        width: 210mm;
        height: 297mm;
      }

      body {
        margin: 0 !important;
        padding: 0 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        overflow: hidden;
        transform: scale(0.92);
        transform-origin: top left;
      }

      .hide-print { display: none !important; }
      .report-card { page-break-inside: avoid !important; }
    }

    @media (max-width: 576px) {
      .page-bg { padding: 6px; }
      .school-footer { font-size: 0.55rem !important; padding: 6px !important; }
      .school-nav h2 { font-size: 0.95rem; }
    }

    .report-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .school-nav {
      background:#c62828;
      color:#fff;
      height:60px;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      margin-bottom:10px;
    }

    .school-footer {
      background:#263238;
      color:#fff;
      height: 50px;
      padding: 5px 10px;
      border-radius:4px;
      font-size:0.65rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
    }

    .badge-grade {
      padding: 2px 4px;
      border-radius: 4px;
      color:#fff;
      font-weight:600;
      font-size:0.58rem;
    }

    .grade-A { background:#2e7d32 }
    .grade-B { background:#0288d1 }
    .grade-C { background:#f9a825 }
    .grade-D { background:#fb8c00 }
    .grade-E { background:#d32f2f }

    .pos-badge {
      background:#6a1b9a;
      color:#fff;
      padding:2px 4px;
      border-radius:4px;
      font-size:0.55rem;
      font-weight:600;
    }

    .remark-box {
      background:#fff8e1;
      border-left: 3px solid #ffca28;
      padding: 6px;
      border-radius: 4px;
      font-size: 0.65rem;
    }

    .class-teacher { color: #e57373; font-size: 0.65rem; font-weight:600; margin-top:8px }

    h5 { font-size: 0.85rem; }
  </style>
</head>

<body>

  <div class="page-bg">

    <div class="school-nav">
      <div style="text-align:center">
        <h2 class="m-0">HOPEFUL FUTURE PRIMARY SCHOOL</h2>
        <div style="font-size:0.70rem">Nurturing Minds, Shaping Futures</div>
      </div>

      <div class="top-actions hide-print" style="position:absolute; right:8px;">
        <button class="btn btn-primary btn-sm" onclick="downloadDoc()">Download .doc</button>
        <button class="btn btn-primary btn-sm" onclick="savePdf()">Save as PDF</button>
      </div>
    </div>

    <!-- PRINTABLE PUPIL DETAILS (removed hide-print) -->
    <div class="card p-2 mb-3">
      <h5 class="mb-1">{{ pupil.first_name }} {{ pupil.middle_name }} {{ pupil.last_name }}</h5>
      <div class="text-muted">Adm: {{ pupil.admission_number }}</div>
      <div class="text-muted">Class: {{ pupil.class_name }} | Stream: {{ pupil.stream_name }}</div>

      {% if class_teacher %}
      <div class="text-muted"><strong>Class Teacher:</strong> {{ class_teacher.first_name }} {{ class_teacher.last_name }}</div>
      {% endif %}
    </div>

    {% for ex in exams %}
    <div class="report-card">

      <div class="report-header d-flex justify-content-between flex-wrap mb-2">
        <h5 class="mb-0">{{ ex.name }} - Term {{ ex.term }} / {{ ex.year }}</h5>

        <div class="text-end">
          {% set rep = (reports | selectattr('exam_id','equalto', ex.id) | list).0 %}
          {% set stats = exam_stats.get(ex.id) %}

          <div><strong>Total:</strong> {{ rep.total_score }} / {{ subjects|length * 100 }}</div>
          <div><strong>Avg:</strong> {{ rep.average_score }}</div>
          <div><strong>Grade:</strong>
            <span class="badge-grade grade-{{ rep.grade }}">{{ rep.grade }}</span>
          </div>

          {% if stats %}
          <div><span class="pos-badge">Stream: {{ stats.stream_position }} / {{ stats.stream_total }}</span></div>
          {% endif %}
        </div>
      </div>

      <table class="table table-sm report-table">
        <thead>
          <tr>
            <th>Subject</th>
            <th class="text-end">Score</th>
            <th class="text-end">Grade</th>
          </tr>
        </thead>

        <tbody>
          {% set marks = marks_by_exam.get(ex.id, []) %}
          {% for subj in subjects %}
          {% set m = (marks | selectattr('subject_id','equalto',subj.id) | list).0 %}
          <tr>
            <td>{{ subj.name }}</td>
            <td class="text-end">{{ m.score if m else "-" }}{% if m %} / 100{% endif %}</td>
            <td class="text-end">
              {% if m %}
                {% set sc=m.score %}
                <span class="badge-grade grade-{% if sc>=80 %}A{% elif sc>=70 %}B{% elif sc>=60 %}C{% elif sc>=50 %}D{% else %}E{% endif %}">
                  {% if sc>=80 %}A{% elif sc>=70 %}B{% elif sc>=60 %}C{% elif sc>=50 %}D{% else %}E{% endif %}
                </span>
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
    {% endfor %}

    {% if combined %}
    <div class="report-card">
      <h5>Combined Summary</h5>

      <p><strong>Combined Total:</strong> {{ combined.combined_total }}</p>
      <p><strong>Average:</strong> {{ combined.combined_average }}</p>
      <p><strong>Final Grade:</strong>
        <span class="badge-grade grade-{{ combined.combined_grade }}">{{ combined.combined_grade }}</span>
      </p>

      {% if class_position %}
      <p><span class="pos-badge">Class Position: {{ class_position }} / {{ class_total }}</span></p>
      {% endif %}

      <div class="remark-box"><strong>Remark:</strong> {{ combined.general_remark }}</div>

      {% if class_teacher %}
      <div class="class-teacher">Class Teacher: {{ class_teacher.first_name }} {{ class_teacher.last_name }}</div>
      {% endif %}
    </div>
    {% endif %}

    <div class="school-footer">
      <div>Contacts: 0744137174 | 0768936641</div>
      <div>Email: info@hopefulfutureps.org | Entebbe - Wakiso</div>
    </div>

  </div>

  <script>
    function downloadDoc(){
      const content = document.querySelector('.page-bg').innerHTML;
      const header = "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Report</title></head><body>";
      const footer = "</body></html>";
      const blob = new Blob([header + content + footer], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'report.doc';
      a.click();
      URL.revokeObjectURL(url);
    }

    function savePdf(){
      window.print();
    }
  </script>

</body>
</html>
