<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Print Report - {{ pupil.first_name }} {{ pupil.last_name }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Times New Roman', serif;
      font-size: 0.75rem;
      background: #d0f0c0; /* Green page background */
      margin: 0;
    }

    .page-bg {
      background: #ffffff;
      padding: 10px;
      max-width: 820px;
      margin: auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Print setup */
    @page {
      size: A4 portrait;
      margin: 6mm;
    }

    @media print {
      html, body { width: 210mm; height: 297mm; }
      body {
        margin: 0 !important;
        padding: 0 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .hide-print { display: none !important; }
      .report-card { page-break-inside: avoid !important; }
    }

    .school-nav {
      background:#c62828;
      color:#fff;
      height:100px;
      border-radius:4px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      position:relative;
      margin-bottom:10px;
      font-family: Georgia, serif; /* Georgia for school name & motto */
      flex-shrink: 0;
      padding-top: 8px;
      padding-bottom: 8px;
    }

    .school-nav h2 {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
    }

    .school-nav .motto {
      font-size: 1rem;
      margin-top: 2px;
      color: #ffeb3b;
    }

    .school-nav .contact-socials {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 800px;
      font-size: 0.65rem;
      margin-top: 4px;
      padding: 0 10px;
    }

    .contact-left {
      text-align: left;
    }

    .contact-right {
      text-align: right;
    }

    .social-icons span {
      margin-left: 6px;
      margin-right: 6px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .report-card {
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-size: 0.80rem;
      color: #333;
      font-family: 'Times New Roman', serif; /* Times New Roman for report content */
      flex-shrink: 0;
    }
    .report-card:nth-child(odd) { background: #e0f7fa; }
    .report-card:nth-child(even) { background: #fff3e0; }

    h5.term-title { color: #c2185b; font-weight: bold; margin-bottom:5px; }
    .text-total { color: #2e7d32; font-weight:600; }
    .text-avg { color: #0288d1; font-weight:600; }
    .text-grade { color: #f9a825; font-weight:600; }

    .badge-grade { padding: 2px 5px; border-radius: 4px; color:#fff; font-weight:600; font-size:0.60rem; }
    .grade-A { background:#2e7d32 }
    .grade-B { background:#0288d1 }
    .grade-C { background:#f9a825 }
    .grade-D { background:#fb8c00 }
    .grade-E { background:#d32f2f }

    .pos-badge { background:#6a1b9a; color:#fff; padding:2px 4px; border-radius:4px; font-size:0.55rem; font-weight:600; }

    .remark-box { background:#fff8e1; border-left: 3px solid #ffca28; padding: 6px; border-radius: 4px; font-size: 0.70rem; }
    .class-teacher { color: #e57373; font-size: 0.70rem; font-weight:600; margin-top:6px }

    table th, table td { text-align:center; vertical-align:middle; font-size:0.70rem; }
    table th:first-child, table td:first-child { text-align:left; }
    table { width: 100%; border-collapse: collapse; margin-bottom:4px; }
  </style>
</head>

<body>
  <div class="page-bg">

    <div class="school-nav">
      <h2>HOPEFUL FUTURE PRIMARY SCHOOL</h2>
      <div class="motto">Nurturing Minds, Shaping Futures</div>

      <div class="contact-socials">
        <div class="contact-left">
          <span>Location: Entebbe, Wakiso</span> |
          <span>Box: 12345</span> |
          <span>Call: 0768936641 / 0744137174</span>
        </div>
        <div class="contact-right social-icons">
          <span>üìß info@hopefulfutureps.org</span>
          <span>üí¨ WhatsApp</span>
          <span>üìò Facebook</span>
          <span>üíº LinkedIn</span>
          <span>üê¶ X/Twitter</span>
        </div>
      </div>

      <div class="top-actions hide-print" style="position:absolute; right:8px; top:8px;">
        <button class="btn btn-primary btn-sm" onclick="downloadDoc()">Download .doc</button>
        <button class="btn btn-primary btn-sm" onclick="savePdf()">Save as PDF</button>
      </div>
    </div>

    <!-- Pupil Details -->
    <div class="card p-2 mb-3" style="background:#c8e6c9;">
      <h5>{{ pupil.first_name }} {{ pupil.middle_name }} {{ pupil.last_name }}</h5>
      <div>Adm: {{ pupil.admission_number }}</div>
      <div>Class: {{ pupil.class_name }} | Stream: {{ pupil.stream_name }}</div>
      {% if class_teacher %}
      <div><strong>Class Teacher:</strong> {{ class_teacher.first_name }} {{ class_teacher.last_name }}</div>
      {% endif %}
    </div>

    {% for ex in exams %}
    <div class="report-card">
      <h5 class="term-title">{{ ex.name }} - Term {{ ex.term }}/{{ ex.year }}</h5>

      <div class="d-flex justify-content-between flex-wrap mb-2">
        {% set rep = (reports | selectattr('exam_id','equalto', ex.id) | list).0 %}
        {% set stats = exam_stats.get(ex.id) %}
        <div class="text-total">Total: {{ rep.total_score }} / {{ subjects|length * 100 }}</div>
        <div class="text-avg">Avg: {{ rep.average_score }}</div>
        <div class="text-grade">Grade: <span class="badge-grade grade-{{ rep.grade }}">{{ rep.grade }}</span></div>
        {% if stats %}
        <div><span class="pos-badge">Stream: {{ stats.stream_position }}/{{ stats.stream_total }}</span></div>
        {% endif %}
      </div>

      <!-- Table -->
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Subj</th>
            <th>Pupil</th>
            <th>Max</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody>
          {% set marks = marks_by_exam.get(ex.id, []) %}
          {% for subj in subjects %}
          {% set m = (marks | selectattr('subject_id','equalto',subj.id) | list).0 %}
          <tr>
            <td>{{ subj.abbr|default(subj.name[:3]) }}</td>
            <td>{{ m.score if m else "-" }}</td>
            <td>100</td>
            <td>
              {% if m %}
              {% set sc=m.score %}
              <span class="badge-grade grade-{% if sc>=80 %}A{% elif sc>=70 %}B{% elif sc>=60 %}C{% elif sc>=50 %}D{% else %}E{% endif %}">
                {% if sc>=80 %}A{% elif sc>=70 %}B{% elif sc>=60 %}C{% elif sc>=50 %}D{% else %}E{% endif %}
              </span>
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endfor %}

    {% if combined %}
    <div class="report-card" style="background:#ffecb3;">
      <h5>Combined Summary</h5>
      <p><strong>Combined Total:</strong> {{ combined.combined_total }}</p>
      <p><strong>Average:</strong> {{ combined.combined_average }}</p>
      <p><strong>Final Grade:</strong> <span class="badge-grade grade-{{ combined.combined_grade }}">{{ combined.combined_grade }}</span></p>
      {% if class_position %}
      <p><span class="pos-badge">Class Pos: {{ class_position }}/{{ class_total }}</span></p>
      {% endif %}
      <div class="remark-box"><strong>Remark:</strong> {{ combined.general_remark }}</div>
      {% if class_teacher %}
      <div class="class-teacher">Class Teacher: {{ class_teacher.first_name }} {{ class_teacher.last_name }}</div>
      {% endif %}
    </div>
    {% endif %}

  </div>

  <script>
    function downloadDoc(){
      const content = document.querySelector('.page-bg').innerHTML;
      const header = "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Report</title></head><body>";
      const footer = "</body></html>";
      const blob = new Blob([header + content + footer], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'report.doc';
      a.click();
      URL.revokeObjectURL(url);
    }
    function savePdf(){
      window.print();
    }
  </script>
</body>
</html>
