<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Print Report - {{ pupil.first_name }} {{ pupil.last_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', Arial, sans-serif; }
    @page { size: A4 portrait; margin: 10mm; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .no-print { display: none !important; }
      .report-card { page-break-after: always; }
      .container { max-width: 100%; padding: 0; }
    }
    /* full page background for screen only */
    .page-bg { background: linear-gradient(180deg, #e1f5fe 0%, #bbdefb 100%); min-height: 100vh; padding: 18px; position: relative; }
    @media print {
      .page-bg { background: #fff !important; padding: 0 !important; }
    }
    .report-card { border: 1px solid #e0e0e0; padding: 16px; margin-bottom: 18px; break-inside: avoid; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .report-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .report-table th { background:#283593; color:#fff; }
    .footer-print { background:#f1f1f1; color:#222; padding:12px; text-align:center; margin-top:8px; border-radius:4px; }
    /* Top red nav style */
    .school-nav { background: #c62828; color: #fff; padding: 12px 16px; border-radius:4px; }
    .school-nav .meta { font-size: 0.9rem; opacity: 0.95; }
    .school-motto { font-style: italic; opacity: 0.95; }
    .school-footer { background: #263238; color: #fff; padding: 18px 12px; margin-top: 18px; border-radius:4px; }
    .school-footer a { color: #ffd54f; text-decoration: none; }
    /* responsive tweaks */
    @media (max-width: 576px) {
      .report-header { flex-direction: column; align-items: flex-start; }
      .report-header .text-end { text-align: left !important; }
    }
    /* watermark */
    .watermark {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotate(-25deg);
      font-size: 220px;
      line-height: 1;
      color: rgba(255,255,255,0.12);
      font-weight: 800;
      pointer-events: none;
      user-select: none;
      z-index: 0;
      white-space: nowrap;
      width: 140%;
    }
    @media print {
      .watermark { display: none !important; }
    }
    /* modern table tweaks */
    .report-table { border-collapse: separate; border-spacing: 0; overflow: hidden; border-radius: 6px; }
    .report-table th, .report-table td { padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,0.06); }
    .report-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.6); }
    .report-table thead th { background: rgba(40,53,147,0.95); color: #fff; }
    .report-card { background: #fff; position: relative; z-index: 1; }
    .badge-grade { padding: 6px 8px; border-radius: 6px; color: #fff; font-weight:600 }
    .grade-A { background:#2e7d32 } /* green */
    .grade-B { background:#0288d1 } /* blue */
    .grade-C { background:#f9a825 } /* amber */
    .grade-D { background:#fb8c00 } /* orange */
    .grade-E { background:#d32f2f } /* red */
    .pos-badge { background:#6a1b9a; color:#fff; padding:4px 8px; border-radius:6px; font-weight:600 }
    .remark-box { background:#fff8e1; border-left:4px solid #ffd54f; padding:8px 10px; border-radius:4px }
    .dotted-line { border-bottom:1px dotted rgba(0,0,0,0.6); padding-bottom:4px; display:inline-block; min-width:220px }
  </style>
</head>
<body>
  <div class="page-bg">
    <div class="watermark no-print">HOPEFUL FUTURE PRIMARY SCHOOL</div>
    <div class="container py-3 position-relative">
    <div class="school-nav no-print d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 style="color:#fff; margin:0; font-weight:700;">HOPEFUL FUTURE PRIMARY SCHOOL</h2>
        <div class="school-motto">Nurturing Minds, Shaping Futures</div>
      </div>
      <div class="text-end meta">
        <div>Location: Entebbe - Wakiso</div>
        <div>Email: info@hopefulfutureps.org</div>
        <div>P.O. Box 123, Entebbe</div>
        <div>Contacts: 0744137174 / 0768936641</div>
      </div>
    </div>

    <div class="card mb-3 p-3 no-print">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="mb-0">{{ pupil.first_name }} {% if pupil.middle_name %}{{ pupil.middle_name }} {% endif %}{{ pupil.last_name }}</h5>
          <div class="text-muted">Admission No: {{ pupil.admission_number if pupil.admission_number else 'N/A' }}</div>
          <div class="text-muted">Class: {{ pupil.class_name }} | Stream: {{ pupil.stream_name }} | Year: {{ exams[0].year if exams else '' }}</div>
        </div>
        <div class="col-md-4 text-end">
          <div>Class Teacher: {% if class_teacher %}{{ class_teacher.first_name }} {{ class_teacher.last_name }}{% else %}N/A{% endif %}</div>
        </div>
      </div>
    </div>

    {% for ex in exams %}
      <div class="report-card">
        <div class="report-header">
          <div>
            <h5 class="mb-0">{{ ex.name }} - Term {{ ex.term }} / {{ ex.year }}</h5>
            <small class="text-muted">Pupil: {{ pupil.first_name }} {{ pupil.last_name }}</small>
          </div>
          <div class="text-end">
            {% set rep = (reports | selectattr('exam_id','equalto', ex.id) | list).0 if reports else None %}
            {% set stats = exam_stats.get(ex.id) if exam_stats else None %}
            {% if rep %}
              <div><strong>Total:</strong> {{ rep.total_score }} / {{ (subjects|length * 100) }}</div>
              <div><strong>Avg:</strong> {{ rep.average_score }}</div>
              <div><strong>Grade:</strong>
                {% if rep.grade %}
                  {% set g = rep.grade %}
                  <span class="badge-grade grade-{{ g }}">{{ g }}</span>
                {% else %}
                  -
                {% endif %}
              </div>
            {% else %}
              <div><strong>Total:</strong> -</div>
              <div><strong>Avg:</strong> -</div>
              <div><strong>Grade:</strong> -</div>
            {% endif %}
            {% if stats and stats.stream_position %}
              <div><span class="pos-badge">Stream: {{ stats.stream_position }} / {{ stats.stream_total }}</span></div>
            {% endif %}
          </div>
        </div>

        <table class="table table-sm report-table">
          <thead>
            <tr>
              <th>Subject</th>
              <th class="text-end">Score (out of 100)</th>
              <th class="text-end">Grade</th>
            </tr>
          </thead>
          <tbody>
            {% set marks = marks_by_exam.get(ex.id, []) %}
            {% for subj in subjects %}
              {% set m = (marks | selectattr('subject_id','equalto',subj.id) | list).0 if marks else None %}
              <tr>
                <td>{{ subj.name }}</td>
                <td class="text-end">
                  {% if m %}
                    {{ m.score }} / 100
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if m %}
                    {% set sc = m.score %}
                    {% if sc >= 80 %}
                      <span class="badge-grade grade-A">A</span>
                    {% elif sc >= 70 %}
                      <span class="badge-grade grade-B">B</span>
                    {% elif sc >= 60 %}
                      <span class="badge-grade grade-C">C</span>
                    {% elif sc >= 50 %}
                      <span class="badge-grade grade-D">D</span>
                    {% else %}
                      <span class="badge-grade grade-E">E</span>
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            <tr>
              <td><strong>Total</strong></td>
              <td class="text-end"><strong>{% if rep %}{{ rep.total_score }}{% else %}-{% endif %} / {{ (subjects|length * 100) }}</strong></td>
              <td class="text-end"><strong>{% if rep %}{{ rep.grade }}{% else %}-{% endif %}</strong></td>
            </tr>
          </tbody>
        </table>

        <div class="footer-print">Class teacher: {% if class_teacher %}<span class="dotted-line">{{ class_teacher.first_name }} {{ class_teacher.last_name }}</span>{% else %}<span class="dotted-line">____________________</span>{% endif %}</div>
      </div>
    {% endfor %}

    {% if combined %}
      <div class="report-card">
        <h5>Combined Summary</h5>
        {# raw combined total (sum of per-exam totals) and max possible #}
        {% set raw_total = (reports | map(attribute='total_score') | sum) if reports else 0 %}
        {% set raw_max = (subjects|length * 100 * (reports|length)) %}
        <p><strong>Combined Total (raw):</strong> {{ raw_total }} / {{ raw_max }}</p>
        <p><strong>Weighted Combined Average:</strong> {{ combined.combined_average }}</p>
        <p><strong>Weighted Combined Grade:</strong> <span class="badge-grade grade-{{ combined.combined_grade }}">{{ combined.combined_grade }}</span></p>
        {% if class_position %}
          <p><span class="pos-badge">Class Position: {{ class_position }} / {{ class_total }}</span></p>
        {% endif %}
        <div class="remark-box"><strong>Remark:</strong> {{ combined.general_remark }}</div>
        <div style="margin-top:12px">
          <strong>Overall Comment:</strong>
          <div class="dotted-line" style="display:inline-block; width:60%; margin-left:8px;">{% if combined.general_remark %}{{ combined.general_remark }}{% else %}______________________{% endif %}</div>
        </div>
      </div>
    {% endif %}

    <div class="school-footer no-print">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h6 style="color:#ffd54f;">HOPEFUL FUTURE PRIMARY SCHOOL</h6>
            <p style="margin:0;">Nurturing Minds, Shaping Futures â€” Inspiring excellence through caring and quality education.</p>
            <p style="margin:6px 0 0 0;">Location: Entebbe - Wakiso | P.O. Box 123, Entebbe</p>
          </div>
          <div class="col-md-3">
            <h6 style="color:#ffd54f;">Contact</h6>
            <p style="margin:0;">Email: <a href="mailto:info@hopefulfutureps.org">info@hopefulfutureps.org</a></p>
            <p style="margin:0;">0744137174 / 0768936641</p>
          </div>
          <div class="col-md-3 text-end">
            <p style="margin:0;">Website: <a href="#">www.hopefulfutureps.org</a></p>
            <p style="margin:0;">Follow us on social media</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
