<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mark Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root { --bs-body-font-size: 0.95rem; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
    .navbar-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-header-custom { background-color: #667eea; color: white; }
    .btn-check:checked + .btn { background-color: #28a745; border-color: #28a745; }
    .btn-check:not(:checked) + .btn { background-color: #dc3545; border-color: #dc3545; }
    .roster-table { width: 100%; }
    .roster-table thead th { background-color: #667eea; color: white; padding: 12px 8px; font-weight: 600; }
    .roster-table tbody tr { border-bottom: 1px solid #e9ecef; }
    .roster-table tbody tr:hover { background-color: #f5f5f5; }
    .roster-table td { padding: 12px 8px; }
    .pupil-name { font-weight: 500; }
    .checkbox-cell { text-align: center; }
    .btn-check + .btn-check-label { cursor: pointer; user-select: none; }
    .alert-toast { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .roster-table { font-size: 0.85rem; }
      .roster-table th, .roster-table td { padding: 8px 4px; }
      .btn { padding: 0.375rem 0.75rem; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Mark Attendance</span>
      <span class="navbar-text text-white">{{ teacher.first_name }} {{ teacher.last_name }}</span>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Date Picker Section -->
    <div class="card mb-4">
      <div class="card-header card-header-custom">
        <h5 class="mb-0">ðŸ“… Select Date & Mark Attendance</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="attendanceDate" class="form-label fw-bold">Attendance Date</label>
            <input type="date" id="attendanceDate" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Show For Stream</label>
            <select id="streamFilter" class="form-select">
              <option value="">All Streams</option>
              {% for s in all_streams %}
                <option value="{{ s.id }}">Stream {{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <button id="markAllPresentBtn" class="btn btn-success me-2">
              <i class="bi bi-check-circle"></i> Mark All Present
            </button>
            <button id="markAllAbsentBtn" class="btn btn-danger">
              <i class="bi bi-x-circle"></i> Mark All Absent
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pupils Table -->
    <div class="card">
      <div class="card-header card-header-custom">
        <h5 class="mb-0">ðŸ‘¥ Students (<span id="pupilCount">0</span>)</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table roster-table mb-0">
            <thead>
              <tr>
                <th style="width: 30%;">Student Name</th>
                <th style="width: 20%;">Stream</th>
                <th style="width: 25%;">Present</th>
                <th style="width: 25%;">Absent</th>
              </tr>
            </thead>
            <tbody id="pupilsTableBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="mt-4 d-flex gap-2">
      <button id="saveAttendanceBtn" class="btn btn-primary btn-lg">
        <i class="bi bi-check-lg"></i> Save Attendance
      </button>
      <button id="viewSummaryBtn" class="btn btn-info btn-lg" style="display: none;">
        <i class="bi bi-eye"></i> View Weekly Summary
      </button>
    </div>
  </div>

  <!-- Alert Container -->
  <div id="alertContainer"></div>

  <script>
    // Data from template
    const pupils = {{ pupils_json|safe }};
    const allStreams = {{ all_streams_json|safe }};
    const todayIso = new Date().toISOString().split('T')[0];
    
    // State
    let currentAttendance = {}; // { pupil_id: 'present'|'absent' }
    let selectedDate = todayIso;
    let selectedStream = '';

    // Initialize
    function init() {
      document.getElementById('attendanceDate').value = todayIso;
      document.getElementById('attendanceDate').addEventListener('change', (e) => {
        selectedDate = e.target.value;
      });
      document.getElementById('streamFilter').addEventListener('change', (e) => {
        selectedStream = e.target.value;
        renderTable();
      });
      document.getElementById('markAllPresentBtn').addEventListener('click', () => {
        getVisiblePupils().forEach(p => currentAttendance[p.id] = 'present');
        renderTable();
      });
      document.getElementById('markAllAbsentBtn').addEventListener('click', () => {
        getVisiblePupils().forEach(p => currentAttendance[p.id] = 'absent');
        renderTable();
      });
      document.getElementById('saveAttendanceBtn').addEventListener('click', saveAttendance);
      document.getElementById('viewSummaryBtn').addEventListener('click', viewSummary);
      renderTable();
    }

    function getVisiblePupils() {
      return pupils.filter(p => !selectedStream || p.stream_id == selectedStream);
    }

    function renderTable() {
      const visible = getVisiblePupils();
      const html = visible.map(p => {
        const status = currentAttendance[p.id] || '';
        return `
          <tr>
            <td class="pupil-name">${p.first_name} ${p.last_name}</td>
            <td>Stream ${p.stream_id}</td>
            <td class="checkbox-cell">
              <div class="form-check form-check-inline">
                <input class="form-check-input attendance-check" type="radio" name="attendance_${p.id}" id="present_${p.id}" value="present" ${status === 'present' ? 'checked' : ''} />
              </div>
            </td>
            <td class="checkbox-cell">
              <div class="form-check form-check-inline">
                <input class="form-check-input attendance-check" type="radio" name="attendance_${p.id}" id="absent_${p.id}" value="absent" ${status === 'absent' ? 'checked' : ''} />
              </div>
            </td>
          </tr>
        `;
      }).join('');
      document.getElementById('pupilsTableBody').innerHTML = html;
      document.getElementById('pupilCount').textContent = visible.length;

      // Add event listeners to radio buttons
      document.querySelectorAll('.attendance-check').forEach(input => {
        input.addEventListener('change', (e) => {
          const pupilId = parseInt(e.target.name.split('_')[1]);
          currentAttendance[pupilId] = e.target.value;
        });
      });
    }

    async function saveAttendance() {
      if (!selectedDate) {
        showAlert('warning', 'Please select a date first.');
        return;
      }
      if (Object.keys(currentAttendance).length === 0) {
        showAlert('warning', 'Please mark attendance for at least one student.');
        return;
      }

      const entries = Object.entries(currentAttendance).map(([pupilId, status]) => {
        const p = pupils.find(x => x.id == pupilId);
        return {
          pupil_id: parseInt(pupilId),
          class_id: p.class_id,
          stream_id: p.stream_id,
          date: selectedDate,
          status: status,
          reason: ''
        };
      });

      const payload = { class_id: null, entries: entries, days: 6 };

      try {
        showAlert('info', 'Saving attendance...');
        const resp = await fetch("{{ url_for('teacher_routes.attendance_view') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (resp.ok) {
          showAlert('success', 'âœ“ Attendance saved successfully!');
          document.getElementById('viewSummaryBtn').style.display = 'inline-block';
          // Clear current attendance for next entry
          currentAttendance = {};
          renderTable();
        } else {
          showAlert('danger', 'âœ— Failed to save attendance: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        showAlert('danger', 'âœ— Error: ' + err.message);
      }
    }

    function viewSummary() {
      const classIds = [...new Set(pupils.map(p => p.class_id))];
      const start = selectedDate.substring(0, 10); // YYYY-MM-DD
      if (classIds.length === 1) {
        window.location.href = `{{ url_for('teacher_routes.attendance_summary') }}?class_id=${classIds[0]}&start=${start}&period=week`;
      } else {
        showAlert('info', 'Multi-class summary not yet available. Please select a specific class.');
      }
    }

    function showAlert(type, message) {
      const alertId = 'alert-' + Date.now();
      const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show alert-toast" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      document.getElementById('alertContainer').insertAdjacentHTML('beforeend', alertHtml);
      const alertEl = document.getElementById(alertId);
      setTimeout(() => {
        if (alertEl) {
          const bsAlert = new bootstrap.Alert(alertEl);
          bsAlert.close();
        }
      }, 4000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
