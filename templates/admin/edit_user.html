<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin, Edit User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      padding-top: 70px;
      padding-bottom: 120px;
      background-color: #f1f8e9;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar { background-color: #4a148c; }
    .navbar-brand { color: #fff !important; }
    .back-btn {
      background-color: #d32f2f; color: #fff; border: none; font-size: 0.85rem; padding: 4px 10px;
    }
    .back-btn:hover { background-color: #b71c1c; }
    .form-label { font-weight: 500; }
    .input-group-text { background-color: #e0e0e0; border: none; }
    .form-control { font-size: 0.95rem; padding: 0.5rem 0.75rem; }
    .eye-toggle-wrapper {
      background-color: #e0e0e0; border: none; padding: 0 0.75rem; display: flex;
      align-items: center; cursor: pointer;
    }
    .eye-toggle-icon { color: #00897b; font-size: 1.1rem; }
    .eye-toggle-icon.visible { color: #ef6c00; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar fixed-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="#" style="display:flex; align-items:center; gap:8px;"><img src="/static/logo.png" alt="Logo" style="height:36px; width:auto;"><span>Edit User</span></a>
      <div class="ms-auto">
        <a href="{{ url_for('user_routes.admin_dashboard') }}" class="btn back-btn">
          <i class="bi bi-box-arrow-left me-1"></i>Back
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container my-4">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="post">
          <div class="mb-3">
            <label for="first_name" class="form-label">First Name</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}" required />
            </div>
          </div>

          <div class="mb-3">
            <label for="last_name" class="form-label">Last Name</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}" required />
            </div>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required />
            </div>
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">New Password (optional)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock"></i></span>
              <input type="password" class="form-control" id="password" name="password" />
              <span class="eye-toggle-wrapper" onclick="togglePassword()">
                <i id="eyeToggle" class="bi bi-eye-slash eye-toggle-icon"></i>
              </span>
            </div>
          </div>

          <div class="mb-3">
            <label for="role" class="form-label">Role</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
              <select class="form-select" id="role" name="role" required onchange="handleRoleChange()">
                {% for role in roles %}
                  <option value="{{ role.role_name }}" {% if role.id == user.role_id %}selected{% endif %}>{{ role.role_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-save me-2"></i>Update User
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  {% include 'footer.html' %}

  <script>
    function togglePassword() {
      const input = document.getElementById("password");
      const icon = document.getElementById("eyeToggle");
      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("bi-eye-slash");
        icon.classList.add("bi-eye", "visible");
      } else {
        input.type = "password";
        icon.classList.remove("bi-eye", "visible");
        icon.classList.add("bi-eye-slash");
      }
    }

    function handleRoleChange() {
      const roleSelect = document.getElementById("role");
      const passwordInput = document.getElementById("password");
      // Disable password field if user is Admin
      if (roleSelect.value === "Admin") {
        passwordInput.disabled = true;
        passwordInput.placeholder = "Password cannot be changed for Admin";
      } else {
        passwordInput.disabled = false;
        passwordInput.placeholder = "";
      }
    }

    // Run once on page load
    window.onload = handleRoleChange;

    // Auto-dismiss flash alerts after 2 seconds or when the close (x) is clicked
    (function initAutoDismissAlerts(){
      const ALERT_TIMEOUT = 2000;
      function setupAlert(alert){
        if (!alert || !alert.parentNode) return;
        const btn = alert.querySelector('.btn-close');
        if (btn) btn.addEventListener('click', ()=>{ try{ alert.remove(); }catch(e){ if(alert.parentNode) alert.parentNode.removeChild(alert); } });

        alert.addEventListener('close.bs.alert', ()=>{ clearTimeout(alert._autoDismissTimer); });
        alert.addEventListener('closed.bs.alert', ()=>{ clearTimeout(alert._autoDismissTimer); });

        alert._autoDismissTimer = setTimeout(()=>{
          try {
            if (window.bootstrap && bootstrap.Alert) {
              const inst = bootstrap.Alert.getOrCreateInstance(alert);
              inst.close();
            } else {
              alert.classList.remove('show');
              setTimeout(()=>{ if (alert.parentNode) alert.parentNode.removeChild(alert); }, 150);
            }
          } catch(e) { if (alert.parentNode) alert.parentNode.removeChild(alert); }
        }, ALERT_TIMEOUT);
      }

      document.querySelectorAll('.alert').forEach(setupAlert);
      const mo = new MutationObserver(muts=>{
        muts.forEach(m=>{ m.addedNodes.forEach(n=>{ if (n.nodeType===1 && n.matches && n.matches('.alert')) setupAlert(n); }); });
      });
      mo.observe(document.body, { childList: true, subtree: true });
    })();
  </script>
</body>
</html>
