<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>System Settings - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{
      --primary:#4a148c;
      --muted:#6c757d;
      --bg:#f8f9fa;
      --sidebar-bg: #ffffff;
      --accent: #00796b;
    }


    body{
      font-family: 'Segoe UI', sans-serif;
      background:var(--bg);
      margin:0; padding:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .navbar{background:var(--primary); height:60px}
    .navbar .navbar-brand{color:#fff !important; display:flex; align-items:center; gap:10px}
    .app-shell{display:flex; flex:1; min-height: calc(100vh - 60px);}
    .sidebar{width:140px; background:var(--sidebar-bg); border-right:1px solid #e9ecef; padding:10px 8px; position:sticky; top:60px; height:calc(100vh - 60px - 24px); overflow-y:auto}
    .sidebar .logo{display:flex; align-items:center; gap:10px; padding:8px 6px; margin-bottom:18px}
    .sidebar .logo img{height:42px; width:auto}
    .sidebar .nav-btn{
      display:flex; align-items:center; gap:8px; width:100%; padding:6px 8px; margin-bottom:8px;
      border-radius:6px; border: 1px solid rgba(0,0,0,0.04); background:transparent; color:var(--muted);
      text-align:left; box-shadow: 0 1px 4px rgba(16,24,40,0.03); font-weight:600; cursor:pointer;
      transition: all 0.15s ease; font-size:0.82rem;
    }
    .sidebar .nav-btn i{font-size:18px}
    .sidebar .nav-btn i{font-size:14px}
    .sidebar .nav-btn:hover{transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06);}
    .sidebar .nav-btn.active{box-shadow:0 4px 12px rgba(0,0,0,0.12); transform: translateY(-1px); border-color: var(--accent);}

    /* Color variants */
    .nav-btn.security{ background: linear-gradient(90deg,#e8f5e9 0%,#c8e6c9 100%); color:#1b5e20 }
    .nav-btn.calendar{ background: linear-gradient(90deg,#e3f2fd 0%,#bbdefb 100%); color:#0d47a1 }
    .nav-btn.payments{ background: linear-gradient(90deg,#fff3e0 0%,#ffe0b2 100%); color:#e65100 }
    .nav-btn.backup{ background: linear-gradient(90deg,#f3e5f5 0%,#e1bee7 100%); color:#4a148c }
    .nav-btn.theme{ background: linear-gradient(90deg,#fff9c4 0%,#fff59d 100%); color:#f57f17 }

    .content{flex:1; padding:26px; overflow-y:auto;}
    .settings-card{background:#fff; border-radius:10px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .settings-list .setting-item{display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px dashed #eee}
    .settings-list .setting-item:last-child{border-bottom:0}

    @media (max-width:768px){
      .sidebar{width:160px; padding:12px 8px}
      .sidebar .nav-btn{padding:10px 8px; font-size:0.9rem}
    }
    /* Compact sidebar & card tweaks to match backup_maintenance adjustments */
    .sidebar{width:180px; padding:14px 10px}
    .sidebar .logo img{height:34px}
    .sidebar .nav-btn{padding:8px 10px; font-size:0.88rem; border-radius:6px}
    .content{padding:18px}
    .settings-card{padding:14px}

    /* iframe used when embedding other admin pages into the main-content area */
    .embedded-frame {
      width: 100%;
      border: none;
      min-height: 60vh;
      height: calc(100vh - 180px);
    }

    /* Wrapper to constrain embedded content and provide a small horizontal scrollbar */
    .embedded-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 220px);
      padding: 6px 2px;
      border: 1px solid #eef2ff;
      border-radius: 8px;
      background: #fff;
    }

    /* Scale down full-page embeds so their layout fits inside the right card */
    .embedded-frame.compact-embed {
      transform: scale(0.86);
      transform-origin: 0 0;
      width: 116%; /* compensate for scaling */
      height: calc((100vh - 220px) / 0.86);
      box-shadow: none;
    }

    /* Small horizontal scrollbar styling */
    .embedded-wrapper::-webkit-scrollbar { height: 8px; }
    .embedded-wrapper::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }

    @media (max-width: 768px) {
      /* On small screens reduce the scale so embedded content is readable and fits */
      .embedded-frame.compact-embed { transform: scale(0.98); width: 102%; height: calc((100vh - 180px) / 0.98); }
      .embedded-wrapper { max-height: calc(100vh - 160px); }
      /* Keep the sidebar vertical on mobile (stacked buttons) instead of a horizontal strip */
      .sidebar{width:100%; display:block; padding:10px 8px; border-right:none; border-bottom:1px solid #e9ecef}
      .sidebar .nav-btn{display:flex; width:100%; white-space:normal; margin-bottom:8px}
    }

    @media (max-width:768px){
      /* On narrow screens keep sidebar buttons stacked vertically */
      .sidebar{width:100%; display:block; padding:8px; border-right:none; border-bottom:1px solid #e9ecef}
      .sidebar .nav-btn{display:flex; width:100%; white-space:normal; padding:8px 10px; font-size:0.9rem; margin-bottom:8px}
      h4{font-size:1rem}
      .settings-card{padding:12px}
    }

      /* Auto-dismiss backend flash alerts injected into embedded content */
      .embedded-alert { transition: opacity 0.35s ease, transform 0.35s ease; }
      .embedded-alert.fade-out { opacity: 0 !important; transform: translateY(-6px); }
  </style>
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-lg">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="#" style="display:flex; align-items:center; gap:10px;">
        <img src="/static/logo.png" alt="Logo" style="height:36px; width:auto">
        <span style="color:#fff">System Settings</span>
      </a>
      <div class="ms-auto">
        <a href="{{ url_for('admin_routes.dashboard') }}" class="btn" style="background:#ffffff;color:#dc3545;border:none;padding:6px 10px;border-radius:6px; display:flex; align-items:center; gap:8px">
          <i class="bi bi-box-arrow-left" style="color:#dc3545"></i> Back
        </a>
      </div>
    </div>
  </nav>

  <div class="app-shell" style="padding-top:60px">
    <aside class="sidebar">
      <div class="logo"><img src="/static/logo.png" alt="icon"><strong>Admin</strong></div>

      <button class="nav-btn security" type="button" data-content="security"><i class="bi bi-shield-lock-fill"></i> Session &amp; Security</button>
      <button class="nav-btn calendar" type="button" data-content="calendar"><i class="bi bi-calendar3"></i> Academic Calendar</button>
      <button class="nav-btn payments" type="button" data-content="payments"><i class="bi bi-credit-card-2-front-fill"></i> Payment &amp; Receipts</button>
      <button class="nav-btn backup" type="button" data-content="backup"><i class="bi bi-hdd-fill"></i> Backup &amp; Maintenance</button>
      <button class="nav-btn theme" type="button" data-content="theme"><i class="bi bi-brightness-high-fill"></i> Light / Dark Theme</button>

      <div style="height:10px"></div>
      <small class="text-muted">(Buttons load content in place — no page reload except Backup & Maintenance)</small>
    </aside>

    <main class="content" id="main-content">
      <div class="settings-card" id="default-content">
        <h4>Welcome to System Settings</h4>
        <p>Select an option from the sidebar to load its content here.</p>
      </div>
    </main>
  </div>

  {% include 'footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const contentMap = {
      security: `
        <div class="settings-card">
          <h4>Session & Security</h4>
          <div class="settings-list">
            <div class="setting-item"><span>Password Expiration</span><span>90 days</span></div>
            <div class="setting-item"><span>Two-Factor Authentication</span><span>Enabled</span></div>
          </div>
        </div>
      `,
      calendar: `
        <div class="settings-card">
          <h4>Academic Calendar</h4>
          <p>Here you can manage semesters, holidays, and events.</p>
        </div>
      `,
      payments: `
        <div class="settings-card">
          <h4>Payments & Receipts</h4>
          <p>Manage transactions, receipts, and financial reports here.</p>
        </div>
      `,
      theme: `
        <div class="settings-card">
          <h4>Light / Dark Theme</h4>
          <button class="btn btn-dark me-2" onclick="document.body.classList.add('bg-dark');document.body.style.color='#fff';">Dark</button>
          <button class="btn btn-light" onclick="document.body.classList.remove('bg-dark');document.body.style.color='';">Light</button>
        </div>
      `
      ,
      backup: `
        <div class="settings-card">
          <h4>Backup & Maintenance</h4>
          <p>The Backup & Maintenance page is embedded below. You can trigger backups, download, or delete existing backups. Actions will be performed without leaving this settings area.</p>
          <div id="embedded-backup-wrapper" class="embedded-wrapper" style="min-height:320px;">
            <div id="embedded-backup-container">Loading backup UI…</div>
          </div>
        </div>
      `
    };

    const buttons = document.querySelectorAll('.nav-btn');
    const mainContent = document.getElementById('main-content');

    function setActiveButton(activeBtn){
      buttons.forEach(btn => btn.classList.remove('active'));
      activeBtn.classList.add('active');
    }

    buttons.forEach(btn => {
      // Only intercept buttons that have data-content
      if(btn.dataset.content){
        btn.addEventListener('click', () => {
          const key = btn.dataset.content;
          mainContent.innerHTML = contentMap[key] || '<p>Content not found.</p>';
          setActiveButton(btn);
          // If it's the backup panel, fetch and embed the partial page instead of an iframe
          if (key === 'backup') {
            loadEmbeddedBackup();
          }
        });
      }
    });

    // Load default content and set first non-backup button as active
    window.addEventListener('DOMContentLoaded', () => {
      const firstBtn = Array.from(buttons).find(b=>b.dataset.content);
      if(firstBtn) firstBtn.click();
      // Also attempt to initialize embedded frames if present on DOMContentLoaded
      setTimeout(initEmbeddedIframes, 200);
    });

    function initEmbeddedIframes(){
      try {
        const iframes = document.querySelectorAll('.embedded-frame');
        iframes.forEach(iframe => {
          // avoid attaching multiple listeners
          if (iframe._embedInitialized) return;
          iframe._embedInitialized = true;

          function setup(){
            try {
              const doc = iframe.contentDocument || iframe.contentWindow.document;
              if (!doc) return;
              // hide the embedded page's navbar and footer to avoid duplicate chrome
              const header = doc.querySelector('.navbar-fixed') || doc.querySelector('.navbar');
              if (header) header.style.display = 'none';
              const footer = doc.querySelector('footer') || doc.querySelector('.site-footer');
              if (footer) footer.style.display = 'none';
              // remove top padding applied for fixed navbars inside the embedded page
              doc.body.style.paddingTop = '0px';

              // compute inner content height and resize iframe
              const mainInner = doc.querySelector('.main-content') || doc.body;
              const h = mainInner.scrollHeight || doc.body.scrollHeight;
              iframe.style.height = (h + 24) + 'px';
              // slightly scale so the layout fits nicely
              iframe.style.transform = 'scale(0.95)';
              iframe.style.transformOrigin = '0 0';
              iframe.style.width = '105%';
            } catch(e){
              // ignore cross-origin or other timing errors
              console.warn('Could not initialize embedded iframe', e);
            }
          }

          // run on load and also shortly after to allow scripts to render
          iframe.addEventListener('load', () => setTimeout(setup, 60));
          setTimeout(setup, 300);
        });
      } catch(e){ console.warn('initEmbeddedIframes error', e); }
    }

    // Schedule auto-dismiss for backend flash alerts inside an embedded container
    function scheduleEmbeddedAlerts(container){
      try {
        if (!container) return;
        function schedule(el){
          if (!el) return;
          el.classList.add('embedded-alert');
          setTimeout(function(){
            el.classList.add('fade-out');
            setTimeout(function(){ try { el.remove(); } catch(e){} }, 360);
          }, 2000);
        }
        // schedule existing alerts
        container.querySelectorAll && container.querySelectorAll('.alert').forEach(schedule);
        // observe for new alerts
        if (window.MutationObserver){
          const mo = new MutationObserver(function(muts){
            muts.forEach(function(m){
              m.addedNodes && m.addedNodes.forEach(function(node){
                if (!(node instanceof HTMLElement)) return;
                if (node.classList && node.classList.contains('alert')) schedule(node);
                node.querySelectorAll && node.querySelectorAll('.alert').forEach(schedule);
              });
            });
          });
          mo.observe(container, { childList: true, subtree: true });
        }
      } catch(e){ /* ignore */ }
    }

    // Fetch the backup page and inject only its main content + styles and scripts into this card.
    async function loadEmbeddedBackup(){
      const container = document.getElementById('embedded-backup-container');
      if (!container) return;
      container.innerHTML = '<p class="text-muted">Loading backup UI…</p>';
      try {
        const resp = await fetch('{{ url_for("admin_routes.backup_maintenance") }}', { cache: 'no-store' });
        const text = await resp.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');

        // Inject styles from fetched document head (avoid duplicates)
        const headStyles = doc.querySelectorAll('head style, head link[rel="stylesheet"]');
        headStyles.forEach(node => {
          try {
            // simple dedupe by textContent or href
            if (node.tagName.toLowerCase() === 'style'){
              const id = 'embedded-style-' + btoa(node.textContent || '').slice(0,8);
              if (!document.getElementById(id)){
                const s = document.createElement('style'); s.id = id; s.textContent = node.textContent; document.head.appendChild(s);
              }
            } else if (node.tagName.toLowerCase() === 'link'){
              const href = node.getAttribute('href');
              if (href && !document.querySelector('link[href="' + href + '"]')){
                const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = href; document.head.appendChild(l);
              }
            }
          } catch(e){/* ignore */}
        });

        // Extract the main content area from fetched doc
        const fetchedMain = doc.querySelector('.main-content') || doc.querySelector('main') || doc.body;
        const inner = fetchedMain ? fetchedMain.innerHTML : text;
        // Put it inside a wrapper so local styles apply
        container.innerHTML = `<div class="embedded-internal">${inner}</div>`;

        // Execute any inline scripts found in the fetched document (in order)
        const scripts = doc.querySelectorAll('script');
        for (const s of scripts){
          try {
            if (s.src){
              // external script: add to document if not present
              if (!document.querySelector('script[src="' + s.src + '"]')){
                const ext = document.createElement('script'); ext.src = s.src; ext.async = false; document.body.appendChild(ext);
                await new Promise((res, rej) => { ext.onload = res; ext.onerror = res; });
              }
            } else {
              // inline script: execute by creating a new script element
              const inline = document.createElement('script'); inline.text = s.textContent; document.body.appendChild(inline);
            }
          } catch(e){ console.warn('Error executing embedded script', e); }
        }

        // After scripts executed, schedule auto-dismiss for backend alerts and try to call loadBackupHistory()
        try { scheduleEmbeddedAlerts(container); } catch(e){}
        if (typeof loadBackupHistory === 'function'){
          try { loadBackupHistory(); } catch(e){}
        }

      } catch(e){
        console.error('Failed to load embedded backup content', e);
        container.innerHTML = `<p class="text-danger">Failed to load backup UI: ${e.message}</p>`;
      }
    }
  </script>
</body>
</html>
