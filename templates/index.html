<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Welcome | School Management System</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#00796b">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.svg">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body {
      background: linear-gradient(to right, #e0f7fa, #f1f8e9);
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    /* Prevent horizontal scrolling on small screens while keeping layout intact */
    html, body { overflow-x: hidden; }
    .navbar {
      background-color: #00796b !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 60px;
    }
    .navbar-brand {
      color: #ffffff !important;
    }
    /* ✅ Styled About Me button */
    .about-btn {
      background-color: #d32f2f;
      color: #ffffff;
      font-weight: 500;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.3s ease;
    }
    .about-btn i {
      color: #ffffff;
      font-size: 1.1rem;
      margin-right: 6px;
    }
    .about-btn:hover {
      background-color: #b71c1c;
      color: #ffffff;
    }
    main {
      flex: 1;
      width: 100%;
      padding-top: 70px;
      padding-bottom: 90px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .login-box {
      width: 100%;
      max-width: 420px;
      height: auto;
      background: linear-gradient(to bottom right, #ffffff, #f9fbe7);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border: 1px solid #c8e6c9;
      display: flex;
      flex-direction: column;
      margin: 20px auto;
      box-sizing: border-box;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      overflow-x: hidden; /* ensure internal content cannot force horizontal scroll */
    }
    .login-content {
      padding: 30px;
      overflow-y: auto;
      flex-grow: 1;
      scroll-padding-bottom: 20px;
    }
    /* ensure input groups don't force the layout wider than the container on small screens */
    .input-group { min-width: 0; }
    .form-control {
      border: 2px solid transparent;
      background-clip: padding-box;
      background-image: linear-gradient(#fff, #fff), linear-gradient(to right, #ff6f61, #ffca28);
      background-origin: border-box;
      background-clip: content-box, border-box;
      transition: box-shadow 0.3s ease;
    }
    .form-control:focus {
      box-shadow: 0 0 10px rgba(255, 105, 135, 0.5);
      border-color: #ff6f61;
    }
    .input-group-text {
      background-color: #ffe0b2;
      border: none;
    }
    .toggle-password {
      cursor: pointer;
    }
    .btn-login {
      background-color: #d32f2f;
      color: #fff;
      font-weight: bold;
      border: none;
      transition: background-color 0.3s ease;
    }
    .btn-login:hover {
      background-color: #b71c1c;
    }
    .form-check-label {
      font-size: 0.9rem;
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: #2196f3;
    }
    .welcome-message h2 {
      font-size: 1.5rem;
    }
    footer {
      height: 70px;
      background: linear-gradient(to right, #4a148c, #1a237e);
      box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
      color: #fff;
    }
    @media (max-width: 576px) {
      .login-box {
        margin: 0 15px 40px 15px;
      }
      .login-content {
        padding: 20px;
      }
      .welcome-message h2 {
        font-size: 1.25rem;
      }
      .navbar-brand {
        font-size: 1rem;
      }
      .about-btn {
        font-size: 0.8rem;
        padding: 5px 10px;
      }
    }
  </style>
</head>
<body>
    <!-- Fixed Navbar -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold d-flex align-items-center" href="#" style="gap:10px;">
        <img src="/static/logo.png" alt="Logo" style="height:40px; width:auto;" />
        <span>School Manager</span>
      </a>
      <div class="ms-auto">
        <!-- ✅ Styled About Me button -->
        <a href="/developer" class="about-btn">
          <i class="bi bi-person-circle"></i> About Me
        </a>
      </div>
    </div>
  </nav>

  <main>
    <!-- Welcome Message -->
    <div class="welcome-message text-center my-4 px-3">
      <h2 class="fw-bold text-primary">HOPEFUL FUTURE PRIMARY SCHOOL - Management System</h2>
      <p class="text-muted">Nurturing Minds, Shaping Future</p>
    </div>

    <!-- Login Box -->
    <div class="login-box">
      <div class="login-content px-3">
        <h4 class="text-center mb-4">Login to Your Account</h4>
        <!-- Alert container for inline messages -->
        <div id="pageAlert" class="mb-3" aria-live="polite"></div>

        <form method="POST" action="/login" onsubmit="showSpinner(event)">
          <div class="mb-3">
            <label for="email" class="form-label">Email address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
              <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" required>
            </div>
              <!-- small inline checker (hidden by default) -->
              <div id="emailCheck" class="email-check-indicator" style="display:none; margin-top:6px;">
                <div class="spinner-border spinner-border-sm text-white" role="status" style="width:1rem;height:1rem;">
                  <span class="visually-hidden">Checking...</span>
                </div>
                <small class="text-danger" style="color:#d32f2f;">Checking account…</small>
              </div>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
              <input type="password" class="form-control" id="password" name="password" placeholder="Enter password" required>
              <span class="input-group-text toggle-password" onclick="togglePassword()">
                <i class="bi bi-eye-fill" id="toggleIcon"></i>
              </span>
            </div>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="remember" name="remember">
            <label class="form-check-label" for="remember">Remember me</label>
          </div>
          <div class="d-grid mb-3">
            <button type="submit" class="btn btn-login">
              <i class="bi bi-box-arrow-in-right me-2"></i>Login
            </button>
          </div>
          <div class="text-center">
            Forgot password? Click <a href="/reset_password" id="forgotLink" class="text-decoration-none">here to reset it!!</a>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Spinner Overlay -->
  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Logging in...</span>
    </div>
  </div>
    {% include 'footer.html' %}
  <script>
    function togglePassword() {
      const passwordInput = document.getElementById("password");
      const toggleIcon = document.getElementById("toggleIcon");
      const isPassword = passwordInput.type === "password";
      passwordInput.type = isPassword ? "text" : "password";
      toggleIcon.classList.toggle("bi-eye-fill");
      toggleIcon.classList.toggle("bi-eye-slash-fill");
    }

    function showSpinner(event) {
      event.preventDefault();
      document.getElementById("spinnerOverlay").style.display = "flex";
      setTimeout(() => {
        event.target.submit();
      }, 100); // ⏱️ updated to 1 second
    }

    // Show an inline bootstrap-style alert in the page (dismissible, auto-hide)
    function showPageAlert(message, type = 'danger') {
      try {
        const container = document.getElementById('pageAlert');
        if (!container) return;
        // sanitize minimal HTML by escaping user-controlled values (message comes from our code)
        const alertHtml = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" aria-label="Close"></button>
          </div>`;
        container.innerHTML = alertHtml;
        const alertEl = container.querySelector('.alert');
        const closeBtn = alertEl.querySelector('.btn-close');
        closeBtn.addEventListener('click', () => {
          // fade out then remove
          alertEl.classList.remove('show');
          alertEl.classList.add('hide');
          setTimeout(() => { container.innerHTML = ''; }, 220);
        });
        // auto-dismiss after 6 seconds
        setTimeout(() => {
          if (container.innerHTML) closeBtn.click();
        }, 6000);
      } catch (e) { console.warn('Failed to show inline alert', e); }
    }

    // Show an inline error inside the email input (placeholder + invalid feedback)
    function showEmailInlineError(_message, duration = 5000) {
      // Only show the short placeholder 'Email required' inside the email input.
      try {
        const input = document.getElementById('email');
        if (!input) return;

        // store original placeholder so we can restore later
        if (!input.dataset._origPlaceholder) input.dataset._origPlaceholder = input.placeholder || '';

        // Clear value (so placeholder is visible) and set placeholder to the short message
        input.value = '';
        input.placeholder = 'Email required';

        // add bootstrap invalid class for visual cue (red border)
        input.classList.add('is-invalid');

        // focus so user can type immediately
        input.focus();

        // remove invalid state when user starts typing
        const onInput = function(){
          input.classList.remove('is-invalid');
          input.placeholder = input.dataset._origPlaceholder || '';
          input.removeEventListener('input', onInput);
        };
        input.addEventListener('input', onInput);

        // auto-clear after duration if user does nothing
        setTimeout(() => {
          try {
            input.classList.remove('is-invalid');
            input.placeholder = input.dataset._origPlaceholder || '';
          } catch(e) {}
        }, duration);
      } catch (e) { console.warn('showEmailInlineError failed', e); }
    }

    // Small checking indicator controls
    function showEmailChecking() {
      try {
        const el = document.getElementById('emailCheck');
        if (!el) return;
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.gap = '8px';
      } catch(e) { console.warn(e); }
    }
    function hideEmailChecking() {
      try {
        const el = document.getElementById('emailCheck');
        if (!el) return;
        el.style.display = 'none';
      } catch(e) { console.warn(e); }
    }

    // Require email before allowing navigation to reset password
    document.addEventListener('DOMContentLoaded', function(){
      const forgot = document.getElementById('forgotLink');
      const emailInput = document.getElementById('email');
      if (forgot){
        forgot.addEventListener('click', async function(e){
          e.preventDefault();
          const email = (emailInput && emailInput.value) ? emailInput.value.trim() : '';
          if (!email){
            // show inline error inside the email input and focus
            showEmailInlineError();
            return;
          }
          // optional: basic email format check
          const re = /^\S+@\S+\.\S+$/;
          if (!re.test(email)){
            showEmailInlineError();
            return;
          }

          // Check with server whether the email exists before redirecting
          try {
            showEmailChecking();
            const start = Date.now();
            const checkUrl = '/api/check-email?email=' + encodeURIComponent(email);
            const resp = await fetch(checkUrl, { method: 'GET', credentials: 'same-origin' });
            const elapsed = Date.now() - start;
            // keep indicator visible at least 2000ms so user sees the check (mobile-friendly)
            const minVisible = 2000;
            const wait = Math.max(0, minVisible - elapsed);
            if (!resp.ok) {
              await new Promise(r => setTimeout(r, wait));
              hideEmailChecking();
              showPageAlert('Server error verifying email. Please try again later.');
              return;
            }
            const data = await resp.json();
            await new Promise(r => setTimeout(r, wait));
            hideEmailChecking();
            if (!data.exists) {
              // show friendly inline page alert and focus input
              showPageAlert('No account found for that email address.', 'danger');
              if (emailInput) { emailInput.focus(); }
              return;
            }

            // navigate to reset page with email prefilled via querystring
            const href = forgot.getAttribute('href') || '/reset_password';
            window.location.href = href + '?email=' + encodeURIComponent(email);
          } catch (err) {
            console.warn('Failed to verify email', err);
            hideEmailChecking();
            showPageAlert('Network error verifying email. Please try again.');
          }
        });
      }
    });
  </script>

  <script>
    // Register service worker for PWA with automatic update checking
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('ServiceWorker registered with scope:', reg.scope);

            // Check for updates every 1 hour
            setInterval(() => {
              reg.update().catch(err => console.warn('Update check failed:', err));
            }, 3600000); // 1 hour in milliseconds

            // Listen for service worker updates
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker is ready, show update notification
                  const updateMsg = document.createElement('div');
                  updateMsg.id = 'update-notification';
                  updateMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #4CAF50, #45a049);
                    color: white;
                    padding: 16px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 10000;
                    font-weight: 600;
                    max-width: 90%;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                  `;
                  updateMsg.innerHTML = `
                    <i class="bi bi-arrow-clockwise" style="font-size: 1.2rem;"></i>
                    <span>New version available!</span>
                    <button onclick="location.reload()" style="
                      background: white;
                      color: #4CAF50;
                      border: none;
                      padding: 6px 12px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-weight: 600;
                      font-size: 0.9rem;
                    ">Reload</button>
                  `;
                  document.body.insertBefore(updateMsg, document.body.firstChild);

                  // Auto-remove notification after 10 seconds if not clicked
                  setTimeout(() => {
                    if (updateMsg.parentNode) updateMsg.remove();
                  }, 10000);
                }
              });
            });
          })
          .catch(err => console.warn('ServiceWorker registration failed:', err));
      });

      // Listen for messages from service worker
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.onmessage = (event) => {
          if (event.data.type === 'SERVICE_WORKER_UPDATED') {
            console.log('Service worker updated to version:', event.data.version);
          }
        };
      }
    }
  </script>

  <script>
    // PWA Install Prompt Handler
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (event) => {
      event.preventDefault();
      deferredPrompt = event;
      showInstallPrompt();
    });

    function showInstallPrompt() {
      const installBanner = document.createElement('div');
      installBanner.id = 'pwa-install-banner';
      installBanner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #2196F3, #1976D2);
        color: white;
        padding: 16px 20px;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        flex-wrap: wrap;
      `;
      installBanner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 200px;">
          <i class="bi bi-download" style="font-size: 1.3rem;"></i>
          <div>
            <strong style="display: block; font-size: 1rem;">Install App</strong>
            <small style="display: block; opacity: 0.9;">Get instant access on your home screen</small>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button id="install-btn" style="
            background: white;
            color: #2196F3;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
          ">Install</button>
          <button id="dismiss-btn" style="
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
          ">Dismiss</button>
        </div>
      `;

      document.body.insertBefore(installBanner, document.body.firstChild);

      // Install button handler
      document.getElementById('install-btn').addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response to install prompt: ${outcome}`);
          deferredPrompt = null;
          installBanner.remove();
        }
      });

      // Dismiss button handler
      document.getElementById('dismiss-btn').addEventListener('click', () => {
        installBanner.remove();
        // Remember dismissal for 7 days
        sessionStorage.setItem('pwa-install-dismissed', Date.now());
      });
    }

    // Check if app is already installed
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed successfully');
      const banner = document.getElementById('pwa-install-banner');
      if (banner) banner.remove();
    });

    // Check if already dismissed today
    window.addEventListener('load', () => {
      const dismissed = sessionStorage.getItem('pwa-install-dismissed');
      if (dismissed) {
        const dayInMs = 24 * 60 * 60 * 1000;
        if (Date.now() - parseInt(dismissed) < dayInMs) {
          return; // Don't show banner if dismissed within last day
        }
      }
    });
  </script>

</body>
</html>
