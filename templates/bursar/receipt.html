<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt - {{ pupil.first_name }} {{ pupil.last_name }}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Courier New', monospace;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .receipt {
      width: 80mm;
      background: white;
      padding: 6px;
      font-size: 7pt;
      line-height: 1.3;
      color: #000;
      flex-shrink: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Header */
    .receipt-header {
      text-align: center;
      border-bottom: 1px solid #000;
      padding-bottom: 6px;
      margin-bottom: 6px;
    }

    .school-name {
      font-size: 11pt;
      font-weight: bold;
      color: #d32f2f;
    }

    .school-info {
      font-size: 6.5pt;
      color: #333;
      margin-top: 1px;
    }

    .receipt-title {
      font-size: 7.5pt;
      font-weight: bold;
      margin-top: 2px;
      text-transform: uppercase;
    }

    /* Student Info */
    .student-info {
      margin: 4px 0;
      padding-bottom: 4px;
      border-bottom: 1px dashed #000;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 7pt;
      margin: 1px 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .info-label {
      font-weight: bold;
      width: 35%;
      flex-shrink: 0;
    }

    .info-value {
      text-align: right;
      width: 65%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Payments Table */
    .payments-section {
      margin: 4px 0;
      padding-bottom: 4px;
      border-bottom: 1px dashed #000;
    }

    .section-title {
      font-size: 7pt;
      font-weight: bold;
      margin-bottom: 2px;
      text-transform: uppercase;
    }

    .payment-row {
      display: flex;
      justify-content: space-between;
      font-size: 6.5pt;
      margin: 1px 0;
      font-family: 'Courier New', monospace;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .payment-desc {
      flex: 1;
      min-width: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .payment-amount {
      text-align: right;
      min-width: 30px;
      flex-shrink: 0;
      font-weight: bold;
      margin-left: 4px;
    }

    /* Fee Breakdown */
    .fees-section {
      margin: 4px 0;
      padding-bottom: 4px;
      border-bottom: 1px dashed #000;
    }

    .fee-row {
      display: flex;
      justify-content: space-between;
      font-size: 6.5pt;
      margin: 1px 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .fee-name {
      flex: 1;
      min-width: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .fee-required {
      text-align: right;
      min-width: 22px;
      flex-shrink: 0;
      margin-left: 2px;
    }

    .fee-paid {
      text-align: right;
      min-width: 22px;
      flex-shrink: 0;
      margin-left: 2px;
    }

    .fee-balance {
      text-align: right;
      min-width: 22px;
      flex-shrink: 0;
      font-weight: bold;
      margin-left: 2px;
    }

    .fee-header {
      display: flex;
      justify-content: space-between;
      font-size: 6.5pt;
      font-weight: bold;
      margin-bottom: 1px;
      border-bottom: 1px solid #000;
    }

    /* Summary */
    .summary {
      margin: 4px 0;
      padding-bottom: 4px;
      border-bottom: 1px dashed #000;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 7pt;
      margin: 1px 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .summary-row.total {
      font-weight: bold;
      font-size: 7.5pt;
      border-top: 1px solid #000;
      padding-top: 1px;
      margin-top: 1px;
    }

    .summary-row.balance {
      color: #d32f2f;
      font-weight: bold;
    }

    .summary-label {
      font-weight: bold;
      flex: 1;
      min-width: 0;
    }

    .summary-value {
      text-align: right;
      font-family: 'Courier New', monospace;
      min-width: 35px;
      flex-shrink: 0;
      margin-left: 4px;
    }

    /* Footer */
    .footer {
      text-align: center;
      font-size: 6.5pt;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #000;
    }

    .footer-line {
      margin: 1px 0;
    }

    .cashier-line {
      margin-top: 2px;
      font-size: 9pt;
      font-weight: 700;
    }

    /* Print Styles */
    @media print {
      html, body {
        width: 100%;
        height: 100%;
        background: white;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      body {
        padding: 0;
      }

      .receipt {
        width: 80mm;
        max-width: 80mm;
        margin: auto 0;
        padding: 4px;
        background: white;
        box-shadow: none;
        border: none;
        page-break-inside: avoid;
      }

      /* ensure cashier line is larger and visible when printing */
      .footer-line.cashier-line, .cashier-line {
        font-size: 9pt !important;
        font-weight: 700 !important;
      }

      .receipt * {
        page-break-inside: avoid;
      }

      .print-button {
        display: none !important;
      }

      @page {
        size: A4 portrait;
        margin: 0;
      }
    }

    /* Button */
    .print-button {
      display: block;
      width: 100%;
      margin-top: 20px;
      padding: 10px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      font-weight: bold;
    }

    .print-button:hover {
      background: #b71c1c;
    }
  </style>
</head>
<body>

<div class="receipt">
  <!-- Header -->
  <div class="receipt-header">
    <div class="school-name">HOPE FULL FUTURE P/S</div>
    <div class="school-info">Nuturing Minds, Shaping Future</div>
    <div class="school-info">Entebbe - Wakiso</div>
    <div class="receipt-title" style="margin-top: 3px;">*** RECEIPT ***</div>
  </div>

  <!-- Student Info -->
  <div class="student-info">
    <div class="info-row">
      <span class="info-label">STUDENT:</span>
      <span class="info-value">{{ pupil.first_name }} {{ pupil.last_name }}</span>
    </div>
    <div class="info-row">
      <span class="info-label">ADM #:</span>
      <span class="info-value">{{ pupil.admission_number }}</span>
    </div>
    {% if pupil.class_ %}
    <div class="info-row">
      <span class="info-label">CLASS:</span>
      <span class="info-value">{{ pupil.class_.name }}</span>
    </div>
    {% endif %}
  </div>

  <!-- Payments Made -->
  {% if payments %}
  <div class="payments-section">
    <div class="section-title">PAYMENTS RECORDED</div>
    {% for payment in payments %}
    <div class="payment-row">
      <span class="payment-desc">Pmt #{{ loop.index }} - {{ payment.payment_date.strftime('%d/%m/%y') if payment.payment_date else 'N/A' }}</span>
      <span class="payment-amount">{{ "%.0f" | format(payment.amount_paid) }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Fee Breakdown -->
  <div class="fees-section">
    <div class="section-title">FEE DETAILS</div>
    <div class="fee-header">
      <span class="fee-name">Item</span>
      <span class="fee-required">Req.</span>
      <span class="fee-paid">Paid</span>
      <span class="fee-balance">Bal.</span>
    </div>
    {% for fee in pupil_fees %}
    <div class="fee-row">
      <span class="fee-name">{{ fee.item_name[:12] }}</span>
      <span class="fee-required">{{ "%.0f" | format(fee.amount) }}</span>
      <span class="fee-paid">{{ "%.0f" | format(paid_lookup.get(fee.id, 0)) }}</span>
      <span class="fee-balance">{{ "%.0f" | format(fee.amount - paid_lookup.get(fee.id, 0)) }}</span>
    </div>
    {% endfor %}
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="summary-row total">
      <span class="summary-label">TOTAL REQUIRED:</span>
      <span class="summary-value">{{ "%.0f" | format(total_required) }}</span>
    </div>
    <div class="summary-row total">
      <span class="summary-label">TOTAL PAID:</span>
      <span class="summary-value">{{ "%.0f" | format(total_paid) }}</span>
    </div>
    <div class="summary-row balance">
      <span class="summary-label">BALANCE DUE:</span>
      <span class="summary-value">{{ "%.0f" | format(balance) }}</span>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-line">Date: {{ receipt_date }}</div>
    {# Show cashier with role (User model has role relationship: current_user.role.role_name) #}
    {# Use values passed from the route #}
    {% if current_user and current_user.is_authenticated and bursar_role_name %}
      {% set display_name = current_user.first_name ~ ' ' ~ current_user.last_name %}
      <div class="footer-line cashier-line">{{ display_name }} &#8212; {{ bursar_role_name }}</div>
    {% else %}
      <div class="footer-line cashier-line">Cashier: {{ cashier_name }}</div>
    {% endif %}

    <div class="footer-line" style="margin-top: 3px; font-size: 6pt;">*** Thank You ***</div>
  </div>
</div>

<button class="print-button" onclick="window.print()">üñ®Ô∏è PRINT RECEIPT</button>

</body>
</html>
