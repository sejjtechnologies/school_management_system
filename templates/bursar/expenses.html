<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expenses & Disbursements</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin:0; padding:0; background:#f0f5fa; }
    /* fixed top-nav height (60px) to match add_expense layout; scrolling uses --nav-h */
    :root{ --nav-h:60px; --footer-h:56px; }
    /* Fixed top nav - red background */
    .top-nav { position:fixed; top:0; left:0; right:0; height:var(--nav-h); background:#b71c1c; color:#fff; display:flex; align-items:center; padding:0 12px; z-index:999; justify-content:space-between; }
    .nav-title { font-weight:700; flex:1; font-size:14px; }
    .nav-actions { display:flex; gap:6px; }
    /* match back button sizing used in add_expense.html */
    .btn-back { display:inline-flex; align-items:center; gap:6px; background:#fff; color:#b71c1c; padding:6px 8px; border-radius:6px; text-decoration:none; font-weight:600; border:1px solid rgba(0,0,0,0.06); font-size:13px; box-shadow:0 1px 2px rgba(0,0,0,0.03); }
    .btn-back svg{width:14px;height:14px}
    .btn-signout { background:#c62828; color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:600; border:1px solid rgba(0,0,0,0.1); }
    .btn-signout:hover { background:#d32f2f; }
    /* Content area with top nav spacing */
    .content { padding-top:calc(var(--nav-h) + 12px); padding-bottom:calc(var(--footer-h) + 20px); padding-left:12px; padding-right:12px; }
    .container { padding: 12px; max-width:600px; margin:0 auto; }
     /* Scrollable table/list area. Uses the real footer height (updated via JS) so
       the scrollable card stops 20px above the footer regardless of footer content. */
    .scrollable-area { max-height:calc(100vh - var(--nav-h) - var(--footer-h) - 20px); overflow-y:auto; padding-right:8px; padding-bottom:20px; box-sizing:border-box; -webkit-overflow-scrolling:touch }
    .scrollable-area::-webkit-scrollbar { width:8px; }
    .scrollable-area::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.1); border-radius:8px; }
    .card { background:#fbfdff; border-radius:8px; padding:10px; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:12px; border:1px solid #e6eef7; margin-bottom:0; }
    .list-row { padding:10px; background:#f7fbff; margin-bottom:8px; border-radius:6px; border-left:3px solid #1976d2; cursor:pointer; transition:all 0.2s; }
    .list-row:hover { background:#ecf3ff; box-shadow:0 2px 6px rgba(25,118,210,0.08); }
    .list-row.editing { background:#fff3cd; border-left-color:#ffc107; }
    .list-row small { color:#666; display:block; }
    /* Inline edit fields */
    .edit-field { display:none; width:100%; padding:8px; border:1px solid #1976d2; border-radius:4px; font-size:14px; }
    .list-row.editing .view { display:none; }
    .list-row.editing .edit-field { display:inline-block; }
    .edit-actions { margin-top:8px; display:flex; gap:8px; }
    .edit-actions button { padding:6px 10px; border-radius:4px; border:none; cursor:pointer; font-size:12px; }
    .edit-actions .btn-save { background:#388e3c; color:#fff; }
    .edit-actions .btn-cancel { background:#757575; color:#fff; }
    .totals { display:flex; justify-content:space-between; font-weight:700; padding:8px 0; }
    .fixed-footer { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #ddd; padding:8px; text-align:center; }
    .btn { display:inline-block; padding:8px 12px; background:#388e3c; color:#fff; border-radius:6px; text-decoration:none; }
    .btn.add { background:#1976d2; }
    .small { font-size:13px; }
    /* Edit Modal */
    .edit-modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:#fff; border-radius:8px; padding:20px; max-width:400px; width:90%; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .form-group { display:flex; flex-direction:column; }
    .form-group label { font-size:12px; font-weight:600; margin-bottom:4px; color:#333; }
    .form-group input { padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px; }
    .form-group input:focus { border-color:#1976d2; outline:none; }
    .btn-save-modal, .btn-cancel-modal { padding:8px 16px; border-radius:4px; border:none; cursor:pointer; font-size:14px; font-weight:600; }
    .btn-save-modal { background:#388e3c; color:#fff; flex:1; }
    .btn-cancel-modal { background:#757575; color:#fff; flex:1; }
    .btn-save-modal:hover { background:#2e7d32; }
    .btn-cancel-modal:hover { background:#616161; }
    @media (max-width:420px) {
      .container { padding:8px; }
      .card { padding:8px; }
      .scrollable-area { max-height:calc(100vh - var(--nav-h) - var(--footer-h) - 20px); }
      .list-row { padding:8px; font-size:13px; }
      .nav-title { font-size:15px; }
    }
  </style>
</head>
<body>
  <!-- Fixed top nav -->
  <div class="top-nav">
    <div class="nav-title">Expenses & Disbursements</div>
    <div class="nav-actions">
      <a class="btn-back" href="{{ url_for('bursar_routes.dashboard') }}" title="Back to dashboard" aria-label="Back to dashboard">
        <!-- logout / sign-out icon (box with arrow) - same as add_expense.html -->
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8" stroke="#b71c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M20 12h-9" stroke="#b71c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M17 9l3 3-3 3" stroke="#b71c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span style="margin-left:6px; font-weight:600; color:#b71c1c;">Back</span>
      </a>
    </div>
  </div>

  <!-- Content area -->
  <div class="content">
    <div class="container">
      <div class="card">
        <h3 style="margin:0 0 10px 0; font-size:15px;">Filters</h3>
        <form method="get" action="{{ url_for('bursar_routes.expenses') }}" style="margin-bottom:8px;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <input name="term" value="{{ selected_term or '' }}" placeholder="Term" style="flex:1; min-width:80px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:13px;" />
            <input name="year" value="{{ selected_year or '' }}" placeholder="Year" style="width:70px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:13px;" />
            <input name="date" value="{{ selected_date or '' }}" placeholder="Date" type="date" style="min-width:130px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:13px;" />
            <button type="submit" style="padding:8px 12px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">Filter</button>
          </div>
        </form>

        <div class="totals small" style="font-size:12px;">
          <div>üí∞ Total: UGX {{ "%.0f"|format(total_spent) }}</div>
          <div>üìä {{ total_count }} item(s)</div>
        </div>
      </div>

      <div class="card scrollable-area">
        <h3 style="margin:0 0 12px 0; font-size:14px; color:#333;">Records (Click to edit)</h3>
        {% if records %}
          {% for r in records %}
            <div class="list-row" data-id="{{ r.id }}" data-amount="{{ r.amount }}" data-quantity="{{ r.quantity or '' }}" data-date="{{ r.payment_date.strftime('%Y-%m-%d') if r.payment_date else '' }}" data-term="{{ r.term or '' }}" data-year="{{ r.year or '' }}" onclick="toggleEditModal(this)">
              <div class="view">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px; align-items:baseline;">
                  <strong style="flex:1; word-break:break-word;">{{ r.item.name if r.item else (r.description[:30] or 'Other') }}</strong>
                  <span style="text-align:right; font-weight:600; white-space:nowrap; margin-left:8px;">UGX {{ "%.0f"|format(r.amount) }}</span>
                </div>
                <small style="color:#666;">üìÖ {{ r.payment_date.strftime('%d/%m/%Y') }} ‚Ä¢ üë§ {{ r.spent_by or 'N/A' }}{% if r.quantity %} ‚Ä¢ üì¶ Qty: {{ r.quantity }}{% endif %} ‚Ä¢ üìã {{ r.term or '-' }} / {{ r.year or '-' }}</small>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="small" style="padding:12px; text-align:center; color:#999;">üì≠ No expenses recorded yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Edit Modal Overlay -->
  <div id="editModal" class="edit-modal" style="display:none;">
    <div class="modal-content">
      <h3 style="margin:0 0 16px 0;">Edit Expense</h3>
      <form id="editForm" style="display:flex; flex-direction:column; gap:12px;">
        <div class="form-group">
          <label for="editAmount">Amount (UGX)</label>
          <input type="number" id="editAmount" step="0.01" required style="padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;" />
        </div>
        <div class="form-group">
          <label for="editQuantity">Quantity</label>
          <input type="number" id="editQuantity" min="1" style="padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;" />
        </div>
        <div class="form-group">
          <label for="editDate">Date</label>
          <input type="date" id="editDate" style="padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;" />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div class="form-group">
            <label for="editTerm">Term</label>
            <select id="editTerm" style="padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
              <option value="">-- Select term --</option>
              <option value="Term 1">Term 1</option>
              <option value="Term 2">Term 2</option>
              <option value="Term 3">Term 3</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editYear">Year</label>
            <select id="editYear" style="padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
              <option value="">-- Select year --</option>
              {% for y in range(2025, 2036) %}
                <option value="{{ y }}">{{ y }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button type="button" class="btn-save-modal" onclick="saveEditModal()">Save</button>
          <button type="button" class="btn-cancel-modal" onclick="closeEditModal()">Cancel</button>
          <button type="button" id="btnDelete" style="background:#c62828;color:#fff;border:none;border-radius:4px;padding:8px 12px;cursor:pointer;font-weight:600;" onclick="deleteCurrentRecord()">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation / Alert Modal (light, Bootstrap-like) -->
  <div id="confirmModal" class="edit-modal" style="display:none;">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle" style="margin:0 0 12px 0; font-size:16px;">Confirm</h3>
      <div id="confirmMessage" style="margin-bottom:16px; color:#333; font-size:14px;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="confirmCancel" class="btn-cancel-modal">Cancel</button>
        <button id="confirmOk" class="btn-save-modal" style="background:#1976d2">OK</button>
      </div>
    </div>
  </div>

  <div class="fixed-footer">
    <a href="{{ url_for('bursar_routes.dashboard') }}" class="btn add">‚èª Back / Sign out</a>
    &nbsp;&nbsp;
    {% include 'footer.html' %}
  </div>

  <script>
    let currentEditRecordId = null;

    // Open edit modal
    function toggleEditModal(row) {
      try {
        console.log('toggleEditModal', row && row.dataset && row.dataset.id);
        currentEditRecordId = row.dataset.id;
        document.getElementById('editAmount').value = row.dataset.amount || '';
        document.getElementById('editQuantity').value = row.dataset.quantity || '';
        document.getElementById('editDate').value = row.dataset.date || '';
        document.getElementById('editTerm').value = row.dataset.term || '';
        document.getElementById('editYear').value = row.dataset.year || '';
        const modal = document.getElementById('editModal');
        if (modal) modal.style.display = 'flex';

        // On mobile, ensure the clicked row/card is visible above footer by centering it
        try {
          setTimeout(() => {
            try { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) { /* ignore */ }
            const firstInput = document.getElementById('editAmount');
            if (firstInput) firstInput.focus();
          }, 80);
        } catch (e) { /* ignore */ }
      } catch (err) {
        console.error('toggleEditModal error', err);
      }
    }

    // Helper to format yyyy-mm-dd => dd/mm/yyyy for display
    function formatDateForDisplay(isoDate) {
      if (!isoDate) return '';
      const parts = isoDate.split('-');
      if (parts.length !== 3) return isoDate;
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditRecordId = null;
    }

    // Save all edited fields via AJAX and update the row in-place (no reload)
    function saveEditModal() {
      const amount = parseFloat(document.getElementById('editAmount').value);
      const quantity = document.getElementById('editQuantity').value ? parseInt(document.getElementById('editQuantity').value) : null;
      const date = document.getElementById('editDate').value;
      const term = document.getElementById('editTerm').value || null;
      const year = document.getElementById('editYear').value ? parseInt(document.getElementById('editYear').value) : null;

      if (!amount || amount <= 0) {
        showAlert('Please enter a valid amount');
        return;
      }

      // perform save in a nested function so we can call after confirmation
      function doSave() {
        const payload = { amount };
        if (quantity !== null) payload.quantity = quantity;
        if (date) payload.date = date;
        if (term) payload.term = term;
        if (year !== null) payload.year = year;

        fetch(`/bursar/expense/${currentEditRecordId}/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              // Update the corresponding list-row in-place
              const row = document.querySelector(`.list-row[data-id="${currentEditRecordId}"]`);
              if (row) {
                // update dataset attributes
                row.dataset.amount = data.data.amount;
                row.dataset.quantity = data.data.quantity || '';
                row.dataset.date = data.data.date || '';
                row.dataset.term = data.data.term || '';
                row.dataset.year = data.data.year || '';

                // update amount display (assumes view contains a span for amount)
                const amountSpan = row.querySelector('.view > div span');
                if (amountSpan) {
                  const formatted = Number(data.data.amount).toLocaleString(undefined, { maximumFractionDigits: 0 });
                  amountSpan.textContent = `UGX ${formatted}`;
                }

                // update small metadata line (date, spent_by, qty, term/year)
                  // rebuild the view content robustly so changes reflect immediately
                  const strong = row.querySelector('.view strong');
                  const itemName = strong ? strong.textContent : (row.dataset.description || 'Item');
                  const small = row.querySelector('.view small');
                  // determine spent_by from existing small if present
                  let spentBy = 'N/A';
                  if (small) {
                    const parts = small.textContent.split('‚Ä¢').map(s => s.trim());
                    if (parts.length > 1 && parts[1].includes('üë§')) {
                      spentBy = parts[1].replace('üë§', '').trim();
                    }
                  }

                  const d = data.data.date || '';
                  const dateDisplay = d ? `üìÖ ${formatDateForDisplay(d)}` : 'üìÖ -';
                  const qtyDisplay = data.data.quantity ? ` ‚Ä¢ üì¶ Qty: ${data.data.quantity}` : '';
                  const termDisplay = ` ‚Ä¢ üìã ${data.data.term || '-'} / ${data.data.year || '-'} `;

                  // Reconstruct innerHTML for .view to ensure consistent formatting
                  const view = row.querySelector('.view');
                  if (view) {
                    view.innerHTML = `
                      <div style="display:flex; justify-content:space-between; margin-bottom:6px; align-items:baseline;">
                        <strong style="flex:1; word-break:break-word;">${escapeHtml(itemName)}</strong>
                        <span style="text-align:right; font-weight:600; white-space:nowrap; margin-left:8px;">UGX ${Number(data.data.amount).toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>
                      </div>
                      <small style="color:#666;">${dateDisplay} ‚Ä¢ üë§ ${escapeHtml(spentBy)}${qtyDisplay}${termDisplay}</small>
                    `;
                  }

                // small visual cue: highlight briefly
                row.style.transition = 'background 0.35s';
                const prevBg = row.style.background;
                row.style.background = '#e8f5e9';
                setTimeout(() => { row.style.background = ''; }, 700);
              }

              // update totals displayed on the page
              try { recomputeTotals(); } catch (e) { /* ignore */ }

              // recompute footer/scroll layout by triggering resize handler
              try { window.dispatchEvent(new Event('resize')); } catch (e) { /* ignore */ }

            } else {
              showAlert('Error: ' + (data.error || 'Unknown'));
            }
          })
          .catch(err => {
            console.error(err);
            showAlert('Error updating record');
          });
        // close modal after save attempt (success path will have already updated)
        closeEditModal();
      }

      // Ask user to confirm save
      showConfirm({ title: 'Save changes?', message: 'Do you want to save the changes to this expense record?' })
        .then(confirmed => {
          if (!confirmed) return;
          doSave();
        });
    }

    // Delete the current record via AJAX (uses confirmation modal)
    function deleteCurrentRecord() {
      if (!currentEditRecordId) return;

      showConfirm({ title: 'Delete record?', message: 'Are you sure you want to delete this expense record? This action cannot be undone.' })
        .then(confirmed => {
          if (!confirmed) return;

          fetch(`/bursar/expense/${currentEditRecordId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
          .then(r => r.json())
          .then(data => {
            if (data && data.success) {
              // remove row from DOM
              const row = document.querySelector(`.list-row[data-id="${currentEditRecordId}"]`);
              if (row) {
                // smooth collapse
                row.style.transition = 'opacity 0.25s, height 0.25s, margin 0.25s';
                row.style.opacity = '0';
                row.style.height = '0px';
                row.style.margin = '0px';
                setTimeout(() => { row.remove(); }, 300);
              }
              try { window.dispatchEvent(new Event('resize')); } catch (e) { }
              try { recomputeTotals(); } catch (e) { }
            } else {
              showAlert('Error deleting record: ' + (data && data.error ? data.error : 'Unknown'));
            }
          })
          .catch(err => {
            console.error(err);
            showAlert('Error deleting record');
          });

          closeEditModal();
        });
    }

    // Close modal on outside click
    document.addEventListener('DOMContentLoaded', function() {
      // Close modal on outside click
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) closeEditModal();
        });
      }

      // Measure footer height and store in CSS variable --footer-h so CSS can
      // compute layouts that depend on the real footer size (keeps 20px gap).
      function updateFooterHeight() {
        try {
          // Prefer the included site-footer (from footer.html) if present
          const siteFooter = document.querySelector('.site-footer');
          let h = 0;
          if (siteFooter) {
            h = Math.ceil(siteFooter.offsetHeight || siteFooter.getBoundingClientRect().height || 0);
          } else {
            const footer = document.querySelector('.fixed-footer');
            if (footer) h = Math.ceil(footer.getBoundingClientRect().height || 0);
          }

          // if still zero, fallback to a reasonable default (48)
          if (!h) h = 48;

          // Set both variable names for compatibility with footer.js and our CSS
          document.documentElement.style.setProperty('--footer-h', h + 'px');
          document.documentElement.style.setProperty('--footer-height', h + 'px');

          // Ensure scrollable lists have enough bottom padding so last row isn't hidden behind footer
          try {
            const gap = 20; // px desired gap above footer
            document.querySelectorAll('.scrollable-area').forEach(el => {
              el.style.paddingBottom = (h + gap) + 'px';
            });
          } catch (e) { /* ignore */ }

          return h;
        } catch (e) {
          console.warn('Could not compute footer height', e);
          return 48;
        }
      }

      // Scroll focused input's card so its bottom is visible above footer on small screens
      function ensureCardVisibleOnFocus(e) {
        try {
          // Only run on small screens (mobile)
          if (window.innerWidth > 420) return;

          const target = e.target;
          if (!target) return;
          if (!/INPUT|TEXTAREA|SELECT/.test(target.tagName)) return;

          const card = target.closest('.card');
          if (!card) return;

          const scrollable = card.closest('.scrollable-area') || card || document.scrollingElement || document.documentElement;
          const footerHRaw = getComputedStyle(document.documentElement).getPropertyValue('--footer-h') || '0px';
          const footerH = parseInt(footerHRaw, 10) || 0;
          const navHRaw = getComputedStyle(document.documentElement).getPropertyValue('--nav-h') || '56px';
          const navH = parseInt(navHRaw, 10) || 56;
          const gapTop = 20; // desired gap from top nav to card top
          const gapBottom = 20; // desired gap from card bottom to footer

          const cardRect = card.getBoundingClientRect();
          const viewportTop = navH + gapTop;
          const viewportBottom = window.innerHeight - footerH - gapBottom;

          // If the card top is above desired viewport top, scroll up
          if (cardRect.top < viewportTop) {
            const delta = cardRect.top - viewportTop - 8; // negative
            if (scrollable === document.scrollingElement || scrollable === document.documentElement) {
              window.scrollBy({ top: delta, behavior: 'smooth' });
            } else {
              scrollable.scrollBy({ top: delta, behavior: 'smooth' });
            }
            return;
          }

          // If the card bottom is below the desired viewport bottom, scroll down
          if (cardRect.bottom > viewportBottom) {
            const delta = cardRect.bottom - viewportBottom + 8; // positive
            if (scrollable === document.scrollingElement || scrollable === document.documentElement) {
              window.scrollBy({ top: delta, behavior: 'smooth' });
            } else {
              scrollable.scrollBy({ top: delta, behavior: 'smooth' });
            }
          }
        } catch (err) {
          // non-fatal
          console.warn('ensureCardVisibleOnFocus error', err);
        }
      }

      // Run once and also after a short delay to allow included template content to settle
      updateFooterHeight();
      setTimeout(updateFooterHeight, 200);
      // Update on resize / orientation change
      window.addEventListener('resize', updateFooterHeight);
      // Also observe mutations under the footer in case its content changes
      const footerEl = document.querySelector('.fixed-footer');
      if (footerEl && window.MutationObserver) {
        const mo = new MutationObserver(() => updateFooterHeight());
        mo.observe(footerEl, { childList: true, subtree: true, characterData: true });
      }

      // Use visualViewport when available to react to on-screen keyboard changes (mobile)
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', function() {
          updateFooterHeight();
          // if a modal is open ensure it is visible
          const active = document.activeElement;
          if (active && active.closest && active.closest('.card')) {
            try { active.closest('.card').scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) { }
          }
        });
        visualViewport.addEventListener('scroll', function() { updateFooterHeight(); });
      }

      // Attach focus handler (use capturing to catch focus events)
      document.addEventListener('focusin', ensureCardVisibleOnFocus, true);
    });

    // Recompute totals displayed in the totals row
    function recomputeTotals() {
      try {
        const rows = Array.from(document.querySelectorAll('.list-row'));
        let total = 0;
        rows.forEach(r => { total += Number(r.dataset.amount || 0); });
        const totalDiv = document.querySelector('.totals > div:first-child');
        if (totalDiv) totalDiv.textContent = 'üí∞ Total: UGX ' + Math.round(total).toLocaleString();
        const countDiv = document.querySelector('.totals > div:nth-child(2)');
        if (countDiv) countDiv.textContent = `üìä ${rows.length} item(s)`;
      } catch (e) { /* ignore */ }
    }

    // Escape HTML to avoid injection when rebuilding innerHTML
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str).replace(/[&<>"'`]/g, function (s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"})[s];
      });
    }

    // Event delegation fallback: ensure clicking a .list-row opens the edit modal
    document.addEventListener('click', function (e) {
      try {
        const row = e.target.closest && e.target.closest('.list-row');
        if (row) {
          // ignore if clicking inside the modal controls
          if (row.closest && row.closest('#editModal')) return;
          // call toggleEditModal if available
          if (typeof toggleEditModal === 'function') {
            toggleEditModal(row);
          } else {
            console.warn('toggleEditModal not defined yet');
          }
        }
      } catch (err) { console.warn('delegation click error', err); }
    }, true);

    // --- Confirmation modal helpers ---
    function showConfirm(opts) {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const msgEl = document.getElementById('confirmMessage');
        const ok = document.getElementById('confirmOk');
        const cancel = document.getElementById('confirmCancel');

        titleEl.textContent = opts.title || 'Confirm';
        msgEl.textContent = opts.message || '';

        function cleanup() {
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          modal.style.display = 'none';
        }

        function onOk() { cleanup(); resolve(true); }
        function onCancel() { cleanup(); resolve(false); }

        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);

        modal.style.display = 'flex';
      });
    }

    function showAlert(message, title) {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const msgEl = document.getElementById('confirmMessage');
        const ok = document.getElementById('confirmOk');
        const cancel = document.getElementById('confirmCancel');

        // configure as alert: hide cancel
        titleEl.textContent = title || 'Notice';
        msgEl.textContent = message || '';
        cancel.style.display = 'none';
        ok.textContent = 'OK';

        function cleanup() {
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          cancel.style.display = '';
          ok.textContent = 'OK';
          modal.style.display = 'none';
        }

        function onOk() { cleanup(); resolve(true); }
        function onCancel() { cleanup(); resolve(false); }

        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
        modal.style.display = 'flex';
      });
    }
  </script>
</body>
</html>
