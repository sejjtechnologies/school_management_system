<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Staff Salaries</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root { --nav-h: 60px; --footer-h: 56px; }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f5fa;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--nav-h);
      background: #b71c1c;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 12px;
      z-index: 999;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .nav-title {
      font-weight: 700;
      flex: 1;
      font-size: 14px;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fff;
      color: #b71c1c;
      padding: 6px 8px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 13px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }

    .btn-back:hover { background: #f5f5f5; }

    .content {
      padding-top: calc(var(--nav-h) + 20px);
      padding-bottom: calc(var(--footer-h) + 20px);
      padding-left: 12px;
      padding-right: 12px;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .filter-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .filter-section h5 {
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .card {
      background: #fbfdff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e6eef7;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .staff-row {
      padding: 12px;
      border-bottom: 1px solid #e6eef7;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .staff-row:hover { background: #f7fbff; }
    .staff-row:last-child { border-bottom: none; }

    .staff-info {
      flex: 1;
      min-width: 0;
    }

    .staff-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 3px;
      word-break: break-word;
    }

    .staff-meta {
      font-size: 12px;
      color: #666;
      word-break: break-word;
    }

    .staff-salary {
      text-align: right;
      margin: 0 12px;
      flex-shrink: 0;
    }

    .salary-amount {
      font-weight: 600;
      font-size: 14px;
      color: #388e3c;
      white-space: nowrap;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .badge-paid {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge-unpaid {
      background: #ffebee;
      color: #c62828;
    }

    .btn-action {
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .btn-mark-paid {
      background: #388e3c;
      color: #fff;
    }

    .btn-mark-paid:hover { background: #2e7d32; }

    .btn-mark-unpaid {
      background: #d32f2f;
      color: #fff;
    }

    .btn-mark-unpaid:hover { background: #c62828; }

    /* History button style */
    .btn-history {
      background: #1976d2; /* pleasant blue */
      color: #fff;
      border: 1px solid rgba(0,0,0,0.06);
      padding: 6px 10px; /* match other buttons */
      font-size: 11px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      line-height: 1;
      cursor: pointer;
      vertical-align: middle;
    }

    .btn-history:hover {
      background: #155fa0;
      color: #fff;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 12px;
      overflow-y: auto;
    }

    .modal-overlay.show { display: flex; }

    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      margin: auto;
    }

    .modal-header { margin-bottom: 15px; }
    .modal-title { font-weight: 700; font-size: 16px; margin: 0; }
    .modal-body { margin-bottom: 15px; }

    .form-group { margin-bottom: 12px; }

    .form-group label {
      font-size: 12px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    /* Ensure there's a 20px gap from the top nav when scrolling on mobile */
    html { scroll-padding-top: calc(var(--nav-h) + 20px); }
    .card { scroll-margin-top: calc(var(--nav-h) + 20px); }

    .stat-card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border-left: 3px solid #1976d2;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #1976d2;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .content {
        padding-top: calc(var(--nav-h) + 20px);
        padding-bottom: calc(var(--footer-h) + 20px);
      }

      .stats-row {
        grid-template-columns: 1fr;
      }

      .filter-section {
        padding: 12px;
      }

      .staff-row {
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
      }

      .staff-info {
        width: 100%;
      }

      .staff-salary {
        width: 100%;
        text-align: left;
        margin: 0;
      }

      .salary-amount {
        display: inline-block;
      }

      .status-badge,
      .btn-action {
        font-size: 12px;
        padding: 5px 8px;
      }
    }

    @media (max-width: 576px) {
      .nav-title {
        font-size: 13px;
      }

      .btn-back {
        font-size: 12px;
        padding: 5px 7px;
      }

      .content {
        padding-left: 8px;
        padding-right: 8px;
      }

      .filter-section {
        padding: 10px;
        margin-bottom: 15px;
      }

      .filter-section h5 {
        font-size: 13px;
        margin-bottom: 10px;
      }

      .form-label {
        font-size: 11px !important;
        margin-bottom: 3px !important;
      }

      .form-select {
        font-size: 13px !important;
      }

      .stats-row {
        grid-template-columns: 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-label {
        font-size: 11px;
      }

      .stat-value {
        font-size: 18px;
      }

      .card {
        border-radius: 6px;
        margin-bottom: 10px;
      }

      .staff-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        padding: 8px;
        border-bottom: 1px solid #e6eef7;
      }

      .staff-info {
        width: 100%;
      }

      .staff-name {
        font-size: 13px;
        margin-bottom: 2px;
      }

      .staff-meta {
        font-size: 11px;
      }

      .staff-salary {
        width: 100%;
        text-align: left;
        margin: 0;
      }

      .salary-amount {
        font-size: 13px;
      }

      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
      }

      .btn-action {
        font-size: 11px;
        padding: 5px 8px;
      }

      .modal-content {
        max-width: 95vw;
        padding: 15px;
      }

      .modal-title {
        font-size: 15px;
      }

      .form-group {
        margin-bottom: 10px;
      }

      .form-group label {
        font-size: 11px;
        margin-bottom: 3px;
      }

      .form-group input,
      .form-group textarea {
        padding: 6px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body data-current-month="{{ current_month }}" data-current-year="{{ current_year }}">
  <!-- Top Nav -->
  <div class="top-nav">
    <div class="nav-title">üìä Manage Staff Salaries</div>
    <div style="display: flex; gap: 8px;">
      <a href="{{ url_for('bursar_routes.dashboard') }}" class="btn-back" aria-label="Back to dashboard">
        <i class="bi bi-box-arrow-right" style="color:#b71c1c; font-size:14px; line-height:1"></i>
        Back
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <div class="container">

      <!-- Statistics Cards -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">Total Staff (Period)</div>
          <div class="stat-value">{{ total_staff_all }}</div>
        </div>
        <div class="stat-card" style="border-left-color: #388e3c;">
          <div class="stat-label">Paid This Period</div>
          <div class="stat-value" style="color: #388e3c;">{{ paid_count_all }}</div>
        </div>
        <div class="stat-card" style="border-left-color: #d32f2f;">
          <div class="stat-label">Unpaid This Period</div>
          <div class="stat-value" style="color: #d32f2f;">{{ unpaid_count_all }}</div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <h5>üîç Filters</h5>
        <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; align-items: end;">
          <div>
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Role</label>
            <select name="role_id" class="form-select" style="font-size: 14px;" onchange="this.form.submit()">
              <option value="">-- All Roles --</option>
              {% for role in roles %}
                <option value="{{ role.id }}" {% if role.id == selected_role_id %}selected{% endif %}>{{ role.role_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Month</label>
            <select name="month" class="form-select" style="font-size: 14px;" onchange="this.form.submit()">
              {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>
                  {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                  {{ months[m-1] }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Year</label>
            <select name="year" class="form-select" style="font-size: 14px;" onchange="this.form.submit()">
              {% for y in range(2020, 2036) %}
                <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">Status</label>
            <select name="status" class="form-select" style="font-size: 14px;" onchange="this.form.submit()">
              <option value="all" {% if filter_status == 'all' %}selected{% endif %}>-- All --</option>
              <option value="paid" {% if filter_status == 'paid' %}selected{% endif %}>‚úì Paid</option>
              <option value="unpaid" {% if filter_status == 'unpaid' %}selected{% endif %}>‚úó Unpaid</option>
            </select>
          </div>
        </form>
      </div>

      <!-- Staff List -->
      <div class="card">
        {% if staff and staff|length > 0 %}
          {% for s in staff %}
            <div class="staff-row" data-user-id="{{ s.id }}">
              <div class="staff-info">
                <div class="staff-name">{{ s.first_name }} {{ s.last_name }}</div>
                <div class="staff-meta">
                  {{ s.role }} ‚Ä¢ {{ s.email }}
                </div>
              </div>
                <div style="display: flex; flex-direction: column; gap:6px; margin-left:12px;">
                  <!-- Payment info: reference and date/time when paid -->
                  <div class="payment-info" style="font-size:12px; color:#666; text-align:right;">
                    {% if s.is_paid and s.last_payment %}
                      <div><strong>Ref:</strong> {{ s.last_payment_reference or (s.last_payment.reference or '-') }}</div>
                      <div>
                        <strong>Paid:</strong>
                        {# show local time with AM/PM, and include ISO in tooltip on a small clock icon #}
                        {% if s.last_payment.payment_date %}
                          <span class="paid-ts">{{ s.last_payment.payment_date.strftime('%Y-%m-%d %I:%M %p') }}</span>
                          <i class="bi bi-clock" title="{{ s.last_payment.payment_date.isoformat() }}" style="margin-left:6px; font-size:12px; color:#666;"></i>
                        {% else %}
                          -
                        {% endif %}
                      </div>
                      <div>
                        <strong>Payer:</strong>
                        {% if s.last_payment.paid_by %}
                          {{ s.last_payment.paid_by.first_name }} {{ s.last_payment.paid_by.last_name }}
                        {% elif s.last_payment.paid_by_name %}
                          {{ s.last_payment.paid_by_name }}
                        {% elif current_bursar_full_name %}
                          {{ current_bursar_full_name }}
                        {% else %}
                          -
                        {% endif %}
                      </div>
                      <div>
                        <strong>Method:</strong>
                        {% if s.last_payment.payment_method == 'BANK' %}
                          Bank ({{ s.last_payment.bank_name or '-' }})
                        {% else %}
                          {{ s.last_payment.payment_method or 'CASH' }}
                        {% endif %}
                      </div>
                    {% else %}
                      <div class="no-payment" style="color:#999;">Not paid for selected period</div>
                    {% endif %}
                  </div>

                </div>

              <div class="staff-salary">
                <div class="salary-amount">UGX {{ '{:,.0f}'.format(s.salary_amount) }}</div>
              </div>

              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="status-badge {% if s.is_paid %}badge-paid{% else %}badge-unpaid{% endif %}">
                  {% if s.is_paid %}‚úì Paid{% else %}‚úó Unpaid{% endif %}
                </span>
                <button type="button" class="btn-action btn-open-payment {% if s.is_paid %}btn-mark-unpaid{% else %}btn-mark-paid{% endif %}"
                        data-user='{{ s.id|tojson }}'
                        data-name='{{ (s.first_name ~ " " ~ s.last_name)|tojson }}'
                        data-salary='{{ s.salary_amount|default(0)|tojson }}'
                        data-ispaid='{{ s.is_paid|tojson }}'>
                  {% if s.is_paid %}Unmark{% else %}Mark Paid{% endif %}
                </button>
                <button type="button" onclick="openSalaryHistoryModal('{{ s.id }}')" class="btn-action btn-view-history btn-history" data-user-id="{{ s.id }}" title="View payment history">
                  <i class="bi bi-clock-history" style="font-size:13px; vertical-align:middle; margin-right:6px; color: #fff;"></i>
                  History
                </button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="padding: 30px; text-align: center; color: #999;">
            <i class="bi bi-inbox" style="font-size: 32px; display: block; margin-bottom: 10px;"></i>
            <p>No staff found matching the selected filters.</p>
          </div>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Mark Staff as Paid</h4>
      </div>
      <div class="modal-body">
        <div id="staffInfo" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;"></div>

        <form id="paymentForm" style="display: flex; flex-direction: column; gap: 12px;">
          <input type="hidden" id="userId" />

          <div class="form-group">
            <label>Amount (UGX)</label>
            <input type="number" id="amount" step="0.01" required min="0" />
          </div>

          <div class="form-group">
            <label>Payment Method</label>
            <select id="paymentMethod" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
              <option value="CASH">üíµ Cash</option>
              <option value="BANK">üè¶ Bank Transfer</option>
            </select>
          </div>

          <div class="form-group" id="bankNameGroup" style="display: none;">
            <label>Bank Name</label>
            <select id="bankName" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
              <option value="">-- Select Bank --</option>
              <option value="Centenary">Centenary Bank</option>
              <option value="Stanbic">Stanbic Bank</option>
              <option value="ABSA">ABSA Bank</option>
              <option value="Other">Other Bank</option>
            </select>
          </div>

          <div class="form-group">
            <label>Reference (optional)</label>
            <input type="text" id="reference" placeholder="e.g., Check #1234" />
          </div>

          <div class="form-group">
            <label>Notes (optional)</label>
            <textarea id="notes" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;" rows="3" placeholder="e.g., partial payment, advance, etc."></textarea>
          </div>
        </form>
      </div>

      <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitPayment()">Confirm & Save</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="confirmTitle">Please confirm</h4>
      </div>
      <div class="modal-body" id="confirmBody">
        Are you sure?
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmOkBtn">Yes, proceed</button>
      </div>
    </div>
  </div>

  <!-- Message Modal (for success / error) -->
  <div id="messageModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="messageTitle">Message</h4>
      </div>
      <div class="modal-body" id="messageBody"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button type="button" class="btn btn-primary" onclick="closeMessageModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Salary History Modal (top-level sibling modal) -->
  <div id="historyModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Salary Payment History</h4>
      </div>
      <div class="modal-body" id="historyModalBody" style="max-height:60vh; overflow:auto;">
        <!-- filled dynamically -->
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button type="button" class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Include footer -->
  {% include 'footer.html' %}

  <script>
    // Endpoint patterns provided by Flask so JS doesn't hardcode routes
    const _MARK_PAID_URL_PATTERN = "{{ url_for('bursar_routes.mark_staff_paid_bursar', user_id=0) }}";
    const _MARK_UNPAID_URL_PATTERN = "{{ url_for('bursar_routes.mark_staff_unpaid', user_id=0) }}";
    const _SALARY_HISTORY_URL_PATTERN = "{{ url_for('bursar_routes.staff_salary_history', user_id=0) }}";
    const _CURRENT_BURSAR_FULL_NAME = "{{ current_bursar_full_name or '' }}";

    let currentUserId = null;
    // read month/year from body dataset to avoid embedding Jinja directly inside JS
    let currentMonth = parseInt(document.body.getAttribute('data-current-month')) || (new Date()).getMonth() + 1;
    let currentYear = parseInt(document.body.getAttribute('data-current-year')) || (new Date()).getFullYear();
    let _pendingConfirmAction = null;

    function showPaymentModal(userId, staffName, salary, isPaid) {
      currentUserId = userId;
      // if already paid, open confirm modal for unmark
      if (isPaid) {
        showConfirm(`Unmark payment for ${staffName}?`, function() { doUnmark(userId); });
        return;
      }

      document.getElementById('userId').value = userId;
      document.getElementById('amount').value = salary;
      document.getElementById('reference').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('staffInfo').innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(staffName)}</div>
        <div style="font-size: 12px; color: #666;">
          Salary: UGX ${Number(salary).toLocaleString()}
        </div>
      `;

      document.getElementById('paymentModal').classList.add('show');
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').classList.remove('show');
      // ensure modal is interactive when closed
      // (previously used 'inert' which blocks interaction; removed)
      try { document.getElementById('paymentForm').reset(); } catch(e){}
      currentUserId = null;
    }

    function submitPayment() {
      console.log('[submitPayment] Starting...');

      const amount = parseFloat(document.getElementById('amount').value);
      const reference = document.getElementById('reference').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const paymentMethod = document.getElementById('paymentMethod').value;
      const bankName = document.getElementById('bankName').value;

      console.log('[submitPayment] amount=', amount, 'method=', paymentMethod);

      if (!amount || amount <= 0) {
        console.log('[submitPayment] Invalid amount');
        showMessage('Error', 'Please enter a valid amount', true);
        return;
      }

      if (paymentMethod === 'BANK' && !bankName) {
        console.log('[submitPayment] Bank method but no bank selected');
        showMessage('Error', 'Please select a bank for bank transfer', true);
        return;
      }

      const payload = {
        amount: amount,
        period_month: currentMonth,
        period_year: currentYear,
        reference: reference || null,
        notes: notes || null,
        payment_method: paymentMethod,
        bank_name: paymentMethod === 'BANK' ? bankName : null
      };

      console.log('[submitPayment] Payload ready, calling showConfirm...');
      console.log('[submitPayment] currentUserId=', currentUserId);

      // ask confirmation before saving
      showConfirm(`Mark payment of UGX ${Number(amount).toLocaleString()} as paid?`, function() {
        console.log('[submitPayment] Confirmation callback executing');

        // perform actual save using Flask-provided endpoint pattern
        const url = _MARK_PAID_URL_PATTERN.replace('/0', '/' + currentUserId);
        console.log('[submitPayment] Fetching POST to:', url);

        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(r => {
          console.log('[submitPayment] Response status:', r.status);
          return r.json();
        })
        .then(data => {
          console.log('[submitPayment] Response JSON:', data);
          // Helpful debug grouping to inspect AJAX response structure when Mark Paid is used
          try {
            console.groupCollapsed('mark-paid response details');
            console.log('status:', data.success ? 'success' : 'error');
            console.log('message:', data.message || data.error);
            console.log('payment object:', data.payment);
            console.log('staff_update:', data.staff_update);
            console.log('full response:', data);
            console.groupEnd();
          } catch (dbgErr) { console.log('debug log error', dbgErr); }

            if (data.success) {
            console.log('[submitPayment] Success! Closing modal...');
            closePaymentModal();

            // Update the staff row immediately without page reload
            if (data.staff_update) {
              console.log('[submitPayment] staff_update present, user_id=', data.staff_update.user_id);

              const staffRow = document.querySelector(`[data-user-id="${data.staff_update.user_id}"]`);
              console.log('[submitPayment] Staff row found?', !!staffRow);

              if (staffRow) {
                // Update status badge
                const badge = staffRow.querySelector('.status-badge');
                console.log('[submitPayment] Badge found?', !!badge);
                if (badge) {
                  console.log('[submitPayment] Updating badge...');
                  // Set explicit content and classes so styling updates reliably
                  badge.innerText = '';
                  const check = document.createElement('span');
                  check.textContent = '‚úì Paid';
                  badge.classList.remove('badge-unpaid');
                  badge.classList.add('badge-paid');
                  badge.appendChild(check);
                }

                // Update button text, class, AND data-ispaid attribute
                const btn = staffRow.querySelector('.btn-open-payment');
                console.log('[submitPayment] Button found?', !!btn);
                if (btn) {
                  console.log('[submitPayment] Updating button...');
                  btn.textContent = 'Unmark';
                  btn.classList.remove('btn-mark-paid');
                  btn.classList.add('btn-mark-unpaid');
                  btn.setAttribute('data-ispaid', 'true');  // IMPORTANT: Update this!
                }
                // Update payment info display (reference and date)
                try {
                  if (data.payment) {
                    const pinfo = staffRow.querySelector('.payment-info');
                    const ref = data.payment.reference || '-';
                    const iso = data.payment.payment_date || null;
                    const pd = iso ? (new Date(iso)).toLocaleString(undefined, { hour12: true, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
                    // determine payer: prefer server-provided paid_by_name, otherwise use current bursar full name
                    const payer = (data.payment.paid_by_name && data.payment.paid_by_name.trim()) ? data.payment.paid_by_name : (_CURRENT_BURSAR_FULL_NAME || '-');
                    const method = data.payment.payment_method || 'CASH';
                    const bank = data.payment.bank_name || '';

                    const paidHtml = `
                      <div><strong>Ref:</strong> ${escapeHtml(ref)}</div>
                      <div><strong>Paid:</strong> ${escapeHtml(pd)} ${iso ? `<i class="bi bi-clock" title="${escapeHtml(iso)}" style="margin-left:6px; font-size:12px; color:#666;"></i>` : ''}</div>
                      <div><strong>Payer:</strong> ${escapeHtml(payer)}</div>
                      <div><strong>Method:</strong> ${escapeHtml(method === 'BANK' ? `Bank (${bank || '-'})` : method)}</div>
                    `;

                    if (pinfo) {
                      pinfo.innerHTML = paidHtml;
                    } else {
                      const container = document.createElement('div');
                      container.className = 'payment-info';
                      container.style = 'font-size:12px; color:#666; text-align:right;';
                      container.innerHTML = paidHtml;
                      // insert before the action buttons group
                      const actionsGroup = staffRow.querySelector('div[style*="display: flex; gap: 8px"]');
                      if (actionsGroup && actionsGroup.parentNode) actionsGroup.parentNode.insertBefore(container, actionsGroup);
                    }
                  }
                } catch (e) { console.error('[submitPayment] error updating payment-info', e); }
                // If the user is currently viewing 'unpaid' filter, switch to 'all' so the newly-paid staff is visible
                try {
                  const params = new URLSearchParams(window.location.search);
                  const statusFilter = params.get('status') || 'all';
                  if (statusFilter === 'unpaid') {
                    console.log('[submitPayment] Status filter is unpaid; switching to all to show newly-paid staff');
                    params.set('status', 'all');
                    window.location.search = params.toString();
                    return; // Page will reload, no need to proceed further
                  }
                } catch (e) {
                  console.error('[submitPayment] Error checking/switching filter:', e);
                }
              }
            }

            console.log('[submitPayment] Showing success message...');
            showMessage('Success', data.message, false, function(){
              console.log('[submitPayment] Success callback done');
              // Update the statistics
              updateStatsDisplay();
            });
          } else {
            console.log('[submitPayment] Error response:', data.error);
            showMessage('Error', data.error || 'Unknown error', true);
          }
        })
        .catch(err => {
          console.error('[submitPayment] Fetch error:', err);
          showMessage('Error', 'Error saving payment', true);
        });
      });
    }

    function doUnmark(userId) {
      // confirm already handled, call unmark endpoint using Flask-provided pattern
      const url = _MARK_UNPAID_URL_PATTERN.replace('/0', '/' + userId);
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ payment_id: null })
      })
      .then(r => r.json())
      .then(data => {
          if (data.success) {
            // Update the staff row immediately without page reload
            if (data.staff_update) {
              const staffRow = document.querySelector(`[data-user-id="${data.staff_update.user_id}"]`);
              if (staffRow) {
                // Update status badge
                const badge = staffRow.querySelector('.status-badge');
                if (badge) {
                  badge.innerText = '';
                  const txt = document.createElement('span');
                  txt.textContent = '‚úó Unpaid';
                  badge.classList.remove('badge-paid');
                  badge.classList.add('badge-unpaid');
                  badge.appendChild(txt);
                }

                // Update button text, class, AND data-ispaid attribute
                const btn = staffRow.querySelector('.btn-open-payment');
                if (btn) {
                  btn.textContent = 'Mark Paid';
                  btn.classList.remove('btn-mark-unpaid');
                  btn.classList.add('btn-mark-paid');
                  btn.setAttribute('data-ispaid', 'false');  // IMPORTANT: Update this!
                }
                // remove payment-info if present
                try {
                  const pinfo = staffRow.querySelector('.payment-info');
                  if (pinfo) pinfo.innerHTML = '<div class="no-payment" style="color:#999;">Not paid for selected period</div>';
                } catch(e) { console.error('doUnmark update payment-info', e); }
              }
            }

            showMessage('Success', data.message || 'Payment reversed', false, function(){
              // Update the statistics
              updateStatsDisplay();
            });
          } else {
            showMessage('Error', data.error || 'Unable to reverse payment', true);
          }
        })
        .catch(err => {
          console.error('[doUnmark] Fetch error:', err);
          showMessage('Error', 'Error reversing payment', true);
        });
    }

    // Confirmation modal helpers
    let _reopenPaymentModal = false;

    function showConfirm(message, onConfirm) {
      console.log('[showConfirm] Message:', message);
      console.log('[showConfirm] onConfirm is function?', typeof onConfirm === 'function');

      document.getElementById('confirmTitle').innerText = 'Please confirm';
      document.getElementById('confirmBody').innerText = message;

      // Store the callback
      _pendingConfirmAction = onConfirm;
      console.log('[showConfirm] _pendingConfirmAction set, type:', typeof _pendingConfirmAction);

      const okBtn = document.getElementById('confirmOkBtn');
      if (!okBtn) {
        console.error('[showConfirm] confirmOkBtn not found!');
        return;
      }

      // Remove old event listener and add new one
      const newOkBtn = okBtn.cloneNode(true);
      okBtn.parentNode.replaceChild(newOkBtn, okBtn);

      const freshBtn = document.getElementById('confirmOkBtn');
      freshBtn.addEventListener('click', function(){
        console.log('[confirmOkBtn.click] Clicked!');
        console.log('[confirmOkBtn.click] _pendingConfirmAction type:', typeof _pendingConfirmAction);

        // SAVE the callback BEFORE closing the modal (closeConfirmModal sets it to null)
        const callbackToExecute = _pendingConfirmAction;

        // Close confirm without reopening the payment modal
        closeConfirmModal(/*confirmed=*/true);

        if (typeof callbackToExecute === 'function') {
          console.log('[confirmOkBtn.click] Calling pending action...');
          callbackToExecute();
        } else {
          console.error('[confirmOkBtn.click] ERROR: callback is not a function!', callbackToExecute);
        }
      });

      // If the payment modal is open, hide it while showing confirm to avoid visual jumbling.
      const pm = document.getElementById('paymentModal');
      _reopenPaymentModal = false;
      if (pm && pm.classList.contains('show')) {
        pm.classList.remove('show');
        _reopenPaymentModal = true;
      }

      document.getElementById('confirmModal').classList.add('show');
      console.log('[showConfirm] Confirm modal shown');
    }

    function closeConfirmModal(confirmed=false){
      console.log('[closeConfirmModal] confirmed=', confirmed);
      document.getElementById('confirmModal').classList.remove('show');
      // Only reopen the payment modal when the user cancelled the confirmation.
      if (!confirmed && _reopenPaymentModal) {
        const pm = document.getElementById('paymentModal');
        if (pm) {
          pm.classList.add('show');
        }
        _reopenPaymentModal = false;
      } else {
        // If confirmed or no modal was open, just reset the flag.
        _reopenPaymentModal = false;
      }
      _pendingConfirmAction = null;
    }

    // Message modal
    function showMessage(title, message, isError, onClose){
      document.getElementById('messageTitle').innerText = title || 'Notice';
      document.getElementById('messageBody').innerText = message || '';
      const m = document.getElementById('messageModal');
      m.classList.add('show');
      // style adjustments
      const titleEl = document.getElementById('messageTitle');
      titleEl.style.color = isError ? '#c62828' : '#2e7d32';
      // attach close handler
      document.querySelector('#messageModal .btn-primary').onclick = function(){
        closeMessageModal();
        if (onClose) onClose();
      };
    }

    function closeMessageModal(){
      document.getElementById('messageModal').classList.remove('show');
    }

    // Salary history modal helpers
    function openSalaryHistoryModal(userId) {
      const url = _SALARY_HISTORY_URL_PATTERN.replace('/0', '/' + userId);
      const body = document.getElementById('historyModalBody');
      body.innerHTML = '<div style="padding:12px; color:#666">Loading‚Ä¶</div>';
      document.getElementById('historyModal').classList.add('show');

      fetch(url).then(r => r.json()).then(data => {
        if (!data || !data.success) {
          body.innerHTML = `<div style="padding:12px; color:#c62828">Unable to load history</div>`;
          return;
        }

        const rows = data.history || [];
        if (!rows.length) {
          body.innerHTML = `<div style="padding:12px; color:#666">No payment history found.</div>`;
          return;
        }

        let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
        rows.forEach(r => {
          const iso = r.payment_date || '';
          const pd = iso ? (new Date(iso)).toLocaleString(undefined, { hour12: true, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';
          const payer = r.paid_by_name || '';
          const method = r.payment_method || 'CASH';
          const bank = r.bank_name || '';
          html += `
            <div style="padding:10px; border:1px solid #eef4fb; border-radius:6px; background:#fff;">
              <div style="font-weight:600;">Ref: ${escapeHtml(r.reference_display || r.reference || '-')}</div>
              <div style="font-size:13px; color:#444; margin-top:6px;">Amount: UGX ${Number(r.amount).toLocaleString()}</div>
              <div style="font-size:12px; color:#666; margin-top:6px;">Paid: ${escapeHtml(pd)} ${iso ? `<i class=\"bi bi-clock\" title=\"${escapeHtml(iso)}\" style=\"margin-left:6px; font-size:12px; color:#666;\"></i>` : ''}</div>
              <div style="font-size:12px; color:#666;">Payer: ${escapeHtml(payer || _CURRENT_BURSAR_FULL_NAME || '-')}</div>
              <div style="font-size:12px; color:#666;">Method: ${escapeHtml(method === 'BANK' ? `Bank (${bank || '-'})` : method)}</div>
              <div style="font-size:12px; color:#888; margin-top:6px;">Status: ${escapeHtml(r.status || '')}</div>
              <div style="font-size:12px; color:#666; margin-top:6px;">Notes: ${escapeHtml(r.notes || '')}</div>
            </div>
          `;
        });
        html += '</div>';
        body.innerHTML = html;
      }).catch(err => {
        console.error('history fetch error', err);
        body.innerHTML = `<div style="padding:12px; color:#c62828">Error loading history</div>`;
      });
    }

    function closeHistoryModal() {
      const m = document.getElementById('historyModal');
      if (m) m.classList.remove('show');
    }

    // Utility
    function escapeHtml(text){
      var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, function(m){ return map[m]; });
    }

    // Close modals on outside click
    try { document.getElementById('paymentModal').addEventListener('click', function(e) { if (e.target === this) closePaymentModal(); }); } catch(e){}
    try { document.getElementById('confirmModal').addEventListener('click', function(e) { if (e.target === this) closeConfirmModal(); }); } catch(e){}
    try { document.getElementById('messageModal').addEventListener('click', function(e) { if (e.target === this) closeMessageModal(); }); } catch(e){}
    try { document.getElementById('historyModal').addEventListener('click', function(e) { if (e.target === this) closeHistoryModal(); }); } catch(e){}

    // Show/hide bank name dropdown based on payment method
    document.getElementById('paymentMethod').addEventListener('change', function(e) {
      const bankGroup = document.getElementById('bankNameGroup');
      if (e.target.value === 'BANK') {
        bankGroup.style.display = 'block';
      } else {
        bankGroup.style.display = 'none';
        document.getElementById('bankName').value = '';
      }
    });

    // Delegate click handler for buttons (payment modal and history)
    document.addEventListener('click', function(e){
      // Open payment modal
      const payBtn = e.target.closest && e.target.closest('.btn-open-payment');
      if (payBtn) {
        try {
          const userId = JSON.parse(payBtn.getAttribute('data-user'));
          const name = JSON.parse(payBtn.getAttribute('data-name'));
          const salary = JSON.parse(payBtn.getAttribute('data-salary'));
          const isPaid = JSON.parse(payBtn.getAttribute('data-ispaid'));
          showPaymentModal(userId, name, salary, isPaid);
        } catch(err) {
          console.error('Failed to open payment modal', err);
        }
        return;
      }

      // Open salary history modal
      const viewBtn = e.target.closest && e.target.closest('.btn-view-history');
      if (viewBtn) {
        const uid = viewBtn.getAttribute('data-user-id');
        if (uid) openSalaryHistoryModal(uid);
        return;
      }
    });
      // Update statistics display based on current DOM state
      function updateStatsDisplay() {
        console.log('[updateStatsDisplay] Recalculating stats...');

        const allRows = document.querySelectorAll('.staff-row');
        const totalStaff = allRows.length;

        let paidCount = 0;
        allRows.forEach(row => {
          const badge = row.querySelector('.status-badge');
          if (badge && badge.classList.contains('badge-paid')) {
            paidCount++;
          }
        });

        const unpaidCount = totalStaff - paidCount;

        console.log(`[updateStatsDisplay] Total: ${totalStaff}, Paid: ${paidCount}, Unpaid: ${unpaidCount}`);

        // Update the stat values in the UI
        const statCards = document.querySelectorAll('.stat-value');
        if (statCards.length >= 3) {
          statCards[0].textContent = totalStaff;
          statCards[1].textContent = paidCount;
          statCards[2].textContent = unpaidCount;
        }
      }

      // Ensure there's room above footer when scrolling on mobile
      function updateFooterSpacing() {
        try {
          const footer = document.querySelector('.site-footer');
          const footerHeight = footer ? footer.offsetHeight : 56; // fallback
          // update CSS variable used elsewhere
          document.documentElement.style.setProperty('--footer-h', footerHeight + 'px');
          // set scroll-padding-bottom so anchored/scroll-to elements are visible above footer
          document.documentElement.style.setProperty('scroll-padding-bottom', `calc(var(--footer-h) + 20px)`);
          // set per-card margin for last-child visible area
          document.querySelectorAll('.card').forEach(c => {
            c.style.scrollMarginBottom = (footerHeight + 20) + 'px';
          });
        } catch (e) {
          // ignore
        }
      }

      // run on load/resize/viewport change
      window.addEventListener('load', updateFooterSpacing);
      window.addEventListener('resize', updateFooterSpacing);
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', updateFooterSpacing);
        visualViewport.addEventListener('scroll', updateFooterSpacing);
      }
      // in case footer size changes
      const footerEl = document.querySelector('.site-footer');
      if (footerEl && window.ResizeObserver) {
        try { new ResizeObserver(updateFooterSpacing).observe(footerEl); } catch(e) {}
      }
      setTimeout(updateFooterSpacing, 50);
  </script>
</body>
</html>
