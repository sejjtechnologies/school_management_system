<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Add Expense</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;margin:0;padding:0;background:#f7f7f7}
    /* slightly smaller top-nav by default to fit mobile screens better */
    :root{--nav-h:48px;--footer-h:56px}
    .top-nav{position:fixed;top:0;left:0;right:0;height:var(--nav-h);background:#b71c1c;color:#fff;display:flex;align-items:center;padding:0 10px;z-index:999}
    .nav-title{flex:1;font-weight:700;font-size:14px}
    .nav-actions{display:flex;gap:6px}
    /* smaller, tighter back button */
    .btn-back{display:inline-flex;align-items:center;gap:6px;background:#fff;color:#b71c1c;padding:6px 8px;border-radius:6px;text-decoration:none;font-weight:600;border:1px solid rgba(0,0,0,0.06);box-shadow:0 1px 2px rgba(0,0,0,0.03);font-size:13px}
    .btn-back svg{width:14px;height:14px}
    .content{padding:12px; padding-top:calc(var(--nav-h) + 12px)}
    label{display:block;margin:6px 0 4px;font-weight:600;font-size:13px}
    /* modern light inputs */
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #e6eef7;background:#f7fbff;border-radius:8px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);font-size:14px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#7fb3ff;box-shadow:0 0 0 3px rgba(127,179,255,0.12)}
    /* grouped fields grid */
    .field-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media (max-width:420px){.field-grid{grid-template-columns:1fr}}
    @media (max-width:420px){
      /* slightly reduced further on very small screens */
      .btn-back{padding:5px 7px; border-radius:6px; font-size:13px}
      .btn-back svg{width:13px;height:13px}
      .top-nav{height:44px}
      :root{--nav-h:44px}
    }
    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:6px;text-decoration:none;color:#fff}
    .btn.save{background:#388e3c}
    .btn.cancel{background:#777}
    .fixed-footer{position:fixed;left:0;right:0;bottom:0;height:var(--footer-h);background:#fff;border-top:1px solid #ddd;padding:8px 12px;text-align:center;display:flex;align-items:center;justify-content:center}
    /* Scrollable card for inputs that leaves 20px gap on mobile */
    .form-card{background:#fbfdff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(16,24,40,0.04);margin-bottom:12px;overflow:auto}
    .form-scroll{max-height:calc(100vh - var(--nav-h) - var(--footer-h) - 20px);overflow-y:auto;padding-bottom:20px;-webkit-overflow-scrolling:touch}
    .form-scroll::-webkit-scrollbar{width:8px}
    .form-scroll::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.08);border-radius:8px}
    .form-card .small{font-size:13px;color:#555}
  </style>
</head>
<body>
  <div class="top-nav">
    <div class="nav-title">Add Expense</div>
    <div class="nav-actions">
      <a class="btn-back" href="{{ url_for('bursar_routes.dashboard') }}" title="Back to dashboard">
        <!-- logout / sign-out icon (box with arrow) -->
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8" stroke="#b71c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M20 12h-9" stroke="#b71c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M17 9l3 3-3 3" stroke="#b71c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span style="margin-left:6px; font-weight:600; color:#b71c1c;">Back</span>
      </a>
    </div>
  </div>

  <div class="content">
    <div class="form-wrap">
      <div class="form-card form-scroll">
      <form method="post" action="{{ url_for('bursar_routes.add_expense') }}">
      <label for="item_id">Item / Equipment </label>
      <select name="item_id" id="item_id" tabindex="1" autofocus>
        <option value="">-- Select item to continue --</option>
        {% for it in items %}
          <option value="{{ it.id }}">{{ it.name }}</option>
        {% endfor %}
      </select>

      <div class="field-grid">
        <div>
          <label for="amount">Amount (UGX)</label>
          <input name="amount" id="amount" type="number" step="0.01" required tabindex="2" />
        </div>
        <div>
          <label for="quantity">Quantity</label>
          <input name="quantity" id="quantity" type="number" step="1" min="1" tabindex="3" />
        </div>
      </div>

      <div class="field-grid">
        <div>
          <label for="payment_date">Date</label>
          <input name="payment_date" id="payment_date" type="date" tabindex="4" />
        </div>
        <div>
          <label for="term">Term</label>
          <select name="term" id="term" tabindex="7">
            <option value="">-- Select term --</option>
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
          </select>
        </div>
      </div>

      <div class="field-grid">
        <div>
          <label for="year">Year</label>
          <select name="year" id="year" tabindex="8">
            <option value="">-- Select year --</option>
            {% for y in range(2025, 2036) %}
              <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="spent_by">Recorded by (name)</label>
          <input name="spent_by" id="spent_by" placeholder="e.g. Adegi Dennis" value="{{ bursar_name or '' }}" tabindex="6" readonly aria-readonly="true" />
        </div>
      </div>

      <label for="description">Description</label>
      <textarea name="description" id="description" rows="3" tabindex="5"></textarea>

      <div class="actions">
        <button class="btn save" type="submit" tabindex="9">Save</button>
        <a class="btn cancel" href="{{ url_for('bursar_routes.expenses') }}" tabindex="10">Cancel</a>
      </div>
    </form>

    {% if added %}
      <div style="margin-top:12px">
        <p class="small">Expense added. View records for the same filter:</p>
        <a class="btn" href="{{ url_for('bursar_routes.expenses', term=added_term, year=added_year, date=added_date) }}">See expenses (Term={{ added_term }} Year={{ added_year }})</a>
      </div>
    {% endif %}

    <script>
      // Allow Enter to move focus to the next field (vertical navigation)
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        if (!form) return;
        const focusable = Array.from(form.querySelectorAll('select, input, textarea, button'))
          .filter(el => !el.disabled && el.type !== 'hidden');

        focusable.forEach((el, idx) => {
          el.dataset.idx = idx;
          el.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
              // If it's a button or submit, allow default submit
              const tag = el.tagName.toLowerCase();
              const isButton = (tag === 'button') || (el.type === 'submit');
              if (!isButton) {
                e.preventDefault();
                const next = focusable[idx + 1];
                if (next) next.focus();
              }
            }
          });
        });
      });
    </script>
      </div> <!-- .form-card -->
    </div> <!-- .form-wrap -->
  </div> <!-- .content -->

    <div class="fixed-footer">
      {% include 'footer.html' %}
    </div>
    <script>
      // Measure footer and ensure focused inputs scroll their card into view on mobile
      document.addEventListener('DOMContentLoaded', function() {
        function updateFooterHeight() {
          try {
            const siteFooter = document.querySelector('.site-footer');
            let h = 0;
            if (siteFooter) {
              h = Math.ceil(siteFooter.offsetHeight || siteFooter.getBoundingClientRect().height || 0);
            } else {
              const footer = document.querySelector('.fixed-footer');
              if (footer) h = Math.ceil(footer.getBoundingClientRect().height || 0);
            }
            if (!h) h = 48;
            document.documentElement.style.setProperty('--footer-h', h + 'px');
            document.documentElement.style.setProperty('--footer-height', h + 'px');

            // Ensure form-scroll containers have enough bottom padding so last controls
            // are accessible above the footer (use footer height + gap)
            try {
              const gap = 20; // px desired gap above footer
              document.querySelectorAll('.form-scroll').forEach(el => {
                // set padding-bottom to footer height + gap so Save button can scroll into view
                el.style.paddingBottom = (h + gap) + 'px';
              });
            } catch (e) { /* ignore */ }

            return h;
          } catch (e) { console.warn('footer measure failed', e); return 48; }
        }

        function ensureCardVisibleOnFocus(e) {
          try {
            if (window.innerWidth > 420) return;
            const target = e.target;
            if (!target) return;
            if (!/INPUT|TEXTAREA|SELECT/.test(target.tagName)) return;
            const card = target.closest('.form-card');
            if (!card) return;
            // The card itself is usually the scrollable container
            const scrollable = card.closest('.form-scroll') || card || document.scrollingElement || document.documentElement;
            const footerHRaw = getComputedStyle(document.documentElement).getPropertyValue('--footer-h') || '0px';
            const footerH = parseInt(footerHRaw, 10) || 0;
            const navHRaw = getComputedStyle(document.documentElement).getPropertyValue('--nav-h') || '56px';
            const navH = parseInt(navHRaw, 10) || 56;
            const gapTop = 20; // desired gap from top nav to card top
            const gapBottom = 20; // desired gap from card bottom to footer

            // use visualViewport height if available (accounts for on-screen keyboard)
            const viewportHeight = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;

            const cardRect = card.getBoundingClientRect();
            const viewportTop = navH + gapTop;
            const viewportBottom = viewportHeight - footerH - gapBottom;

            // If the card top is above desired viewport top, scroll up
            if (cardRect.top < viewportTop) {
              const delta = cardRect.top - viewportTop - 8; // negative
              if (scrollable === document.scrollingElement || scrollable === document.documentElement) {
                window.scrollBy({ top: delta, behavior: 'smooth' });
              } else {
                scrollable.scrollBy({ top: delta, behavior: 'smooth' });
              }
              return;
            }

            // If the card bottom is below the desired viewport bottom, scroll down
            if (cardRect.bottom > viewportBottom) {
              const delta = cardRect.bottom - viewportBottom + 8; // positive
              if (scrollable === document.scrollingElement || scrollable === document.documentElement) {
                window.scrollBy({ top: delta, behavior: 'smooth' });
              } else {
                scrollable.scrollBy({ top: delta, behavior: 'smooth' });
              }
            }

            // Robust fallback: make sure Save button is visible by centering it
            try {
              const saveBtn = card.querySelector('.actions .btn.save');
              if (saveBtn) {
                // small delay to allow previous scrolling to finish and keyboard settle
                setTimeout(() => {
                  saveBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 220);
              }
            } catch (e) { /* ignore */ }
          } catch (err) { console.warn(err); }
        }

        updateFooterHeight();
        setTimeout(updateFooterHeight, 200);
        window.addEventListener('resize', updateFooterHeight);
        const footerEl = document.querySelector('.fixed-footer');
        if (footerEl && window.MutationObserver) {
          const mo = new MutationObserver(() => updateFooterHeight());
          mo.observe(footerEl, { childList: true, subtree: true, characterData: true });
        }
        // Use visualViewport when available to react to on-screen keyboard changes
        if (window.visualViewport) {
          visualViewport.addEventListener('resize', function() {
            updateFooterHeight();
            // ensure current focused element's card is visible
            const active = document.activeElement;
            if (active) ensureCardVisibleOnFocus({ target: active });
          });
          visualViewport.addEventListener('scroll', function() {
            updateFooterHeight();
          });
        }
        document.addEventListener('focusin', ensureCardVisibleOnFocus, true);
      });
    </script>
</body>
</html>
