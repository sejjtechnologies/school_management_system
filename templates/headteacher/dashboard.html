<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Headteacher Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { padding-top: 70px; background-color: #f1f8e9; font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: #1b5e20; }
    .navbar-brand, .nav-link { color: #fff !important; }
    .logout-btn { background-color: #d32f2f; color: #fff; border: none; }
    .logout-btn:hover { background-color: #b71c1c; }
    .kpi-card { border-left: 6px solid #1b5e20; }
    .small-muted { font-size: .85rem; color: #6c757d; }
    .table-responsive { max-height: 55vh; overflow:auto; }
  </style>
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-lg">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-badge-fill me-2"></i>Headteacher Dashboard</a>
      <div class="ms-auto">
        <form action="{{ url_for('user_routes.logout') }}" method="get" class="d-inline">
          <button type="submit" class="btn logout-btn">
            <i class="bi bi-box-arrow-right me-1"></i>Logout
          </button>
        </form>
      </div>
    </div>
  </nav>
  <main class="container my-4">
    <div class="row g-3">
      <!-- KPI cards -->
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Staff</h6>
                <h3 id="totalStaff">--</h3>
                <div class="small-muted">All active employees</div>
              </div>
              <div class="display-6 text-success"><i class="bi bi-people-fill"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Payroll</h6>
                <h3 id="totalPayroll">--</h3>
                <div class="small-muted">Monthly gross</div>
              </div>
              <div class="display-6 text-warning"><i class="bi bi-cash-stack"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Pupils</h6>
                <h3 id="totalPupils">--</h3>
                <div class="small-muted">Enrolled pupils</div>
              </div>
              <div class="display-6 text-primary"><i class="bi bi-people"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Attendance (Today)</h6>
                <h3 id="attendanceToday">--</h3>
                <div class="small-muted">Staff present</div>
              </div>
              <div class="display-6 text-info"><i class="bi bi-calendar-check-fill"></i></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12 col-xl-8">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Staff Directory</strong>
            <div>
              <input id="staffSearch" class="form-control form-control-sm" placeholder="Search staff..." style="width:220px; display:inline-block;" />
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Salary</th>
                    <th>Last Paid</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="staffTableBody">
                  <!-- populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header"><strong>Pupils Breakdown</strong></div>
          <div class="card-body">
            <div id="pupilsByClass" class="small-muted">Loading...</div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Today's Attendance</strong>
            <small class="small-muted">Mark present/absent</small>
          </div>
          <div class="card-body p-2">
            <div class="d-flex gap-2 mb-2 align-items-center">
              <label class="small-muted mb-0">Date</label>
              <input type="date" id="attendanceDate" class="form-control form-control-sm" style="width:150px;" />
              <label class="small-muted mb-0">Term</label>
              <select id="attendanceTerm" class="form-select form-select-sm" style="width:120px;">
                <option>Term 1</option>
                <option>Term 2</option>
                <option>Term 3</option>
              </select>
              <label class="small-muted mb-0">Year</label>
              <select id="attendanceYear" class="form-select form-select-sm" style="width:100px;"></select>
            </div>

            <div class="d-flex gap-2 mb-2">
              <button id="markAllPresent" class="btn btn-sm btn-outline-success">Mark all present</button>
              <button id="markAllAbsent" class="btn btn-sm btn-outline-secondary">Mark all absent</button>
              <div class="ms-auto small-muted align-self-center" id="attendanceCounts">Present: 0 / 0</div>
            </div>

            <div id="attendanceList" style="max-height:40vh; overflow:auto;"></div>
            <div class="mt-2 text-end">
              <button id="saveAttendance" class="btn btn-sm btn-success">Save Attendance</button>
              <button id="viewAttendanceSummary" class="btn btn-sm btn-info d-none">View Summary</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Salary edit modal -->
    <div class="modal fade" id="editSalaryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Salary</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="editSalaryForm">
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Staff</label>
                <input type="text" id="modalStaffName" class="form-control" readonly />
              </div>
              <div class="mb-2">
                <label class="form-label">Salary (e.g. 300000)</label>
                <input type="number" id="modalSalary" class="form-control" required min="0" />
              </div>
              <div class="mb-2">
                <label class="form-label">Reason</label>
                <input type="text" id="modalReason" class="form-control" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

    function formatCurrency(n){
      if (n == null) return 'UGX 0';
      return 'UGX ' + Number(n).toLocaleString();
    }

    async function loadSummary(){
      try{
        const res = await fetch('/headteacher/api/summary');
        if (!res.ok) throw new Error('No summary');
        const data = await res.json();
        document.getElementById('totalStaff').textContent = data.total_staff || 0;
        // salary_payments_total may be a string or number
        const totalPayrollNum = Number(data.salary_payments_total || 0);
        document.getElementById('totalPayroll').textContent = formatCurrency(totalPayrollNum);
        document.getElementById('totalPupils').textContent = data.total_pupils || 0;
        renderPupilsByClass(data.pupils_by_class || []);

        // load today's attendance count separately
        const today = new Date().toISOString().slice(0,10);
        const attRes = await fetch(`/headteacher/api/attendance?date=${today}`);
        if (attRes.ok){
          const att = await attRes.json();
          const present = Array.isArray(att) ? att.filter(r=> r.status === 'present').length : 0;
          document.getElementById('attendanceToday').textContent = present;
        }
      }catch(e){ console.warn('Summary load failed', e); }
    }

    function renderPupilsByClass(list){
      const el = document.getElementById('pupilsByClass');
      if (!list.length){ el.innerHTML = '<div class="small-muted">No data</div>'; return; }
      let html = '<ul class="list-unstyled mb-0">';
      list.forEach(item=> html += `<li><strong>${item.class_name}</strong>: ${item.count} pupils</li>`);
      html += '</ul>';
      el.innerHTML = html;
    }

    let staffCache = [];
    let saveDisabled = false;
    async function loadStaff(){
      try{
        const res = await fetch('/headteacher/api/staff');
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        // API returns an array of staff objects
        staffCache = (Array.isArray(data) ? data : [] ).map(u => {
          const name = `${u.first_name || ''} ${u.last_name || ''}`.trim();
          // salary_override may be string; convert to cents
          let salary_cents = null;
          if (u.salary_override !== null && u.salary_override !== undefined){
            salary_cents = Math.round(Number(u.salary_override) * 100);
          }
          const last_paid = u.latest_payment ? (u.latest_payment.date || null) : null;
          return {
            id: u.id,
            name,
            role: u.role || '',
            salary_cents: salary_cents || 0,
            last_paid: last_paid,
          };
        });

        // ensure attendance date control is set
        const dateInput = document.getElementById('attendanceDate');
        if (!dateInput.value) dateInput.value = new Date().toISOString().slice(0,10);

        // fetch attendance for the selected date to mark checkboxes
        const today = dateInput.value || new Date().toISOString().slice(0,10);
        const attRes = await fetch(`/headteacher/api/attendance?date=${today}`);
        let attendanceMap = {};
        if (attRes.ok){
          const arr = await attRes.json();
          if (Array.isArray(arr)){
            arr.forEach(r=> { attendanceMap[String(r.staff_id)] = r.status; });
          }
        }

        renderStaffTable(staffCache);
        renderAttendanceList(staffCache, attendanceMap);
        updateAttendanceCounts();
        // disable saving if attendance already exists for this date
        saveDisabled = Array.isArray(attendanceMap) ? attendanceMap.length>0 : Object.keys(attendanceMap).length>0;
        document.getElementById('saveAttendance').disabled = saveDisabled;
        if (saveDisabled) document.getElementById('viewAttendanceSummary').classList.remove('d-none');
      }catch(e){ console.warn('Staff load failed', e); }
    }

    function renderStaffTable(list){
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';
      list.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.role}</td>
          <td class="salaryCell d-none d-md-table-cell">${formatCurrency((s.salary_cents||0)/100)}</td>
          <td class="d-none d-md-table-cell">${s.last_paid || '-'}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal(${s.id})">Edit</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // update present/total counts in attendance panel
    function updateAttendanceCounts(){
      const checks = Array.from(document.querySelectorAll('#attendanceList input[type=checkbox]'));
      const total = checks.length;
      const present = checks.filter(cb=> cb.checked).length;
      document.getElementById('attendanceCounts').textContent = `Present: ${present} / ${total}`;
    }

    function renderAttendanceList(list, attendanceMap={}){
      const wrap = document.getElementById('attendanceList');
      wrap.innerHTML = '';
      list.forEach(s => {
        const id = 'att-'+s.id;
        const status = attendanceMap[String(s.id)] || 'absent';
        const checked = status === 'present' ? 'checked' : '';
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center justify-content-between py-1 border-bottom';
        div.innerHTML = `<div>${s.name} <div class="small-muted">${s.role}</div></div><div><input type="checkbox" id="${id}" data-staff="${s.id}" ${checked} /></div>`;
        wrap.appendChild(div);
        // attach change handler to update counts
        const cb = div.querySelector('input[type=checkbox]');
        if (cb){ cb.addEventListener('change', updateAttendanceCounts); }
      });
    }

    function openEditModal(staffId){
      const staff = staffCache.find(s=> s.id===staffId);
      if (!staff) return;
      document.getElementById('modalStaffName').value = staff.name;
      document.getElementById('modalSalary').value = Math.round((staff.salary_cents||0)/100);
      document.getElementById('modalReason').value = '';
      const modalEl = document.getElementById('editSalaryModal');
      modalEl.dataset.staffId = staffId;
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    document.getElementById('editSalaryForm').addEventListener('submit', async function(ev){
      ev.preventDefault();
      const modalEl = document.getElementById('editSalaryModal');
      const staffId = modalEl.dataset.staffId;
      const salary = Number(document.getElementById('modalSalary').value) * 100;
      const reason = document.getElementById('modalReason').value || '';
      try{
        // create a salary payment record via API
        const payload = { user_id: staffId, amount: (salary/100).toString(), reference: reason };
        const res = await fetch(`/headteacher/api/salary_payments`, {
          method: 'POST', headers: {'Content-Type':'application/json', 'X-CSRFToken': csrfToken},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Save failed');
        // update cache and UI: don't assume salary_cents stored; just refresh staff
        await loadStaff();
        bootstrap.Modal.getInstance(modalEl).hide();
        alert('Salary payment recorded');
      }catch(e){ alert('Could not save salary: '+e.message); }
    });

    document.getElementById('staffSearch').addEventListener('input', function(){
      const q = this.value.toLowerCase().trim();
      if (!q) return renderStaffTable(staffCache);
      const filtered = staffCache.filter(s => (s.name||'').toLowerCase().includes(q) || (s.role||'').toLowerCase().includes(q));
      renderStaffTable(filtered);
    });

    document.getElementById('saveAttendance').addEventListener('click', async function(){
      // prevent saving if already saved for this date
      if (saveDisabled) { alert('Attendance already saved for this date'); return; }
      const checks = Array.from(document.querySelectorAll('#attendanceList input[type=checkbox]'));
      const today = document.getElementById('attendanceDate').value || new Date().toISOString().slice(0,10);
      try{
        // send each attendance record individually
        await Promise.all(checks.map(cb => {
          const staffId = Number(cb.dataset.staff);
          const status = cb.checked ? 'present' : 'absent';
          return fetch('/headteacher/api/attendance', {
            method: 'POST', headers: {'Content-Type':'application/json','X-CSRFToken': csrfToken},
            body: JSON.stringify({staff_id: staffId, date: today, status, recorded_by: null})
          }).then(r=>{ if (!r.ok) throw new Error('One save failed'); return r.json(); });
        }));
        alert('Attendance saved');
        // disable save after successful save
        saveDisabled = true;
        document.getElementById('saveAttendance').disabled = true;
        document.getElementById('viewAttendanceSummary').classList.remove('d-none');
        await loadSummary();
      }catch(e){ alert('Could not save attendance: '+e.message); }
    });

    // mark all controls
    document.getElementById('markAllPresent').addEventListener('click', function(){
      document.querySelectorAll('#attendanceList input[type=checkbox]').forEach(cb=> cb.checked = true);
      updateAttendanceCounts();
    });
    document.getElementById('markAllAbsent').addEventListener('click', function(){
      document.querySelectorAll('#attendanceList input[type=checkbox]').forEach(cb=> cb.checked = false);
      updateAttendanceCounts();
    });

    // handle attendance date change
    document.getElementById('attendanceDate').addEventListener('change', async function(){
      // reload staff attendance for the selected date
      await loadStaff();
    });

    // populate year selector
    (function populateYears(){
      const sel = document.getElementById('attendanceYear');
      const now = new Date();
      const year = now.getFullYear();
      for (let y = year-1; y <= year+1; y++){
        const opt = document.createElement('option'); opt.value = y; opt.textContent = y; if (y===year) opt.selected = true; sel.appendChild(opt);
      }
    })();

    // view attendance summary (weekly/monthly/termly)
    document.getElementById('viewAttendanceSummary').addEventListener('click', async function(){
      const today = new Date(document.getElementById('attendanceDate').value || new Date().toISOString().slice(0,10));
      // compute ranges
      const ranges = [
        { label: 'Weekly', days: 7 },
        { label: 'Monthly', days: 30 },
        { label: 'Termly (3.5 months)', days: 105 }
      ];
      const results = [];
      for (const r of ranges){
        const start = new Date(today);
        start.setDate(today.getDate() - (r.days-1));
        // fetch attendance for each day in range
        let presentCount = 0;
        let dayCount = 0;
        for (let d = new Date(start); d <= today; d.setDate(d.getDate()+1)){
          const ds = d.toISOString().slice(0,10);
          try{
            const resp = await fetch(`/headteacher/api/attendance?date=${ds}`);
            if (!resp.ok) continue;
            const arr = await resp.json();
            if (Array.isArray(arr)){
              dayCount += arr.length ? 1 : 0; // count days with records
              presentCount += arr.filter(x=> x.status === 'present').length;
            }
          }catch(e){ /* ignore */ }
        }
        results.push({ label: r.label, presentCount, dayCount });
      }
      // show brief modal with results
      alert(results.map(x=> `${x.label}: present entries ${x.presentCount}, days with records ${x.dayCount}`).join('\n'));
    });

    // initial load
    // Helper: ensure page can scroll to bottom of last card and detect when last card is near footer on mobile
    function setupScrollBehavior(){
      const footer = document.querySelector('footer') || document.querySelector('.footer');
      const lastCard = document.querySelector('main .card:last-of-type');
      if (!lastCard) return;

      // apply padding-bottom so last card can scroll above footer
      function updatePadding(){
        const footerHeight = footer ? footer.getBoundingClientRect().height : 0;
        // add a little extra spacing
        document.body.style.paddingBottom = (footerHeight + 20) + 'px';
      }

      // detect when the distance from bottom of last card to top of footer is <= 20px (mobile)
      let rafPending = false;
      function checkNearFooter(){
        if (rafPending) return;
        rafPending = true;
        window.requestAnimationFrame(()=>{
          rafPending = false;
          const footerRect = footer ? footer.getBoundingClientRect() : { top: window.innerHeight };
          const lastRect = lastCard.getBoundingClientRect();
          const distance = footerRect.top - lastRect.bottom;
          const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
          if (isMobile && distance <= 20){
            document.body.classList.add('near-footer');
            if (footer) footer.classList.add('near-footer');
            // emit custom event in case other scripts want to react
            document.dispatchEvent(new CustomEvent('nearFooter', { detail: { distance }}));
          } else {
            document.body.classList.remove('near-footer');
            if (footer) footer.classList.remove('near-footer');
          }
        });
      }

      // smooth scroll helper to ensure the bottom of the last card is reachable
      function scrollToLastCard(){
        try{
          lastCard.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }catch(e){ /* ignore */ }
      }

      // initial setup
      updatePadding();
      checkNearFooter();

      // event listeners
      window.addEventListener('resize', ()=>{ updatePadding(); checkNearFooter(); });
      window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ updatePadding(); checkNearFooter(); }, 200); });
      // scroll handling: check during scroll, and on scroll end nudge last card into view if needed
      let scrollEndTimer = null;
      window.addEventListener('scroll', ()=>{
        checkNearFooter();
        if (scrollEndTimer) clearTimeout(scrollEndTimer);
        scrollEndTimer = setTimeout(()=>{
          // on scroll end, if near footer, nudge into view
          const footerRect = footer ? footer.getBoundingClientRect() : { top: window.innerHeight };
          const lastRect = lastCard.getBoundingClientRect();
          const distance = footerRect.top - lastRect.bottom;
          const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
          if (isMobile && distance > 0 && distance <= 40){
            scrollToLastCard();
          }
        }, 150);
      }, { passive: true });

      // expose for debugging/use
      window.scrollToLastCard = scrollToLastCard;
    }

    (function(){ loadSummary(); loadStaff(); setupScrollBehavior(); })();
  </script>
  {% include 'footer.html' %}
</body>
</html>