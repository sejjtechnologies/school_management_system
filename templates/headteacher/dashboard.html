<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Headteacher Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* reduced top nav height and spacing */
    body { padding-top: 60px; background-color: #f1f8e9; font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: #1b5e20; height: 60px; }
    .navbar .container-fluid { height: 60px; align-items: center; }
    .navbar-brand, .nav-link { color: #fff !important; }
    .navbar-brand { font-size: 0.98rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .navbar-brand i { font-size: 1.05rem; }
    /* smaller, flatter logout/back button */
    .logout-btn { background-color: #d32f2f; color: #fff; border: none; padding: .25rem .5rem; font-size: .85rem; height: 34px; line-height: 1.1; border-radius: 6px; }
    .logout-btn i { font-size: 0.95rem; margin-right: 6px; }
    .logout-btn:hover { background-color: #b71c1c; }
    .kpi-card { border-left: 6px solid #1b5e20; }
    .small-muted { font-size: .85rem; color: #6c757d; }
    .table-responsive { max-height: 55vh; overflow:auto; }
    /* attendance UI helpers */
    .attendance-controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .attendance-controls .form-control, .attendance-controls .form-select { min-width:0; }
    #attendanceList .att-row { display:flex; align-items:center; justify-content:space-between; padding:.375rem 0; border-bottom:1px solid rgba(0,0,0,0.05); }
    .att-icon { margin-right:8px; display:inline-flex; align-items:center; }
    .att-name { flex:1 1 auto; min-width:0; }
    .att-actions { flex:0 0 auto; margin-left:8px; }
    /* toast notification styles */
    .toast-container-fixed { position: fixed; top: 80px; right: 20px; z-index: 9999; }
    .toast { min-width: 300px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .toast.success { background-color: #d4edda; border-left: 4px solid #28a745; }
    .toast.error { background-color: #f8d7da; border-left: 4px solid #dc3545; }
    .toast.success .toast-body { color: #155724; font-weight: 600; }
    .toast.error .toast-body { color: #721c24; font-weight: 600; }
    /* attendance info display */
    .attendance-info { display: flex; flex-wrap:wrap; gap: 8px; align-items: center; padding: 4px 0 0 0; margin-top:6px; font-size: 0.72rem; }
    .attendance-info-item { display: inline-flex; gap: 6px; align-items: center; white-space:nowrap; }
    .attendance-info-label { font-weight: 700; color: #495057; font-size:0.68rem; }
    .attendance-info-value { color: #1b5e20; font-weight: 600; font-size:0.72rem; }
    /* make KPI card content compact so icon stays inside card */
    .kpi-card .card-body { padding: .65rem .9rem; }
    .kpi-card h6 { font-size: 0.8rem; }
    .kpi-card h3 { font-size: 1.4rem; margin: 0.15rem 0; }
    .kpi-card .display-6 { font-size: 1.6rem; }
    .kpi-card .kpi-left { flex: 1 1 auto; min-width:0; }
    .kpi-card .kpi-icon { flex: 0 0 auto; margin-left: 10px; }
    /* smaller saved timestamp to avoid increasing card height */
    .attendance-info-saved { font-size: 0.72rem; color: #495057; font-weight: 500; opacity: 0.95; }
    /* Compact staff table to reduce row height and column padding */
    .table-compact { font-size: 0.88rem; }
    .table-compact th, .table-compact td { padding: 0.32rem 0.5rem; }
    .table-compact td { line-height: 1.05; }
  </style>
</head>
<body>
  <nav class="navbar fixed-top navbar-expand-lg">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-badge-fill me-2"></i>Headteacher Dashboard</a>
      <div class="ms-auto">
        <form action="{{ url_for('user_routes.logout') }}" method="get" class="d-inline">
          <button type="submit" class="btn logout-btn">
            <i class="bi bi-box-arrow-right me-1"></i>Logout
          </button>
        </form>
      </div>
    </div>
  </nav>
  <main class="container my-4 main-scroll">
    <div class="row g-3">
      <!-- KPI cards -->
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div class="kpi-left">
                <h6 class="mb-0">Total Staff</h6>
                <h3 id="totalStaff">--</h3>
                <div class="small-muted">All active employees</div>
              </div>
              <div class="display-6 text-success"><i class="bi bi-people-fill"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Payroll</h6>
                <h3 id="totalPayroll">--</h3>
                <div class="small-muted">Monthly gross</div>
              </div>
              <div class="display-6 text-warning"><i class="bi bi-cash-stack"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Pupils</h6>
                <h3 id="totalPupils">--</h3>
                <div class="small-muted">Enrolled pupils</div>
              </div>
              <div class="display-6 text-primary"><i class="bi bi-people"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Attendance (Today)</h6>
                <h3 id="attendanceToday">--</h3>
                <div class="small-muted">Staff present</div>
                <!-- moved attendance info (date, saved, term, year) here to keep dashboard compact -->
                <div class="attendance-info mt-2">
                  <div class="attendance-info-item">
                    <span class="attendance-info-label">Date:</span>
                    <span class="attendance-info-value" id="attendanceInfoDate">--</span>
                  </div>
                  <div class="attendance-info-item">
                    <span class="attendance-info-label">Saved:</span>
                    <span class="attendance-info-value attendance-info-saved" id="attendanceInfoSaved">--</span>
                  </div>
                  <div class="attendance-info-item">
                    <span class="attendance-info-label">Term:</span>
                    <span class="attendance-info-value" id="attendanceInfoTerm">--</span>
                  </div>
                  <div class="attendance-info-item">
                    <span class="attendance-info-label">Year:</span>
                    <span class="attendance-info-value" id="attendanceInfoYear">--</span>
                  </div>
                </div>
              </div>
              <div class="kpi-icon display-6 text-info"><i class="bi bi-calendar-check-fill"></i></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12 col-xl-8">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Staff Directory</strong>
            <div>
              <input id="staffSearch" class="form-control form-control-sm" placeholder="Search staff..." style="width:220px; display:inline-block;" />
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0 table-compact">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th style="width:140px">Salary</th>
                    <th style="max-width:110px">Last Paid</th>
                  </tr>
                </thead>
                <tbody id="staffTableBody">
                  <!-- populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header"><strong>Pupils Breakdown</strong></div>
          <div class="card-body">
            <div id="pupilsByClass" class="small-muted">Loading...</div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Today's Attendance</strong>
            <small class="small-muted">Mark present/absent</small>
          </div>
          <div class="card-body p-2">
            <!-- moved attendance info to the Attendance KPI card at the top -->

            <div class="attendance-controls mb-2">
              <label class="small-muted mb-0">Date</label>
              <input type="date" id="attendanceDate" class="form-control form-control-sm" />
              <label class="small-muted mb-0">Term</label>
              <select id="attendanceTerm" class="form-select form-select-sm">
                <option>Term 1</option>
                <option>Term 2</option>
                <option>Term 3</option>
              </select>
              <label class="small-muted mb-0">Year</label>
              <select id="attendanceYear" class="form-select form-select-sm"></select>
            </div>

            <div class="d-flex gap-2 mb-2">
              <button id="markAllPresent" class="btn btn-sm btn-outline-success">Mark all present</button>
              <button id="markAllAbsent" class="btn btn-sm btn-outline-secondary">Mark all absent</button>
              <div class="ms-auto small-muted align-self-center" id="attendanceCounts">Present: 0 / 0</div>
            </div>

            <div id="attendanceList" style="max-height:40vh; overflow:auto;"></div>
            <div class="mt-2 text-end">
              <button id="saveAttendance" class="btn btn-sm btn-success">Save Attendance</button>
              <button id="viewAttendanceSummary" class="btn btn-sm btn-info d-none">View Summary</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Salary edit modal -->
    <div class="modal fade" id="editSalaryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Salary</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="editSalaryForm">
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Staff</label>
                <input type="text" id="modalStaffName" class="form-control" readonly />
              </div>
              <div class="mb-2">
                <label class="form-label">Salary (e.g. 300000)</label>
                <input type="number" id="modalSalary" class="form-control" required min="0" />
              </div>
              <div class="mb-2">
                <label class="form-label">Reason</label>
                <input type="text" id="modalReason" class="form-control" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Attendance Summary Modal (replaces browser alert) -->
    <div class="modal fade" id="attendanceSummaryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Attendance Summary</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="attendanceSummaryBody">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Toast container for notifications -->
    <div class="toast-container-fixed" id="toastContainer"></div>

    <!-- Role salaries management card -->
    <div class="card shadow-sm mt-3" id="roleSalaryCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Manage Role Salaries</strong>
        <small class="small-muted">Edit salary defaults per role (excl. Parent)</small>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr><th>Role</th><th style="width:200px">Salary</th><th style="width:90px"></th></tr>
            </thead>
            <tbody id="roleSalaryTableBody">
              <tr><td colspan="3" class="small-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

    // Toast notification helper
    function showToast(message, type='success', duration=1000){
      const container = document.getElementById('toastContainer');
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type} show`;
      toastEl.setAttribute('role', 'alert');
      toastEl.innerHTML = `<div class="toast-body">${message}</div>`;
      container.appendChild(toastEl);

      // auto-remove after duration
      setTimeout(()=>{
        toastEl.remove();
      }, duration);
    }

    // Override native alert() to use Bootstrap toasts for consistent UX
    window.alert = function(msg){
      try{ showToast(String(msg), 'info', 2500); }catch(e){ console.log('alert:', msg); }
    };

    function formatCurrency(n){
      if (n == null) return 'UGX 0';
      return 'UGX ' + Number(n).toLocaleString();
    }

    async function loadSummary(){
      try{
        const res = await fetch('/headteacher/api/summary');
        if (!res.ok) throw new Error('No summary');
        const data = await res.json();
        document.getElementById('totalStaff').textContent = data.total_staff || 0;
        // salary_payments_total may be a string or number
        const totalPayrollNum = Number(data.salary_payments_total || 0);
        document.getElementById('totalPayroll').textContent = formatCurrency(totalPayrollNum);
        document.getElementById('totalPupils').textContent = data.total_pupils || 0;
        renderPupilsByClass(data.pupils_by_class || []);

        // load today's attendance count separately
        const today = new Date().toISOString().slice(0,10);
        const attRes = await fetch(`/headteacher/api/attendance?date=${today}`);
        if (attRes.ok){
          const att = await attRes.json();
          const present = Array.isArray(att) ? att.filter(r=> r.status === 'present').length : 0;
          document.getElementById('attendanceToday').textContent = present;
        }
      }catch(e){ console.warn('Summary load failed', e); }
    }

    function renderPupilsByClass(list){
      const el = document.getElementById('pupilsByClass');
      if (!list.length){ el.innerHTML = '<div class="small-muted">No data</div>'; return; }
      let html = '<ul class="list-unstyled mb-0">';
      list.forEach(item=> html += `<li><strong>${item.class_name}</strong>: ${item.count} pupils</li>`);
      html += '</ul>';
      el.innerHTML = html;
    }

    let staffCache = [];
    let saveDisabled = false;
    let roleSalaryMap = {}; // maps role name -> amount (number)

    // Fetch role salaries via API and populate roleSalaryMap. Render editable table.
    async function loadRoleSalaries(){
      try{
        const res = await fetch('/headteacher/api/role_salaries');
        if (!res.ok) throw new Error('Failed to load role salaries');
        const body = await res.json();
        const list = Array.isArray(body.role_salaries) ? body.role_salaries : (Array.isArray(body) ? body : []);
        // clear map
        roleSalaryMap = {};
        list.forEach(r => {
          if (r && r.role_name && r.role_name.toLowerCase() !== 'parent'){
            roleSalaryMap[r.role_name] = (r.amount !== null && r.amount !== undefined) ? Number(r.amount) : 0;
          }
        });
        renderRoleSalariesTable(list.filter(r=> r && r.role_name && r.role_name.toLowerCase() !== 'parent'));
      }catch(e){ console.warn('Could not load role salaries', e); renderRoleSalariesTable([]); }
    }

    function renderRoleSalariesTable(list){
      const tbody = document.getElementById('roleSalaryTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      list.forEach(r => {
        const tr = document.createElement('tr');
        const amountVal = (r && r.amount) ? Number(r.amount) : 0;
        const roleName = r.role_name || '';
        tr.innerHTML = `
          <td class="align-middle">${roleName}</td>
          <td><input type="number" min="0" class="form-control form-control-sm role-salary-input" data-role-id="${r.role_id || ''}" data-id="${r.id || ''}" data-role-name="${roleName}" value="${amountVal}" /></td>
          <td class="text-end align-middle"><button class="btn btn-sm btn-primary role-salary-save">Save</button></td>
        `;
        tbody.appendChild(tr);
        const btn = tr.querySelector('.role-salary-save');
        const input = tr.querySelector('.role-salary-input');
        // remember original value for blur auto-save
        input.dataset.original = String(amountVal);

        // click handler for explicit save
        btn.addEventListener('click', async ()=>{
          const val = Number(input.value || 0);
          const rsId = input.dataset.id ? Number(input.dataset.id) : null;
          const roleId = input.dataset.roleId ? Number(input.dataset.roleId) : null;
          await saveRoleSalary(rsId, roleId, val, input, btn);
        });

        // press Enter to save
        input.addEventListener('keydown', async (ev)=>{
          if (ev.key === 'Enter'){
            ev.preventDefault();
            btn.click();
          }
        });

        // blur: auto-save if changed
        input.addEventListener('blur', async ()=>{
          if (input.dataset.original !== undefined && String(input.value) !== input.dataset.original){
            btn.click();
          }
        });
      });
    }

    async function saveRoleSalary(rsId, roleId, amount, inputEl, btnEl){
      try{
        btnEl.disabled = true;
        btnEl.textContent = 'Saving...';
        let res;
        if (rsId){
          // update
          res = await fetch('/headteacher/api/role_salaries', {
            method: 'PUT', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: rsId, amount: String(amount) })
          });
        } else {
          // create
          res = await fetch('/headteacher/api/role_salaries', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ role_id: roleId, amount: String(amount) })
          });
        }
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Save failed');
        showToast('Role salary saved', 'success', 1200);
        // refresh list and staff display
        await loadRoleSalaries();
        // update staff salaries display quickly
        try{ loadStaff(); loadSummary(); }catch(e){}
      }catch(e){ showToast('Could not save role salary: '+e.message, 'error', 1500); }
      finally{ btnEl.disabled = false; btnEl.textContent = 'Save'; }
    }


    // Format timestamp (ISO) to East African 12-hour format with AM/PM
    function formatEastAfricanTime(isoStr){
      if (!isoStr) return '-';
      try{
        const d = new Date(isoStr);
        // Use local timezone (assumes server times are UTC or already localized)
        let h = d.getHours();
        const m = d.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
      }catch(e){ return '-'; }
    }
    async function loadStaff(){
      try{
        const res = await fetch('/headteacher/api/staff');
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        // API returns an array of staff objects
        staffCache = (Array.isArray(data) ? data : [] ).map(u => {
          const name = `${u.first_name || ''} ${u.last_name || ''}`.trim();
          // salary_override may be string; convert to cents. If missing, use roleSalaryMap
          let salary_cents = null;
          if (u.salary_override !== null && u.salary_override !== undefined){
            salary_cents = Math.round(Number(u.salary_override) * 100);
          } else if (u.role && roleSalaryMap[u.role] !== undefined){
            salary_cents = Math.round(Number(roleSalaryMap[u.role]) * 100);
          }
          const last_paid = u.latest_payment ? (u.latest_payment.date || null) : null;
          return {
            id: u.id,
            name,
            role: u.role || '',
            salary_cents: salary_cents || 0,
            last_paid: last_paid,
          };
        });

        // ensure attendance date control is set
        const dateInput = document.getElementById('attendanceDate');
        if (!dateInput.value) dateInput.value = new Date().toISOString().slice(0,10);

        // fetch attendance for the selected date to mark checkboxes and obtain saved metadata
        const today = dateInput.value || new Date().toISOString().slice(0,10);
        const attRes = await fetch(`/headteacher/api/attendance?date=${today}`);
        let attendanceMap = {};
        let attendanceArr = [];
        let latestSavedDate = null;
        let savedTerm = null;
        let savedYear = null;
        if (attRes.ok){
          const arr = await attRes.json();
          if (Array.isArray(arr)){
            attendanceArr = arr;
            arr.forEach(r=> {
              attendanceMap[String(r.staff_id)] = r.status;
              // prefer updated_at timestamp; fallback to created_at
              if (r.updated_at || r.created_at){
                const ts = new Date(r.updated_at || r.created_at);
                if (!latestSavedDate || ts > latestSavedDate) {
                  latestSavedDate = ts;
                  // capture the term/year from the record that has the latest timestamp
                  savedTerm = r.term || savedTerm;
                  savedYear = (r.year || r.year === 0) ? r.year : savedYear;
                }
              }
            });
          }
        }

        renderStaffTable(staffCache);
        renderAttendanceList(staffCache, attendanceMap);
        updateAttendanceCounts();
          // Update KPI attendance count to reflect the selected date's attendance
          try{
            const presentCount = Object.values(attendanceMap).filter(s => s === 'present').length;
            document.getElementById('attendanceToday').textContent = presentCount;
          }catch(e){ /* ignore */ }
        // update attendance info display: show saved timestamp and saved term/year if available
        if (latestSavedDate){
          updateAttendanceInfoWithSaved(latestSavedDate, savedTerm, savedYear);
        } else {
          updateAttendanceInfo();
        }
        // disable saving if attendance already exists for this date
        saveDisabled = Array.isArray(attendanceMap) ? attendanceMap.length>0 : Object.keys(attendanceMap).length>0;
        document.getElementById('saveAttendance').disabled = saveDisabled;
        if (saveDisabled) document.getElementById('viewAttendanceSummary').classList.remove('d-none');
        // notify that dashboard content (staff/attendance) has been rendered
        try{ document.dispatchEvent(new Event('dashboardContentReady')); }catch(e){}
      }catch(e){ console.warn('Staff load failed', e); }
    }

    function renderStaffTable(list){
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';
      list.forEach(s => {
        const tr = document.createElement('tr');
        const lastPaidDisplay = s.last_paid ? formatEastAfricanTime(s.last_paid) : '-';
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.role}</td>
          <td>${formatCurrency((s.salary_cents||0)/100)}</td>
          <td style="font-size:0.85rem;">${lastPaidDisplay}</td>`;
        tbody.appendChild(tr);
      });
    }

    // update present/total counts in attendance panel
    function updateAttendanceCounts(){
      const checks = Array.from(document.querySelectorAll('#attendanceList input[type=checkbox]'));
      const total = checks.length;
      const present = checks.filter(cb=> cb.checked).length;
      document.getElementById('attendanceCounts').textContent = `Present: ${present} / ${total}`;
    }

    function setAttendanceIcon(cb){
      const iconSpan = cb.closest('.att-row').querySelector('.att-icon');
      if (!iconSpan) return;
      if (cb.checked){
        iconSpan.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
      } else {
        iconSpan.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
      }
    }

    function renderAttendanceList(list, attendanceMap={}){
      const wrap = document.getElementById('attendanceList');
      wrap.innerHTML = '';
      list.forEach(s => {
        const id = 'att-'+s.id;
        const status = attendanceMap[String(s.id)] || 'absent';
        const checked = status === 'present';
        const row = document.createElement('div');
        row.className = 'att-row';
        row.innerHTML = `
          <div class="att-name"><span class="att-icon">${checked?'<i class="bi bi-check-circle-fill text-success"></i>':'<i class="bi bi-x-circle-fill text-danger"></i>'}</span><strong>${s.name}</strong><div class="small-muted">${s.role}</div></div>
          <div class="att-actions"><input type="checkbox" id="${id}" data-staff="${s.id}" ${checked? 'checked' : ''} /></div>`;
        wrap.appendChild(row);
        // attach change handler to update counts and icon
        const cb = row.querySelector('input[type=checkbox]');
        if (cb){ cb.addEventListener('change', function(){ setAttendanceIcon(cb); updateAttendanceCounts(); }); }
      });
    }

    function openEditModal(staffId){
      const staff = staffCache.find(s=> s.id===staffId);
      if (!staff) return;
      document.getElementById('modalStaffName').value = staff.name;
      document.getElementById('modalSalary').value = Math.round((staff.salary_cents||0)/100);
      document.getElementById('modalReason').value = '';
      const modalEl = document.getElementById('editSalaryModal');
      modalEl.dataset.staffId = staffId;
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    document.getElementById('editSalaryForm').addEventListener('submit', async function(ev){
      ev.preventDefault();
      const modalEl = document.getElementById('editSalaryModal');
      const staffId = modalEl.dataset.staffId;
      const salary = Number(document.getElementById('modalSalary').value) * 100;
      const reason = document.getElementById('modalReason').value || '';
      try{
        // create a salary payment record via API
        const payload = { user_id: staffId, amount: (salary/100).toString(), reference: reason };
        const res = await fetch(`/headteacher/api/salary_payments`, {
          method: 'POST', headers: {'Content-Type':'application/json', 'X-CSRFToken': csrfToken},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Save failed');
        // update cache and UI: don't assume salary_cents stored; just refresh staff
        await loadStaff();
        bootstrap.Modal.getInstance(modalEl).hide();
        showToast('Salary payment recorded', 'success', 1000);
      }catch(e){ showToast('Could not save salary: '+e.message, 'error', 1000); }
    });

    document.getElementById('staffSearch').addEventListener('input', function(){
      const q = this.value.toLowerCase().trim();
      if (!q) return renderStaffTable(staffCache);
      const filtered = staffCache.filter(s => (s.name||'').toLowerCase().includes(q) || (s.role||'').toLowerCase().includes(q));
      renderStaffTable(filtered);
    });

    document.getElementById('saveAttendance').addEventListener('click', async function(){
      // prevent saving if already saved for this date
      if (saveDisabled) { showToast('Attendance already saved for this date', 'error', 1000); return; }
      const checks = Array.from(document.querySelectorAll('#attendanceList input[type=checkbox]'));
      const dateVal = document.getElementById('attendanceDate').value || new Date().toISOString().slice(0,10);
      const term = document.getElementById('attendanceTerm').value || null;
      const year = document.getElementById('attendanceYear').value ? Number(document.getElementById('attendanceYear').value) : null;
      const payload = checks.map(cb => ({
        staff_id: Number(cb.dataset.staff),
        date: dateVal,
        status: cb.checked ? 'present' : 'absent',
        recorded_by: null,
        term: term,
        year: year
      }));

      const saveBtn = document.getElementById('saveAttendance');
      const originalText = saveBtn.textContent;
      const originalClass = saveBtn.className;

      try{
        // Change button to saving state
        saveBtn.textContent = 'Saving...';
        saveBtn.className = 'btn btn-sm btn-danger';
        saveBtn.disabled = true;

        const res = await fetch('/headteacher/api/attendance/batch', {
          method: 'POST', headers: {'Content-Type':'application/json','X-CSRFToken': csrfToken},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Batch save failed');
        if (data.errors && data.errors.length){
          console.warn('Some attendance rows failed', data.errors);
          showToast('Attendance saved with some errors, check console', 'error', 1000);
        } else {
          showToast('Attendance saved successfully', 'success', 1000);
        }
        // Immediately refresh attendance UI from server so counts reflect saved state
        try{
          await loadStaff();
          await loadSummary();
        }catch(e){ console.warn('Refresh after save failed', e); }
        // disable save after successful save
        saveDisabled = true;
        document.getElementById('viewAttendanceSummary').classList.remove('d-none');
        // restore button to original state but keep disabled to prevent double saves
        saveBtn.textContent = originalText;
        saveBtn.className = originalClass;
        saveBtn.disabled = true;
        // also schedule a full reload after a short delay as a fallback
        setTimeout(()=>{ location.reload(); }, 3000);
      }catch(e){
        // restore button on error
        saveBtn.textContent = originalText;
        saveBtn.className = originalClass;
        saveBtn.disabled = false;
        showToast('Could not save attendance: '+e.message, 'error', 1000);
      }
    });

    // mark all controls
    document.getElementById('markAllPresent').addEventListener('click', function(){
      document.querySelectorAll('#attendanceList input[type=checkbox]').forEach(cb=>{ cb.checked = true; setAttendanceIcon(cb); });
      updateAttendanceCounts();
    });
    document.getElementById('markAllAbsent').addEventListener('click', function(){
      document.querySelectorAll('#attendanceList input[type=checkbox]').forEach(cb=>{ cb.checked = false; setAttendanceIcon(cb); });
      updateAttendanceCounts();
    });

    // handle attendance date change
    document.getElementById('attendanceDate').addEventListener('change', async function(){
      // reload staff attendance for the selected date
      await loadStaff();
    });

    // populate year selector
    (function populateYears(){
      const sel = document.getElementById('attendanceYear');
      const now = new Date();
      const year = now.getFullYear();
      for (let y = year-1; y <= year+1; y++){
        const opt = document.createElement('option'); opt.value = y; opt.textContent = y; if (y===year) opt.selected = true; sel.appendChild(opt);
      }
    })();

    // update attendance info display (date, term, year)
    function updateAttendanceInfo(){
      const dateVal = document.getElementById('attendanceDate').value || '--';
      const termVal = document.getElementById('attendanceTerm').value || '--';
      const yearVal = document.getElementById('attendanceYear').value || '--';
      document.getElementById('attendanceInfoDate').textContent = dateVal;
      document.getElementById('attendanceInfoTerm').textContent = termVal;
      document.getElementById('attendanceInfoYear').textContent = yearVal;
    }

    // Format Date object to 12-hour time (e.g. 3:05 PM)
    function format12Hour(d){
      if (!d || !(d instanceof Date)) return '';
      let hours = d.getHours();
      const minutes = d.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // 0 -> 12
      return `${hours}:${minutes.toString().padStart(2,'0')} ${ampm}`;
    }

    // Update attendance info display with saved timestamp and optional term/year
    function updateAttendanceInfoWithSaved(savedDateObj, term, year){
      try{
        if (savedDateObj){
          const dateStr = savedDateObj.toISOString().slice(0,10);
          const timeStr = format12Hour(savedDateObj);
          document.getElementById('attendanceInfoSaved').textContent = `${dateStr} ${timeStr}`;
        } else {
          document.getElementById('attendanceInfoSaved').textContent = '--';
        }
        // prefer saved term/year when available, otherwise keep selector values
        if (term) document.getElementById('attendanceInfoTerm').textContent = term;
        if (year || year === 0) document.getElementById('attendanceInfoYear').textContent = year;
      }catch(e){ console.warn('updateAttendanceInfoWithSaved failed', e); }
    }

    // listen for changes to date, term, year selectors
    document.getElementById('attendanceDate').addEventListener('change', ()=>{ updateAttendanceInfo(); loadStaff(); });
    document.getElementById('attendanceTerm').addEventListener('change', ()=>{ updateAttendanceInfo(); });
    document.getElementById('attendanceYear').addEventListener('change', ()=>{ updateAttendanceInfo(); });

    // view attendance summary (weekly/monthly/termly)
    document.getElementById('viewAttendanceSummary').addEventListener('click', async function(){
      const today = new Date(document.getElementById('attendanceDate').value || new Date().toISOString().slice(0,10));
      // compute ranges
      const ranges = [
        { label: 'Weekly', days: 7 },
        { label: 'Monthly', days: 30 },
        { label: 'Termly (3.5 months)', days: 105 }
      ];
      const results = [];
      for (const r of ranges){
        const start = new Date(today);
        start.setDate(today.getDate() - (r.days-1));
        // fetch attendance for each day in range
        let presentCount = 0;
        let dayCount = 0;
        for (let d = new Date(start); d <= today; d.setDate(d.getDate()+1)){
          const ds = d.toISOString().slice(0,10);
          try{
            const resp = await fetch(`/headteacher/api/attendance?date=${ds}`);
            if (!resp.ok) continue;
            const arr = await resp.json();
            if (Array.isArray(arr)){
              dayCount += arr.length ? 1 : 0; // count days with records
              presentCount += arr.filter(x=> x.status === 'present').length;
            }
          }catch(e){ /* ignore */ }
        }
        results.push({ label: r.label, presentCount, dayCount });
      }
      // show brief modal with results (use Bootstrap modal instead of alert)
      const body = document.getElementById('attendanceSummaryBody');
      if (body){
        let html = '<ul class="list-unstyled mb-0">';
        results.forEach(x => { html += `<li><strong>${x.label}:</strong> present entries ${x.presentCount}, days with records ${x.dayCount}</li>`; });
        html += '</ul>';
        body.innerHTML = html;
        const modalEl = document.getElementById('attendanceSummaryModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      } else {
        // fallback to toast
        showToast(results.map(x=> `${x.label}: ${x.presentCount}/${x.dayCount}`).join(' | '), 'success', 2500);
      }
    });

    // initial load
    // Helper: ensure page can scroll to bottom of last card and detect when last card is near footer on mobile
    function setupScrollBehavior(){
      const footer = document.querySelector('footer') || document.querySelector('.footer');
      const lastCard = document.querySelector('main .card:last-of-type');
      if (!lastCard) return;

      // apply padding-bottom so last card can scroll above footer
      function updatePadding(){
        const footerHeight = footer ? footer.getBoundingClientRect().height : 0;
        // add extra spacing to ensure last card can be scrolled above footer
        document.body.style.paddingBottom = (footerHeight + 40) + 'px';
      }

      // detect when the distance from bottom of last card to top of footer is <= 20px (mobile)
      let rafPending = false;
      function checkNearFooter(){
        if (rafPending) return;
        rafPending = true;
        window.requestAnimationFrame(()=>{
          rafPending = false;
          const footerRect = footer ? footer.getBoundingClientRect() : { top: window.innerHeight };
          const lastRect = lastCard.getBoundingClientRect();
          const distance = footerRect.top - lastRect.bottom;
          const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
          if (isMobile && distance <= 20){
            document.body.classList.add('near-footer');
            if (footer) footer.classList.add('near-footer');
            // emit custom event in case other scripts want to react
            document.dispatchEvent(new CustomEvent('nearFooter', { detail: { distance }}));
          } else {
            document.body.classList.remove('near-footer');
            if (footer) footer.classList.remove('near-footer');
          }
        });
      }

      // Smooth-scroll helpers with a single coordinated flow and a re-entrancy guard
      let isAutoScrolling = false;
      let autoScrollTimer = null;

      // Scroll so the bottom of the last card is exactly `gap` pixels above the footer.
      // This performs one smooth scroll per invocation and sets a short guard so
      // programmatic scrolling doesn't re-trigger the handler.
      function scrollToLastCard(){
        try{
          if (isAutoScrolling) return;
          const footerTop = footer ? footer.getBoundingClientRect().top : window.innerHeight;
          const lastCardBottom = lastCard.getBoundingClientRect().bottom;
          const gap = 20; // exact gap in pixels
          const currentDistance = footerTop - lastCardBottom;

          if (Math.abs(currentDistance - gap) <= 2) return; // already close enough

          // compute target scrollTop to make bottom align to desired gap
          const scrollNeeded = currentDistance - gap;
          const target = Math.max(0, Math.round(window.scrollY + scrollNeeded));

          isAutoScrolling = true;
          window.scrollTo({ top: target, behavior: 'smooth' });
          if (autoScrollTimer) clearTimeout(autoScrollTimer);
          // keep guard for duration of the smooth scroll + safety margin
          autoScrollTimer = setTimeout(()=>{ isAutoScrolling = false; }, 750);
        }catch(e){ /* ignore */ }
      }

      // Ensure last card is fully visible on mobile: compute a single final target that
      // accounts for both bottom gap above footer and avoiding the navbar at the top.
      function scrollLastCardIntoViewWithGaps(){
        try{
          if (isAutoScrolling) return;
          const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
          if (!isMobile) return;

          const nav = document.querySelector('.navbar');
          const navHeight = nav ? nav.getBoundingClientRect().height : 70;
          const footerHeight = footer ? footer.getBoundingClientRect().height : 0;
          const bottomGap = 20; // gap above footer
          const topGap = navHeight + 20; // gap below navbar

          const lastRect = lastCard.getBoundingClientRect();
          const desiredBottom = window.innerHeight - footerHeight - bottomGap;
          const bottomDelta = lastRect.bottom - desiredBottom;

          // If bottom is below desired, we need to scroll down; if it's above, scroll up.
          // We'll compute the final scrollTop in document coordinates that satisfies both
          // bottom and top constraints as much as possible and perform a single smooth scroll.
          let targetY = window.scrollY + Math.ceil(bottomDelta > 0 ? bottomDelta + 6 : bottomDelta - 6);

          // After applying targetY, ensure the top of the last card will be at least topGap.
          // Compute where lastRect.top would be after the scroll and correct targetY accordingly.
          const projectedTop = lastRect.top - (targetY - window.scrollY);
          if (projectedTop < topGap){
            // need to scroll up a bit so top sits below the navbar
            targetY = Math.max(0, window.scrollY + Math.floor(projectedTop - topGap - 6));
          }

          // If the change is negligible, avoid scrolling
          if (Math.abs(targetY - window.scrollY) <= 2) return;

          isAutoScrolling = true;
          const finalTargetY = Math.max(0, Math.round(targetY));
          window.scrollTo({ top: finalTargetY, behavior: 'smooth' });
          if (autoScrollTimer) clearTimeout(autoScrollTimer);
          // After smooth scroll completes, verify final position and snap if still off by a few pixels.
          autoScrollTimer = setTimeout(()=>{
            try{
              const newRect = lastCard.getBoundingClientRect();
              const footerH = footer ? footer.getBoundingClientRect().height : 0;
              const desiredBottom2 = window.innerHeight - footerH - bottomGap;
              const remaining = newRect.bottom - desiredBottom2;
              if (Math.abs(remaining) > 3){
                // Snap instantly to exact target to ensure the card reaches the bottom gap
                const snapTarget = Math.max(0, Math.round(window.scrollY + remaining));
                window.scrollTo({ top: snapTarget, behavior: 'auto' });
              }
            }catch(e){ /* ignore */ }
            isAutoScrolling = false;
          }, 900);
        }catch(e){ isAutoScrolling = false; /* ignore */ }
      }

      // initial setup
      updatePadding();
      checkNearFooter();
      // ensure last card is fully visible on mobile after initial layout
      setTimeout(()=>{ scrollLastCardIntoViewWithGaps(); }, 400);

      // event listeners
      window.addEventListener('resize', ()=>{ updatePadding(); checkNearFooter(); });
      window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ updatePadding(); checkNearFooter(); }, 200); });
      // scroll handling: check during scroll, and on scroll end nudge last card into view if needed
      // On user scroll we only update the near-footer detection. We avoid performing
      // automatic alignment here to prevent reacting to the page's own smooth-scroll
      // animations or user-initiated scrolls which were causing oscillation.
      window.addEventListener('scroll', ()=>{ checkNearFooter(); }, { passive: true });

      // Listen for a custom event from content loaders (e.g. loadStaff) so we can
      // align after dynamic content has rendered. This prevents repeated alignment
      // during user scrolling and ensures we only auto-align after content changes.
      document.addEventListener('dashboardContentReady', ()=>{
        // small delay to allow layout to finish
        setTimeout(()=>{ scrollLastCardIntoViewWithGaps(); }, 300);
      });

      // expose for debugging/use
      window.scrollToLastCard = scrollToLastCard;
      window.scrollLastCardIntoViewWithGaps = scrollLastCardIntoViewWithGaps;
    }

    (function(){ setupScrollBehavior(); loadSummary(); loadRoleSalaries(); loadStaff(); updateAttendanceInfo(); })();
  </script>
  {% include 'footer.html' %}
</body>
</html>